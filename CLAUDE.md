# nologin.tools

A curated directory of privacy-friendly tools that work without login.

## Tech Stack

- **Framework**: Astro (Static + ISR hybrid mode)
- **Hosting**: Cloudflare Pages (static pages free, SSR via Pages Functions)
- **Database**: Cloudflare D1 (SQLite) via Drizzle ORM
- **Styling**: Tailwind CSS v4
- **Package Manager**: pnpm
- **Cron**: Separate Cloudflare Worker (`workers/cron/`)
- **Build Data**: D1 REST API → `build-data.json` → static HTML (every 6h scheduled rebuild)

## Project Structure

```
scripts/
└── fetch-build-data.mjs  # D1 REST API → build-data.json (run at build time, supports --mock)
src/
├── data/
│   ├── build-data.json   # Build-time snapshot from D1 (gitignored, generated by scripts/)
│   └── loader.ts         # Type-safe data layer: getApprovedTools(), computeScore(), etc.
├── db/schema.ts          # Drizzle tables: tools, tags, health_checks, badge_displays, edit_suggestions, data_exports
├── db/index.ts           # getDb(d1) helper (used only by SSR pages/API)
├── lib/                  # Utilities: api, archive, badge, health, tags, utils
├── layouts/Layout.astro  # Base layout with SEO meta; `bare` prop hides Header/Footer
├── components/
│   ├── ToolDetailPage.astro  # Shared tool detail renderer (used by static + SSR)
│   ├── BadgeDetailPage.astro # Shared badge detail renderer (used by static + SSR)
│   └── ...               # Header, Footer, ToolCard, HealthBadge, TagPicker
├── pages/
│   ├── index.astro       # Homepage: static HTML + client-side search/filter
│   ├── submit.astro      # Submission form (static)
│   ├── submit/success.astro  # SSR (reads URL params)
│   ├── tool/[slug].astro     # Static with getStaticPaths (known tools)
│   ├── badge/index.astro     # "What is NoLogin Verified?" (static)
│   ├── badge/[slug].astro    # Static with getStaticPaths (known tools)
│   ├── ssr/tool/[slug].astro # SSR fallback for new tools (ISR)
│   ├── ssr/badge/[slug].astro # SSR fallback for new badges (ISR)
│   ├── admin/index.astro     # Full admin dashboard (SSR, secret-protected)
│   ├── about.astro           # Static
│   ├── 404.astro             # Static
│   ├── sitemap.xml.ts        # Static (from build data)
│   └── api/              # submit, review, edit, resubmit, tools/[slug], admin/*
├── middleware.ts          # ISR rewrite logic + Cache API
workers/cron/             # Health checks, badge detection, data export
```

## Page Rendering Strategy

| Page | Mode | Data Source |
|------|------|-------------|
| `/` (homepage) | Static | `loader.ts` (build data) + client-side JS for search/filter |
| `/tool/[slug]` | Static + ISR | Known: `getStaticPaths()` / New: SSR fallback `/ssr/tool/[slug]` |
| `/badge/[slug]` | Static + ISR | Known: `getStaticPaths()` / New: SSR fallback `/ssr/badge/[slug]` |
| `/sitemap.xml` | Static | `loader.ts` (build data) |
| `/about`, `/submit`, `/badge`, `/404` | Static | No data needed |
| `/submit/success` | SSR | URL params |
| `/admin` | SSR | D1 (batch queries) |
| `/api/*` (13 endpoints) | SSR | D1 |

## Key Conventions

- **Slug**: Generated from tool URL — `urlToSlug("https://excalidraw.com")` → `"excalidraw-com"`
- **Tags**: Key:Value format — `category:Design`, `source:Open Source`, `pricing:Free`
  - 8 tag dimensions: `category` (single-select, first in TAG_DEFINITIONS, 11 values), `source`, `data`, `privacy`, `type`, `hosting`, `offline`, `pricing`
  - `category` tags use blue chip styling (`.chip-category`), displayed value-only (no `category:` prefix)
- **Homepage display modes**: Two modes based on context. The homepage is **static HTML** — grouped mode is server-rendered at build time; flat mode (search/filter) is handled by **client-side JavaScript** that reads embedded JSON data (`<script id="tools-data">`). Flash prevention: inline `<head>` script adds `.has-filters` class when URL has search params, CSS hides grouped view before JS executes.
  - **Grouped mode** (default — no search, no filters): Tools grouped by category per `TAG_DEFINITIONS` order, each section shows category name + count + max 6 cards + "View all X →" link (links to `/?category=Xxx`). No pagination. Tools without category go to "Other" group at the end.
    - **Recently Added** section appears between Spotlight Carousel and category groups. Horizontal scrollable card list showing the 8 most recently approved tools (sorted by `approvedAt` desc). Features: snap scrolling (`snap-x snap-mandatory`), left/right gradient masks indicating scroll direction, navigation arrows (sm+ only, appear on hover, auto-hide at edges), mobile touch-friendly with edge bleed (`-mx-4 px-4`). Cards are 280px (mobile) / 320px (desktop) wide using standard `ToolCard`. Section header includes clock icon (green gradient), "New" badge, and "View all →" link to `/?sort=newest`. Hidden scrollbar via `.scrollbar-hide` utility class.
  - **Flat mode** (search active or any filter active): Client-side JS filters/sorts/paginates from embedded JSON. Renders ToolCard HTML via `createToolCard()`. Paginated grid (24/page) with standard pagination controls.
- **Homepage filter UX**: Category chips shown as top row; non-category filters collapsed under "More filters" toggle (auto-expands when non-category filters active), displayed by dimension with labels. Active filters shown as removable chips with X icon and "Clear all" link.
- **ToolCard favicon**: Uses Google Favicon Service (`https://www.google.com/s2/favicons?domain={hostname}&sz=32`) with `loading="lazy"`. Falls back to initial letter on error via inline `onerror`. Requires `url` prop.
- **Featured tools**: Admin can mark approved tools as "featured" for higher visibility:
  - `POST /api/admin/tool-feature` — toggle `isFeatured` + `featuredAt` (only approved tools)
  - Homepage grouped mode: **Spotlight Carousel** appears **above** category groups. Single large card at a time, auto-rotates every 5s with fade+slide animation. Navigation: prev/next arrow buttons + dot indicators (hidden when only 1 featured). Hover pauses autoplay, keyboard ←/→ supported. Cards use custom layout (not ToolCard): 28px favicon, `text-xl` title, up to 5 tags, "Visit Tool →" CTA (sm+). SSR renders all slides (first active, rest `opacity-0`). JS carousel logic in IIFE at page bottom. Featured tools **still appear** in their category groups.
  - Homepage flat mode: Featured tools get +8 recommendation score boost (`CASE WHEN is_featured = 1 THEN 8 ELSE 0 END`)
  - ToolCard: `isFeatured` prop → gold border (`border-yellow-300`), pale yellow bg (`bg-yellow-50/30`), ★ star icon
  - Tool detail page: ★ Featured label next to NoLogin Verified
  - Data export: `featured` boolean field in tools.json, ★ marker after tool name in README
  - Rejecting a tool auto-clears `isFeatured` and `featuredAt`
  - Admin dashboard: Featured count stat card (yellow theme), ★ Featured filter button, Feature/Unfeature toggle per approved tool
- **Status flow**: `pending` → `approved` (= NoLogin Verified) or `rejected`
  - Rejected tools can be resubmitted via `POST /api/resubmit` — resets to `pending`, clears `rejectionReason`
- **Badge navigation**: Tool detail "NoLogin Verified" label links to `/badge/{slug}`; verified tools show a CTA to get embed code
- **Badge styles**: 13 badge variants defined in `src/lib/badge.ts` (`BADGE_STYLES` + `ORIGINAL_BADGE`), organized in `BADGE_GROUPS`:
  - **Standard** (4): `flat` (default, 118×20), `flat-square` (118×20), `plastic` (116×18), `for-the-badge` (191×28) — left `#555` + right `#4c1`
  - **Social** (1): `social` (142×20) — pill shape, light left `#fafafa` + green right, border stroke
  - **Dark** (4): `flat-dark` (118×20), `flat-square-dark` (118×20), `plastic-dark` (116×18), `for-the-badge-dark` (191×28) — left `#2d2d2d` + right `#3fb950`
  - **Color** (3): `flat-blue` (118×20, `#07c`), `flat-purple` (118×20, `#8957e5`), `flat-orange` (118×20, `#fe7d37`) — left `#555` + colored right
  - **Original** (1): `/badge.svg` (160×28, white bg, legacy) — not in `BADGE_GROUPS`, shown as secondary option
  - `/badge.svg` is kept for backward compatibility; new embeds default to `flat`
  - **Shield icon**: All 12 badge variants (not original) include a shield+checkmark icon on the left side before "nologin" text, for brand recognition and verification authority:
    - 12×12 base size shield path with checkmark stroke, scaled per badge height (0.833× for plastic, 1× for flat/social, 1.333× for for-the-badge)
    - Dark backgrounds: white shield (`fill="#fff" fill-opacity="0.9"`) + background-colored checkmark stroke
    - Social (light `#fafafa` bg): green shield (`fill="#22c55e"`) + white checkmark stroke
  - All SVG badges have `<title>Verified by nologin.tools</title>` and `aria-label="Verified by nologin.tools"` for hover tooltip and accessibility
  - Embed code `<img>` tags include `title="Verified by nologin.tools"` for native browser hover tooltip
- **API responses**: `{ ok: true, data: ... }` or `{ ok: false, error: "...", details: {...} }`
- **Badge page tabs**: `/badge/[slug]` uses `bare` layout (no Header/Footer) for a standalone certificate feel. Two tabs — "Verification" (default) and "Embed Code" (`#embed` hash). Tab switching is client-side vanilla JS with `hidden` class toggle.
  - **Verification tab** uses a certificate-style layout: small `flat.svg` brand link at top → 72×72 shield SVG hero (green checkmark for approved, amber clock for pending) + "by nologin.tools" attribution → `<dl>`-based Certificate Details card with colored border (green/amber) → 2×2 Trust Signals grid (Manually Reviewed, No Login Required, Continuously Monitored, Web Archived) → action buttons → attribution line
  - **Embed Code tab** includes a grouped style selector (Standard/Social/Dark/Color) for badge variants. Dark cards use `bg-neutral-800` preview background.
- **Admin auth**: Query param `?secret=ADMIN_SECRET`
- **Admin dashboard**: Tab-based SPA at `/admin?secret=...` with URL hash navigation (`#dashboard` / `#tools` / `#edits` / `#health` / `#export`):
  - **Dashboard**: Stats overview (total/approved/pending/unstable/offline/featured) + recent submissions table
  - **Tools**: Full CRUD — status filter chips, search, pagination via `POST /api/admin/tools`; inline edit/reject forms; approve/reject/edit/delete/health-check actions
  - **Edits**: Pending edit suggestions review (approve & apply / reject)
  - **Health**: Health monitoring table for approved tools with manual "Run Check" button. "Run All Checks" bulk button runs all tools with 3 concurrent requests, shows real-time progress, supports cancel via `AbortController`, and displays summary toast on completion. "Check Abnormal" button (amber-styled) runs checks only for tools with unstable/offline/unknown status, showing live abnormal count; both bulk buttons share `abortController`/`isBulkRunning` state and disable each other + individual buttons during runs. Health table rows carry `data-status` attribute (`online`/`unstable`/`offline`/`unknown`) updated after each check for client-side filtering.
  - **Export**: Manual "Export Now" button + export history table (time, source cron/manual, tool count, files updated, status)
  - Toast notifications (success/error, 3s auto-dismiss), loading states on buttons, `confirm()` for destructive actions
- **Admin API endpoints** (all POST, require `secret`):
  - `POST /api/admin/tools` — list tools with status filter, search, pagination (20/page)
  - `POST /api/admin/tool-update` — edit tool fields and tags
  - `POST /api/admin/tool-delete` — delete tool (cascade cleans associations)
  - `POST /api/admin/health-check` — manually trigger health check for a tool; returns `isOnline` (raw single-check result) and `effectiveStatus` (`'online'|'unstable'|'offline'`)
  - `POST /api/admin/data-export` — manually trigger data export to GitHub (pushes tools.json + README.md with change detection), records to `data_exports` table
  - `POST /api/admin/export-history` — query recent export history (last 20 entries)
- **Health check on submit**: Tools are health-checked on submission/resubmission via `ctx.waitUntil()`. Results stored in `health_checks` table, displayed on admin review page.
- **`ctx.waitUntil()` for background work**: In Cloudflare Workers, the execution context terminates after the Response is returned. Any fire-and-forget async work (health checks, archiving, etc.) **must** be registered with `locals.runtime.ctx.waitUntil(promise)` — otherwise the Promise will be killed before completion. The cron worker uses `ctx.waitUntil()` directly from its `ExecutionContext`.
- **Health check User-Agent**: All health check fetch requests (both `src/lib/health.ts` and `workers/cron/`) include `User-Agent: 'NoLoginTools-HealthChecker/1.0'` to avoid WAF/bot-detection false positives (e.g. WolframAlpha 403). Badge detection uses `NoLoginTools-BadgeChecker/1.0`.
- **Health check HEAD→GET fallback**: HEAD is tried first; if it **throws** (network error) OR returns **non-ok status** (e.g. WolframAlpha returns 404 for HEAD), a GET retry follows. This prevents sites that reject HEAD but accept GET from being marked offline.
- **Health check HTTP status intelligence**: `isOnline` is determined by `isReachable(status)` — any HTTP response is considered "reachable" (server is up) except 404/410 which indicate the page is gone. This means 403 (WAF), 429 (rate limit), and 5xx (server error) all count as "online" since the server is responding. Network errors (DNS failure, timeout, connection refused) count as offline.
- **Health check three-level effective status**: `resolveEffectiveStatus(checks)` returns `EffectiveStatus | null` (`'online'|'unstable'|'offline'|null`). Uses fast-recovery rule: if latest check is within 48h and online → immediately `'online'`; if latest is offline → use all LIMIT 5 records (no second 48h filter) to distinguish `'offline'` (all offline) vs `'unstable'` (mixed); if latest check is older than 48h → `null`.
- **Health check tolerance**: Status uses the last 5 checks (`HEALTH_TOLERANCE = 5`) with a 48-hour freshness check on the most recent record only (`HEALTH_WINDOW_HOURS = 48`). If the latest check is older than 48h, status returns `null` ("No checks yet"). The fast-recovery design prevents false "unstable" states — tolerance is for preventing false offline (one timeout shouldn't mark offline), not for blocking recovery. The helper `resolveEffectiveStatus(checks)` in `src/lib/health.ts` is used by all display layers. The health-check API returns `isOnline` (raw) and `effectiveStatus` (three-level); client-side JS uses `effectiveStatus` for UI updates. The cron worker inlines the same `isReachable()` logic for `isOnline` determination and uses `HEALTH_TOLERANCE`/`HEALTH_WINDOW_HOURS` for archive triggering (queries D1 directly since it can't import `src/lib/`).
- **Exported README badges**: The auto-generated `awesome-nologin-tools` README includes 5 shields.io badges on the first line + 1 self-hosted badge on a separate line below the title. First line: Awesome (static, pink `#fc60a8`), Tools count (dynamic from `tools.length`, green `#4c1`), License CC0 (static, grey), Website (static, blue), Submit a Tool (static, orange). Second line: NoLogin Verified (`/badges/flat.svg`, self-hosted, links to `/badge/awesome-nologin-tools`). Both `generateReadme()` in `src/pages/api/admin/data-export.ts` and `workers/cron/src/index.ts` must stay in sync.
- **Health check self-reference detection**: Cloudflare Workers cannot `fetch()` their own hostname (causes 522). `checkHealth(url, siteUrl?)` compares hostnames — if they match, it short-circuits with `{ isOnline: true, httpStatus: 200, responseTimeMs: 0 }`. All call sites pass `SITE_URL`. The cron worker has equivalent inline logic.
- **Cron export logging**: `runDataExport` in the cron worker always records to `data_exports` table — `GITHUB_TOKEN` missing writes `status: 'error'` with `error_message: 'GITHUB_TOKEN not configured'`; any runtime exception also records error with message. DB writes themselves are wrapped in try-catch to prevent double failures.
- **Performance — Database indexes**: Three indexes exist for query performance: `idx_tools_status` on `tools(status)`, `idx_tags_tool_id` on `tags(tool_id)`, `idx_health_checks_tool_id_checked_at` on `health_checks(tool_id, checked_at)`.
- **Performance — JS-layer recommendation score**: The homepage recommendation score is computed in JavaScript (not SQL) using `computeScore()` in `src/data/loader.ts`. Badge weight comes from badge display type, health score from effective status, freshness from `approvedAt`, featured boost +8.
- **Performance — Batch queries**: Admin tools API (`/api/admin/tools`) and admin dashboard (`/admin`) use batch `inArray` queries for tags and health checks instead of per-tool N+1 queries.
- **Performance — ISR middleware**: `src/middleware.ts` implements Incremental Static Regeneration for `/tool/*` and `/badge/*`. For pages not found as static files: checks Cache API first → rewrites to `/ssr/tool/*` or `/ssr/badge/*` for D1 SSR → caches successful responses with 6h TTL via Cache API + `ctx.waitUntil()`.
- **Performance — Static-first architecture**: Homepage, known tool/badge pages, and sitemap are pre-rendered at build time (0 CPU). Data sourced from `src/data/build-data.json` generated by `scripts/fetch-build-data.mjs` via D1 REST API. Scheduled rebuilds every 6h keep data fresh.

## Commands

```bash
node scripts/fetch-build-data.mjs          # Fetch build data from D1 REST API
node scripts/fetch-build-data.mjs --mock   # Generate empty mock data (for CI/local dev)
pnpm dev                  # Start dev server (requires build-data.json)
pnpm build                # Build for production
pnpm preview              # Preview with wrangler pages dev
pnpm db:generate          # Generate Drizzle migration
pnpm db:migrate:local     # Apply migrations locally
pnpm db:migrate:remote    # Apply migrations to production D1
pnpm deploy               # Build + deploy to Cloudflare Pages
pnpm deploy:cron          # Deploy cron worker
```

**Local development**: Run `node scripts/fetch-build-data.mjs` first to generate `src/data/build-data.json` (or `--mock` for empty data). When using `wrangler pages dev`, you may need to temporarily unset HTTP proxy: `unset HTTP_PROXY HTTPS_PROXY`.

## Environment Variables

| Variable | Purpose | Setup |
|----------|---------|-------|
| `SITE_URL` | Site URL | wrangler.jsonc vars |
| `ADMIN_SECRET` | Admin dashboard access | `wrangler secret put` |
| `GITHUB_TOKEN` | Data export to GitHub | `wrangler secret put` |
| `ARCHIVE_ORG_ACCESS_KEY` | web.archive.org auth | `wrangler secret put` |
| `ARCHIVE_ORG_SECRET_KEY` | web.archive.org auth | `wrangler secret put` |
| `RATE_LIMIT_MAX_SUBMISSIONS` | Max submissions per IP per window (default: 3) | wrangler.jsonc vars |
| `RATE_LIMIT_WINDOW_HOURS` | Rate limit window in hours (default: 24) | wrangler.jsonc vars |

**Important**: The main app (`nologin-tools`) and cron worker (`nologin-tools-cron`) are **separate Cloudflare Workers**. Secrets are isolated per worker, so secrets needed by the cron worker (`GITHUB_TOKEN`, `ARCHIVE_ORG_ACCESS_KEY`, `ARCHIVE_ORG_SECRET_KEY`) must be set separately under `workers/cron/`:

```bash
cd workers/cron
wrangler secret put GITHUB_TOKEN
wrangler secret put ARCHIVE_ORG_ACCESS_KEY
wrangler secret put ARCHIVE_ORG_SECRET_KEY
```

## Database Schema

6 tables: `tools` (main), `tags` (key:value), `health_checks` (periodic), `badge_displays` (detection results), `edit_suggestions` (wiki mode), `data_exports` (export history).

- `tools.submitter_email`: Optional contact email from the submitter. Only displayed on the admin review page (not public). Validated as a proper email format (max 254 chars) when provided.

## Recommendation Score

```
score = badge_weight (0/5/10) + freshness (1/3/5) + health (0/1/3) + featured (0/8)
```

## Design System

- Colors: white bg, neutral-950 text, green-500 verified/online, amber-500 pending/unstable, red-500 offline
- Font: system font stack
- Max width: 6xl (1152px), card grid 1/2/3 columns responsive
- **Chip variants**: `.chip` (base), `.chip-default` / `.chip-active` (states), `.chip-category` (blue), `.chip-toggle` (interactive form variant with check icon, used in TagPicker)
- **TagPicker**: Uses checkboxes for all dimensions; single-select enforced via JS (allows deselect). Wrapper has `.tag-picker-container` for multi-instance isolation. Labels carry `data-tag-group` and `data-multi-select` attributes.
- **Admin styles**: `.admin-tab` / `.admin-tab-active` / `.admin-tab-inactive` (tab navigation), `.status-badge` + `.status-approved` / `.status-pending` / `.status-rejected` (pill badges), `.admin-table` (data tables)
- **Spotlight Carousel**: `.spotlight-track` (overflow container), `.spotlight-slide` (absolute positioned base), `.spotlight-slide-active` (visible, relative to set height), `.spotlight-slide-exit` / `.spotlight-slide-enter-right` / `.spotlight-slide-enter-left` (transition states), `.spotlight-dot` / `.spotlight-dot-active` (indicator dots)

## CI/CD

- **Workflow**: `.github/workflows/deploy.yml`
- **Triggers**: push to `main` → deploy | PR to `main` → build check only | manual `workflow_dispatch` → deploy | **scheduled cron every 6h** (`0 */6 * * *`) → rebuild with fresh D1 data
- **Jobs** (main branch / schedule / dispatch): `migrate` → `deploy-app` (fetch build data + build + `wrangler pages deploy`) + `deploy-cron` (parallel after migration)
- **Jobs** (PR): `build-check` only (mock build data + pnpm build)
- **D1 database_id**: Real ID stored directly in `wrangler.jsonc` and `workers/cron/wrangler.jsonc` (not sensitive — access requires API token)
- **GitHub Secrets required**: `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_ACCOUNT_ID`
- **Concurrency**: Same workflow + branch combo cancels in-progress runs
- **Observability**: Both the main app (`wrangler.jsonc`) and cron worker (`workers/cron/wrangler.jsonc`) have `"observability": { "enabled": true }` for Cloudflare Dashboard logs
- **Data freshness**: Static pages updated every 6h via scheduled rebuild. New tools between rebuilds served via ISR (SSR fallback + 6h Cache API TTL). Admin can trigger immediate rebuild via `workflow_dispatch`.
