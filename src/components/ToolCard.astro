---
import HealthBadge from './HealthBadge.astro';
import { sortTagsCategoryFirst } from '../lib/tags';

interface Tag {
  tagKey: string;
  tagValue: string;
}

interface Props {
  slug: string;
  name: string;
  url: string;
  description: string | null;
  isVerified: boolean;
  isOnline: boolean | null;
  lastCheckedAt: Date | null;
  tags: Tag[];
  archiveUrl: string | null;
}

const { slug, name, url, description, isVerified, isOnline, lastCheckedAt, tags, archiveUrl } =
  Astro.props;
const isOffline = isOnline === false;
const sortedTags = sortTagsCategoryFirst(tags);

let faviconHostname = '';
try {
  faviconHostname = new URL(url).hostname;
} catch {}
const faviconUrl = faviconHostname ? `https://www.google.com/s2/favicons?domain=${faviconHostname}&sz=32` : '';
const initial = name.charAt(0).toUpperCase();
---

<a
  href={`/tool/${slug}`}
  class:list={[
    'block border border-neutral-200 rounded-lg p-5 hover:shadow-md transition-all',
    isOffline && 'opacity-60',
  ]}
>
  <div class="flex items-start justify-between gap-3 mb-3">
    <div class="flex items-center gap-2 min-w-0">
      {faviconUrl ? (
        <img
          src={faviconUrl}
          alt=""
          width="20"
          height="20"
          loading="lazy"
          class="w-5 h-5 rounded shrink-0"
          onerror={`this.style.display='none';this.nextElementSibling.style.display='flex'`}
        />
        <span class="w-5 h-5 rounded bg-neutral-100 text-neutral-500 text-xs font-medium items-center justify-center shrink-0" style="display:none">{initial}</span>
      ) : (
        <span class="w-5 h-5 rounded bg-neutral-100 text-neutral-500 text-xs font-medium flex items-center justify-center shrink-0">{initial}</span>
      )}
      <h3 class="font-semibold text-neutral-950 truncate">{name}</h3>
    </div>
    <HealthBadge isOnline={isOnline} lastCheckedAt={lastCheckedAt} />
  </div>

  {description && (
    <p class="text-sm text-neutral-500 mb-3 line-clamp-2">{description}</p>
  )}

  <div class="flex flex-wrap gap-1.5 mb-3">
    {sortedTags.slice(0, 4).map((tag) => (
      <span class:list={['chip text-[11px]', tag.tagKey === 'category' ? 'chip-category' : 'chip-default']}>
        {tag.tagKey === 'category' ? tag.tagValue : `${tag.tagKey}:${tag.tagValue}`}
      </span>
    ))}
  </div>

  <div class="flex items-center justify-between">
    {isVerified && (
      <span class="inline-flex items-center gap-1.5 text-xs text-green-600 font-medium">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <circle cx="6" cy="6" r="6" fill="#22c55e" />
          <path
            d="M3.5 6L5.5 8L8.5 4"
            stroke="white"
            stroke-width="1.5"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        NoLogin Verified
      </span>
    )}
    {isOffline && archiveUrl && (
      <span class="text-xs text-neutral-400">Archived copy available</span>
    )}
  </div>
</a>
