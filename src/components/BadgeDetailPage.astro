---
import Layout from '../layouts/Layout.astro';
import HealthBadge from './HealthBadge.astro';
import { formatDate } from '../lib/utils';
import { getBadgeEmbedCode, BADGE_STYLES, BADGE_GROUPS, ORIGINAL_BADGE } from '../lib/badge';
import { sortTagsCategoryFirst } from '../lib/tags';

interface Props {
  tool: {
    id: number;
    slug: string;
    name: string;
    url: string;
    coreTask: string;
    status: string;
    approvedAt: Date | string | null;
  };
  toolTags: { tagKey: string; tagValue: string }[];
  latestHealth: { isOnline: boolean; checkedAt: Date } | null;
  slug: string;
  siteUrl: string;
}

const { tool, toolTags, latestHealth, slug, siteUrl } = Astro.props;

const isPending = tool.status === 'pending';

const embedCode = getBadgeEmbedCode(slug, siteUrl, 'flat');
const allEmbedCodes = Object.fromEntries(
  [...BADGE_STYLES, ORIGINAL_BADGE].map((s) => [s.id, getBadgeEmbedCode(slug, siteUrl, s.id)])
);
---

<Layout
  bare
  title={`${tool.name} — ${isPending ? 'Pending Verification' : 'NoLogin Verified'}`}
  description={isPending ? `${tool.name} is pending verification.` : `${tool.name} is NoLogin Verified. ${tool.coreTask}`}
>
  {/* Background Elements */}
  <div class="absolute top-0 inset-x-0 h-[32rem] pointer-events-none -z-10 overflow-hidden">
    <div class="absolute -top-24 -left-24 w-96 h-96 bg-green-100/20 blur-3xl rounded-full"></div>
    <div class="absolute top-48 -right-48 w-80 h-80 bg-blue-100/10 blur-3xl rounded-full"></div>
  </div>

  <div class="max-w-4xl mx-auto px-6 py-12 sm:py-16">
    <!-- Badge brand link -->
    <div class="mb-12 flex justify-center">
      <a href="/" class="flex items-center gap-2 group">
        <div class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center text-white font-black text-xl shadow-lg shadow-green-100 group-hover:scale-110 transition-transform">
          n
        </div>
        <span class="font-black text-xl tracking-tight text-neutral-900">
          nologin<span class="text-green-600">.</span>tools
        </span>
      </a>
    </div>

    <!-- Tab navigation -->
    <div class="flex items-center justify-center mb-12">
      <div class="inline-flex p-1 bg-neutral-100/50 rounded-2xl border border-neutral-200/50" role="tablist">
        <button role="tab" aria-selected="true" aria-controls="panel-verification"
          id="tab-verification"
          class="tab-btn px-8 py-2.5 text-sm font-black rounded-xl transition-all duration-300 border-none outline-none ring-0 cursor-pointer
                 aria-selected:bg-white aria-selected:text-neutral-900 aria-selected:shadow-sm aria-selected:ring-1 aria-selected:ring-neutral-200
                 text-neutral-400 hover:text-neutral-600">
          Verification Certificate
        </button>
        <button role="tab" aria-selected="false" aria-controls="panel-embed"
          id="tab-embed"
          class="tab-btn px-8 py-2.5 text-sm font-black rounded-xl transition-all duration-300 border-none outline-none ring-0 cursor-pointer
                 aria-selected:bg-white aria-selected:text-neutral-900 aria-selected:shadow-sm aria-selected:ring-1 aria-selected:ring-neutral-200
                 text-neutral-400 hover:text-neutral-600">
          Embed Code
        </button>
      </div>
    </div>

    <!-- Panel: Verification (default visible) -->
    <div id="panel-verification" role="tabpanel" aria-labelledby="tab-verification" class="space-y-12">

      <!-- Certificate Hero -->
      <div class="text-center">
        <div class="relative inline-block mb-8">
          {isPending ? (
             <div class="absolute inset-0 bg-amber-500/20 blur-2xl rounded-full scale-110 animate-pulse"></div>
          ) : (
             <div class="absolute inset-0 bg-green-500/20 blur-2xl rounded-full scale-110"></div>
          )}
          <div class:list={[
            "relative w-24 h-24 rounded-[2.5rem] flex items-center justify-center border-2",
            isPending ? "bg-amber-50 border-amber-200 text-amber-600" : "bg-green-50 border-green-200 text-green-600"
          ]}>
            {isPending ? (
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            ) : (
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            )}
          </div>
        </div>
        <h1 class:list={['text-4xl font-black tracking-tight', isPending ? 'text-amber-600' : 'text-green-600']}>
          {isPending ? 'Verification Pending' : 'NoLogin Verified'}
        </h1>
        <p class="text-lg text-neutral-400 mt-2 font-medium">Digital trust certificate for <span class="text-neutral-900 font-bold">{tool.name}</span></p>
      </div>

      <!-- Certificate Details Card -->
      <div class:list={[
        'glass-card rounded-[3rem] p-8 sm:p-12 relative overflow-hidden',
        isPending ? 'border-amber-200/50 bg-amber-50/20' : 'border-green-200/50 bg-green-50/20',
      ]}>
        <div class="absolute top-0 right-0 w-48 h-48 bg-white/50 rounded-bl-[10rem] pointer-events-none"></div>
        <h2 class="text-xs font-black uppercase tracking-[0.2em] text-neutral-400 mb-10">Verification Details</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
          <div class="space-y-1">
            <dt class="text-[10px] font-black uppercase tracking-widest text-neutral-400">Tool Name</dt>
            <dd class="text-xl font-black text-neutral-950">{tool.name}</dd>
          </div>
          <div class="space-y-1">
            <dt class="text-[10px] font-black uppercase tracking-widest text-neutral-400">Status</dt>
            <dd>
              <span class:list={['status-badge px-4 py-1.5 rounded-xl font-black uppercase tracking-tight text-[10px]', isPending ? 'status-pending' : 'status-approved']}>
                {isPending ? 'Review in progress' : 'Verified & Approved'}
              </span>
            </dd>
          </div>
          <div class="space-y-1 md:col-span-2">
            <dt class="text-[10px] font-black uppercase tracking-widest text-neutral-400">Tool URL</dt>
            <dd>
              <a href={tool.url} target="_blank" rel="noopener noreferrer" class="text-lg font-bold text-blue-600 hover:text-blue-700 break-all underline decoration-blue-200 underline-offset-4">{tool.url}</a>
            </dd>
          </div>
          <div class="space-y-1 md:col-span-2">
            <dt class="text-[10px] font-black uppercase tracking-widest text-neutral-400">Certified Core Task</dt>
            <dd class="text-lg font-bold text-neutral-700 leading-relaxed italic">"{tool.coreTask}"</dd>
          </div>

          {!isPending && tool.approvedAt && (
            <div class="space-y-1">
              <dt class="text-[10px] font-black uppercase tracking-widest text-neutral-400">Verified Since</dt>
              <dd class="text-lg font-bold text-neutral-700">{formatDate(tool.approvedAt)}</dd>
            </div>
          )}
          {!isPending && (
            <div class="space-y-1">
              <dt class="text-[10px] font-black uppercase tracking-widest text-neutral-400">Current Health</dt>
              <dd>
                <HealthBadge
                  isOnline={latestHealth?.isOnline ?? null}
                  lastCheckedAt={latestHealth?.checkedAt ?? null}
                />
              </dd>
            </div>
          )}
        </div>

        {toolTags.length > 0 && (
          <div class="mt-12 pt-8 border-t border-neutral-200/50">
            <dt class="text-[10px] font-black uppercase tracking-widest text-neutral-400 mb-4">Classifications</dt>
            <div class="flex flex-wrap gap-2">
              {sortTagsCategoryFirst(toolTags).map((tag) => (
                <span class:list={['chip px-4 py-1.5 font-bold uppercase tracking-wider text-[10px]', tag.tagKey === 'category' ? 'chip-category' : 'chip-default']}>
                  {tag.tagKey === 'category' ? tag.tagValue : tag.tagValue}
                </span>
              ))}
            </div>
          </div>
        )}
      </div>

      <!-- Quick Intro for External Visitors -->
      <div class="glass-card rounded-[2.5rem] p-8 bg-gradient-to-br from-green-600 to-emerald-500 text-white border-none shadow-xl shadow-green-100/50">
        <div class="flex flex-col md:flex-row items-center gap-8">
          <div class="w-16 h-16 shrink-0 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
          </div>
          <div>
            <h2 class="text-xl font-black mb-2">What is NoLogin Verified?</h2>
            <p class="text-green-50 font-medium leading-relaxed">
              This certificate confirms that <span class="font-black underline decoration-white/30 underline-offset-4">{tool.name}</span> has been manually audited. It guarantees that users can access its core features **immediately**—without ever needing to sign up or log in.
            </p>
          </div>
        </div>
      </div>

      <!-- Trust Signals Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-8">
        {[
          { title: "Manual Review", desc: "Individually tested by humans to ensure a login-free experience.", icon: "M" },
          { title: "Privacy First", desc: "Core tasks are accessible without harvesting personal data.", icon: "P" },
          { title: "24/7 Monitoring", desc: "Automated checks ensure the tool stays active and accessible.", icon: "H" },
          { title: "Archive Proof", desc: "Public snapshots preserved on the Internet Archive for audit.", icon: "A" }
        ].map(item => (
          <div class="glass-card rounded-3xl p-6 flex gap-4">
            <div class="w-10 h-10 rounded-xl bg-green-50 flex items-center justify-center text-green-600 font-black shrink-0 border border-green-100">
               {item.icon}
            </div>
            <div>
              <h3 class="text-sm font-black text-neutral-900">{item.title}</h3>
              <p class="text-xs text-neutral-500 mt-1 leading-relaxed font-medium">{item.desc}</p>
            </div>
          </div>
        ))}
      </div>

      <!-- Actions -->
      <div class="flex flex-col sm:flex-row justify-center gap-4">
        <a href={tool.url} target="_blank" rel="noopener noreferrer" class="btn-primary px-10 py-4 rounded-2xl font-black">Visit Verified Tool</a>
        <a href={`/tool/${slug}`} class="btn-secondary px-10 py-4 rounded-2xl font-black">Directory Listing</a>
      </div>
    </div> <!-- end panel-verification -->

    <!-- Panel: Embed Code (hidden by default) -->
    <div id="panel-embed" role="tabpanel" aria-labelledby="tab-embed" class="hidden space-y-12">

      <section class="glass-card rounded-[3rem] p-8 sm:p-12 text-center">
        <h2 class="text-3xl font-black text-neutral-900 mb-4">Add to Your Site</h2>
        <p class="text-neutral-500 max-w-xl mx-auto font-medium mb-10">
          Display the NoLogin Verified badge to signal your commitment to a frictionless user experience.
          Tools with active badges receive a ranking boost.
        </p>

        {isPending && (
          <div class="bg-amber-50 border border-amber-200/50 rounded-2xl p-6 mb-10 max-w-2xl mx-auto">
            <p class="text-sm text-amber-800 font-bold">
              Verification in progress. You can embed the code now; it will automatically update to "Verified" once approved.
            </p>
          </div>
        )}

        <!-- Badge Style Selector -->
        <div class="mb-12 text-left">
          <h3 class="text-xs font-black uppercase tracking-[0.2em] text-neutral-400 mb-8 text-center">Customize Style</h3>
          <div class="space-y-10">
            {BADGE_GROUPS.map((group) => {
              const groupStyles = BADGE_STYLES.filter((s) => s.group === group.id);
              const isDark = group.id === 'dark';
              return groupStyles.length > 0 && (
                <div>
                  <p class="text-[10px] font-black text-neutral-300 mb-4 uppercase tracking-[0.2em] text-center">{group.label} Collection</p>
                  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    {groupStyles.map((style) => (
                      <button
                        class:list={[
                          'badge-style-btn flex flex-col items-center justify-center gap-4 p-5 rounded-2xl border transition-all duration-300 cursor-pointer shadow-sm active:scale-95',
                          isDark ? 'bg-neutral-900 border-neutral-800' : 'bg-white border-neutral-100',
                          style.id === 'flat'
                            ? 'ring-2 ring-green-500 border-transparent shadow-lg shadow-green-100'
                            : 'hover:border-neutral-300 hover:shadow-md',
                        ]}
                        data-style={style.id}
                        data-badge-path={style.path}
                        data-dark={isDark ? 'true' : undefined}
                      >
                        <img src={style.path} alt={style.label} class="h-6" />
                        <span class:list={['text-[10px] font-black uppercase tracking-widest', isDark ? 'text-neutral-500' : 'text-neutral-400']}>{style.label}</span>
                      </button>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        <!-- Code Displays -->
        <div class="grid grid-cols-1 gap-8 text-left max-w-3xl mx-auto">
          <!-- SVG Badge -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-xs font-black uppercase tracking-widest text-neutral-400">SVG Badge (Recommended)</h3>
              <button class="copy-btn text-xs font-black text-green-600 hover:text-green-700 px-3 py-1 rounded-lg bg-green-50 transition-colors" data-code="svg">Copy Code</button>
            </div>
            <div class="p-6 bg-white border border-neutral-100 rounded-3xl shadow-inner flex justify-center mb-4">
              <img id="badge-preview" src="/badges/flat.svg" alt="NoLogin Verified" class="h-10" />
            </div>
            <pre id="code-svg" class="bg-neutral-900 text-neutral-400 p-6 rounded-3xl text-[11px] font-mono overflow-x-auto border-4 border-neutral-800"><code>{embedCode.svg}</code></pre>
          </div>

          <!-- Meta tag -->
          <div class="space-y-3">
             <div class="flex items-center justify-between">
              <h3 class="text-xs font-black uppercase tracking-widest text-neutral-400">Meta Tag</h3>
              <button class="copy-btn text-xs font-black text-green-600 hover:text-green-700 px-3 py-1 rounded-lg bg-green-50 transition-colors" data-code="meta">Copy Code</button>
            </div>
            <pre id="code-meta" class="bg-neutral-900 text-neutral-400 p-6 rounded-3xl text-[11px] font-mono overflow-x-auto border-4 border-neutral-800"><code>{embedCode.meta}</code></pre>
          </div>
        </div>
      </section>

    </div> <!-- end panel-embed -->

    <script id="embed-codes-data" type="application/json" set:html={JSON.stringify(allEmbedCodes)} />
  </div>

  <script>
    // Tab switching
    const tabs = {
      verification: {
        btn: document.getElementById('tab-verification')!,
        panel: document.getElementById('panel-verification')!,
      },
      embed: {
        btn: document.getElementById('tab-embed')!,
        panel: document.getElementById('panel-embed')!,
      },
    };

    function activateTab(name: 'verification' | 'embed') {
      for (const [key, { btn, panel }] of Object.entries(tabs)) {
        const isActive = key === name;
        panel.classList.toggle('hidden', !isActive);
        btn.setAttribute('aria-selected', String(isActive));
        btn.classList.toggle('border-green-500', isActive);
        btn.classList.toggle('text-green-600', isActive);
        btn.classList.toggle('border-transparent', !isActive);
        btn.classList.toggle('text-neutral-500', !isActive);
      }
    }

    // Initialize from hash
    if (window.location.hash === '#embed') {
      activateTab('embed');
    }

    // Tab click handlers
    tabs.verification.btn.addEventListener('click', () => {
      activateTab('verification');
      history.replaceState(null, '', window.location.pathname);
    });

    tabs.embed.btn.addEventListener('click', () => {
      activateTab('embed');
      history.replaceState(null, '', '#embed');
    });

    // Handle browser back/forward
    window.addEventListener('hashchange', () => {
      activateTab(window.location.hash === '#embed' ? 'embed' : 'verification');
    });

    // Badge style switching
    const embedCodes: Record<string, { svg: string }> = JSON.parse(
      document.getElementById('embed-codes-data')!.textContent!
    );
    const styleBtns = document.querySelectorAll('.badge-style-btn');
    const badgePreview = document.getElementById('badge-preview') as HTMLImageElement;
    const codeSvg = document.getElementById('code-svg');

    styleBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        const style = (btn as HTMLElement).dataset.style!;
        const badgePath = (btn as HTMLElement).dataset.badgePath!;

        // Update preview image
        badgePreview.src = badgePath;

        // Update SVG embed code
        if (codeSvg && embedCodes[style]) {
          codeSvg.innerHTML = `<code>${embedCodes[style].svg.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code>`;
        }

        // Update button styles
        styleBtns.forEach((b) => {
          const el = b as HTMLElement;
          const isDark = el.dataset.dark === 'true';
          if (el.dataset.style === style) {
            el.classList.add('ring-2', 'ring-green-500', 'border-transparent', 'shadow-lg', 'shadow-green-100');
            el.classList.remove('border-neutral-200', 'border-neutral-100', 'border-neutral-800', 'hover:border-neutral-300', 'hover:shadow-md');
            if (!isDark) el.classList.add('bg-green-50');
          } else {
            el.classList.remove('ring-2', 'ring-green-500', 'border-transparent', 'shadow-lg', 'shadow-green-100', 'bg-green-50');
            el.classList.add('hover:border-neutral-300', 'hover:shadow-md');
            if (isDark) {
              el.classList.add('border-neutral-800');
            } else {
              el.classList.add('border-neutral-100');
            }
          }
        });
      });
    });

    // Copy to clipboard
    document.querySelectorAll('.copy-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const codeId = `code-${(btn as HTMLElement).dataset.code}`;
        const codeEl = document.getElementById(codeId);
        if (codeEl) {
          navigator.clipboard.writeText(codeEl.textContent || '');
          btn.textContent = 'Copied!';
          setTimeout(() => {
            btn.textContent = 'Copy';
          }, 2000);
        }
      });
    });
  </script>
</Layout>
