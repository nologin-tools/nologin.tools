---
import { TAG_DEFINITIONS } from '../lib/tags';

interface Props {
  selectedTags?: { key: string; value: string }[];
}

const { selectedTags = [] } = Astro.props;
---

<div class="tag-picker-container space-y-4">
  {TAG_DEFINITIONS.map((def) => {
    const selected = selectedTags
      .filter((t) => t.key === def.key)
      .map((t) => t.value);

    return (
      <fieldset>
        <legend class="text-sm font-medium text-neutral-700 mb-2">
          {def.label}
        </legend>
        <div class="flex flex-wrap gap-2">
          {def.values.map((val) => {
            const isSelected = selected.includes(val);
            return (
              <label
                class:list={[
                  'chip chip-toggle cursor-pointer select-none',
                  isSelected ? 'chip-active' : 'chip-default',
                ]}
                data-tag-group={def.key}
                data-multi-select={def.multiSelect ? 'true' : 'false'}
              >
                <input
                  type="checkbox"
                  name={`tag_${def.key}[]`}
                  value={val}
                  checked={isSelected}
                  class="sr-only peer"
                />
                <svg class="chip-check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span class="font-bold">{val}</span>
              </label>
            );
          })}
        </div>
      </fieldset>
    );
  })}
</div>

<script>
  document.querySelectorAll('.tag-picker-container').forEach((container) => {
    container.querySelectorAll('.chip-toggle input[type="checkbox"]').forEach((input) => {
      input.addEventListener('change', () => {
        const checkbox = input as HTMLInputElement;
        const label = checkbox.closest('label');
        if (!label) return;

        const isMultiSelect = label.dataset.multiSelect === 'true';
        const group = label.dataset.tagGroup;
        const picker = label.closest('.tag-picker-container');
        if (!picker || !group) return;

        if (!isMultiSelect && checkbox.checked) {
          // Single-select: uncheck others in same group
          picker.querySelectorAll(`label[data-tag-group="${group}"] input[type="checkbox"]`).forEach((other) => {
            if (other !== checkbox) {
              (other as HTMLInputElement).checked = false;
              other.closest('label')?.classList.remove('chip-active');
              other.closest('label')?.classList.add('chip-default');
            }
          });
        }

        if (checkbox.checked) {
          label.classList.remove('chip-default');
          label.classList.add('chip-active');
        } else {
          label.classList.remove('chip-active');
          label.classList.add('chip-default');
        }
      });
    });
  });
</script>
