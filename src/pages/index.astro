---
import Layout from '../layouts/Layout.astro';
import ToolCard from '../components/ToolCard.astro';
import { TAG_DEFINITIONS } from '../lib/tags';
import { getApprovedTools, getToolHealthStatus, computeScore as computeToolScore } from '../data/loader';
import type { EffectiveStatus } from '../lib/health';

const approvedTools = getApprovedTools();

const toolsWithMeta = approvedTools.map(tool => {
  const health = getToolHealthStatus(tool);
  const score = computeToolScore(tool, health);
  return { ...tool, health, score };
});

const allTools = [...toolsWithMeta].sort((a, b) => b.score - a.score);

const tagMap = new Map<number, { tagKey: string; tagValue: string }[]>();
for (const tool of allTools) {
  tagMap.set(tool.id, tool.tags);
}

const healthMap = new Map<number, { status: EffectiveStatus; checkedAt: Date }>();
for (const tool of allTools) {
  if (tool.health) healthMap.set(tool.id, tool.health);
}

const featuredTools = allTools
  .filter(t => t.isFeatured)
  .sort((a, b) => {
    const aTime = a.featuredAt ? new Date(a.featuredAt).getTime() : 0;
    const bTime = b.featuredAt ? new Date(b.featuredAt).getTime() : 0;
    return bTime - aTime;
  });

const RECENT_TOOLS_COUNT = 8;
const recentTools = [...allTools]
  .filter(t => t.approvedAt)
  .sort((a, b) => {
    const aTime = a.approvedAt ? new Date(a.approvedAt).getTime() : 0;
    const bTime = b.approvedAt ? new Date(b.approvedAt).getTime() : 0;
    return bTime - aTime;
  })
  .slice(0, RECENT_TOOLS_COUNT);

const maxPerGroup = 6;
const categoryDef = TAG_DEFINITIONS.find(d => d.key === 'category');
const categoryOrder = categoryDef ? categoryDef.values : [];
type ToolType = (typeof allTools)[number];
const categoryGroups: { category: string; tools: ToolType[] }[] = [];
const groupMap = new Map<string, ToolType[]>();
for (const cat of categoryOrder) groupMap.set(cat, []);

for (const tool of allTools) {
  const catTag = tool.tags.find(t => t.tagKey === 'category');
  const cat = catTag ? catTag.tagValue : 'Other';
  if (!groupMap.has(cat)) groupMap.set(cat, []);
  groupMap.get(cat)!.push(tool);
}

for (const cat of categoryOrder) {
  const catTools = groupMap.get(cat) || [];
  if (catTools.length > 0) categoryGroups.push({ category: cat, tools: catTools });
}
const otherGroupTools = groupMap.get('Other') || [];
if (otherGroupTools.length > 0) categoryGroups.push({ category: 'Other', tools: otherGroupTools });

const totalTools = allTools.length;

const clientToolsData = allTools.map(tool => ({
  s: tool.slug,
  n: tool.name,
  u: tool.url,
  d: tool.description,
  a: tool.approvedAt,
  f: tool.isFeatured,
  t: tool.tags.map(t => [t.tagKey, t.tagValue]),
  h: tool.health?.status || null,
  c: tool.health ? tool.health.checkedAt.toISOString() : null,
  sc: tool.score,
  ar: tool.archiveUrl,
}));
---

<Layout title="Home">
  <script is:inline>if(location.search)document.documentElement.classList.add('has-filters')</script>
  <style is:inline>.has-filters #grouped-view{display:none!important}.has-filters #flat-view-loading{display:flex!important}</style>

  {/* Hero Background Elements */}
  <div class="absolute top-0 inset-x-0 h-[32rem] pointer-events-none -z-10 overflow-hidden">
    <div class="absolute -top-24 -left-24 w-96 h-96 bg-green-100/30 blur-3xl rounded-full"></div>
    <div class="absolute top-48 -right-48 w-80 h-80 bg-blue-100/20 blur-3xl rounded-full"></div>
    <div class="absolute top-0 inset-x-0 h-full opacity-[0.03] [mask-image:linear-gradient(to_bottom,black,transparent)]" style="background-image: radial-gradient(#000 0.5px, transparent 0.5px); background-size: 24px 24px;"></div>
  </div>

  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-10 sm:py-24">
    <!-- Hero -->
    <div class="text-center mb-12 sm:mb-16 relative">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-50 border border-green-100/50 text-green-700 text-[10px] sm:text-xs font-bold uppercase tracking-wider mb-4 sm:mb-6 shadow-sm">
        <span class="flex h-2 w-2 relative">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
        </span>
        Privacy First Tools
      </div>
      <h1 class="text-4xl sm:text-6xl font-black tracking-tight text-neutral-900 mb-4 sm:mb-6 [text-wrap:balance]">
        Discover <span class="text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-500">Respectful</span> Tools
      </h1>
      <p class="text-base sm:text-xl text-neutral-500 max-w-2xl mx-auto mb-8 sm:mb-10 leading-relaxed px-2">
        The curated directory of high-quality tools that respect your privacy â€” no login, no tracking, just utility.
      </p>

      <div class="flex items-center justify-center gap-4 mb-8 sm:mb-12">
        <a href="/badge/nologin-tools" class="inline-block transition-transform hover:scale-105 active:scale-95 shadow-md rounded-lg">
          <img src="/badges/for-the-badge.svg" alt="NoLogin Verified" title="Verified by nologin.tools" class="h-8 sm:h-auto" />
        </a>
      </div>

      <!-- Search -->
      <form id="search-form" method="GET" action="/" class="max-w-2xl mx-auto mb-4 group px-2 sm:px-0">
        <div class="relative">
          <div class="absolute inset-0 bg-green-500/10 blur-xl rounded-2xl opacity-0 group-focus-within:opacity-100 transition-opacity duration-500"></div>
          <div class="relative flex items-center bg-white border border-neutral-200 rounded-2xl shadow-[0_4px_12px_-4px_rgba(0,0,0,0.08)] transition-all duration-300 group-focus-within:border-green-500/50 group-focus-within:shadow-[0_8px_24px_-4px_rgba(34,197,94,0.12)] group-focus-within:-translate-y-0.5">
            <svg
              class="ml-4 sm:ml-5 text-neutral-400 group-focus-within:text-green-500 transition-colors"
              width="18"
              height="18"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
            >
              <circle cx="9" cy="9" r="6"></circle>
              <path d="M13.5 13.5L17 17" stroke-linecap="round"></path>
            </svg>
            <input
              type="text"
              name="q"
              value=""
              placeholder="Search for tools..."
              class="w-full px-3 sm:px-4 py-3 sm:py-4 bg-transparent rounded-2xl text-sm sm:text-base text-neutral-900 placeholder-neutral-400 focus:outline-none pr-4"
            />
            <span id="search-clear" class="hidden">
              <a
                href="/"
                class="absolute right-3 text-neutral-400 hover:text-neutral-600 transition-colors p-1 hover:bg-neutral-100 rounded-full"
                aria-label="Clear search"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                  <path d="M4 4l8 8M12 4l-8 8" />
                </svg>
              </a>
            </span>
          </div>
        </div>
      </form>
    </div>

    <!-- Category Filter -->
    {(() => {
      const catDef = TAG_DEFINITIONS.find((d) => d.key === 'category');
      if (!catDef) return null;
      return (
        <div class="mb-8 overflow-x-auto pb-4 -mx-4 px-4 sm:mx-0 sm:px-0 scrollbar-hide">
          <div class="flex flex-nowrap sm:flex-wrap items-center sm:justify-center gap-2 sm:gap-3">
            <a
              href="/"
              data-filter-key="category"
              data-filter-value=""
              class="chip chip-toggle shrink-0 text-[11px] sm:text-xs chip-active"
            >
              All Tools
            </a>
            <div class="w-px h-4 bg-neutral-200 mx-1 shrink-0"></div>
            {catDef.values.map((val) => (
              <a
                href={"/?category=" + val}
                data-filter-key="category"
                data-filter-value={val}
                class="chip chip-toggle shrink-0 text-[11px] sm:text-xs chip-default"
              >
                {val}
              </a>
            ))}
          </div>
        </div>
      );
    })()}

    {/* Active Filters Bar */}
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 sm:gap-6 mb-8 sm:mb-10 pb-6 border-b border-neutral-100">
      <div class="flex flex-wrap items-center gap-2 sm:gap-3">
        <div id="filter-status" class="flex items-center gap-2 text-neutral-500">
          <span class="text-xs sm:text-sm font-medium">
            {totalTools} curated tools
          </span>
        </div>
      </div>

      <div class="flex items-center gap-3 sm:gap-4 overflow-x-auto sm:overflow-visible pb-2 sm:pb-0 scrollbar-hide">
        <div class="flex items-center gap-1 p-1 bg-neutral-100/50 rounded-xl border border-neutral-200/50 shrink-0">
          {[
            { key: 'recommended', label: 'Best' },
            { key: 'newest', label: 'New' },
            { key: 'alpha', label: 'A-Z' },
          ].map((s) => (
            <a
              href={"/?sort=" + s.key}
              data-sort={s.key}
              class={`px-3 sm:px-4 py-1.5 rounded-lg text-[10px] sm:text-xs font-bold transition-all duration-200 ${
                s.key === 'recommended'
                  ? 'bg-white text-neutral-900 shadow-sm ring-1 ring-neutral-200'
                  : 'text-neutral-500 hover:text-neutral-900 hover:bg-white/50'
              }`}
            >
              {s.label}
            </a>
          ))}
        </div>

        {/* More Filters Toggle */}
        <button
          type="button"
          id="more-filters-toggle"
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl text-[10px] sm:text-xs font-bold border transition-all shrink-0 bg-white text-neutral-600 border-neutral-200 hover:bg-neutral-50"
        >
          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line>
          </svg>
          Filters
        </button>
      </div>
    </div>

    {/* More Filters Panel (Slide Down) */}
    <div id="more-filters-panel" class="mb-10 p-6 bg-neutral-50 border border-neutral-200 rounded-2xl overflow-hidden transition-all duration-300 hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        {TAG_DEFINITIONS.filter((def) => def.key !== 'category').map((def) => (
          <div>
            <h3 class="text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em] mb-4">{def.label}</h3>
            <div class="flex flex-wrap gap-2">
              {def.values.map((val) => (
                <a
                  href={"/?"+def.key+"="+val}
                  data-filter-key={def.key}
                  data-filter-value={val}
                  class="chip text-[11px] px-4 py-1.5 chip-default bg-white"
                >
                  {val}
                </a>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>

    <div id="grouped-view">
      {totalTools > 0 ? (
        <div class="space-y-12 sm:space-y-20">
          {featuredTools.length > 0 && (
            <section id="spotlight-carousel" aria-label="Featured tools spotlight" class="relative">
              <div class="flex items-center justify-between mb-6 sm:mb-8">
                <h2 class="flex items-center gap-2 sm:gap-3 text-xl sm:text-2xl font-black text-neutral-900">
                  <span class="inline-flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-xl sm:rounded-2xl bg-gradient-to-br from-yellow-400 to-amber-500 text-white shadow-lg shadow-yellow-200">
                    <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                  </span>
                  Spotlight
                </h2>
                {featuredTools.length > 1 && (
                  <div class="flex items-center gap-2">
                    <button
                      type="button"
                      id="spotlight-prev"
                      aria-label="Previous featured tool"
                      class="p-1.5 sm:p-2 rounded-xl border border-neutral-200 text-neutral-400 hover:text-neutral-900 hover:bg-white hover:border-neutral-300 hover:shadow-sm transition-all active:scale-90"
                    >
                      <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                      </svg>
                    </button>
                    <button
                      type="button"
                      id="spotlight-next"
                      aria-label="Next featured tool"
                      class="p-1.5 sm:p-2 rounded-xl border border-neutral-200 text-neutral-400 hover:text-neutral-900 hover:bg-white hover:border-neutral-300 hover:shadow-sm transition-all active:scale-90"
                    >
                      <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </div>
                )}
              </div>
              <div class="spotlight-track h-auto min-h-[14rem] sm:min-h-[16rem]" aria-live="polite">
                {featuredTools.map((tool, i) => {
                  const health = healthMap.get(tool.id);
                  const tTags = tagMap.get(tool.id) || [];
                  const hostname = (() => { try { return new URL(tool.url).hostname; } catch { return ''; } })();
                  const displayTags = tTags.slice(0, 5);
                  return (
                    <div
                      class:list={[
                        'spotlight-slide',
                        i === 0 ? 'spotlight-slide-active' : 'opacity-0',
                      ]}
                      data-slide-index={i}
                    >
                      <div class="relative overflow-hidden border border-yellow-200/60 rounded-[2rem] sm:rounded-3xl bg-white shadow-[0_20px_50px_-12px_rgba(234,179,8,0.12)]">
                        {/* Decorative background elements */}
                        <div class="absolute top-0 right-0 w-[40%] h-full bg-gradient-to-l from-yellow-50/50 to-transparent pointer-events-none"></div>
                        <div class="absolute -top-24 -right-24 w-64 h-64 bg-yellow-100/40 blur-3xl rounded-full pointer-events-none"></div>

                        <div class="relative p-6 sm:p-10">
                          <div class="flex flex-col md:flex-row gap-6 sm:gap-8 lg:gap-12">
                            {/* Icon column */}
                            <div class="shrink-0 flex items-center md:flex-col md:items-center gap-4 sm:gap-6">
                              <div class="w-16 h-16 sm:w-24 sm:h-24 rounded-2xl sm:rounded-[2rem] bg-white shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-neutral-100 flex items-center justify-center overflow-hidden">
                                <img
                                  src={`https://www.google.com/s2/favicons?domain=${hostname}&sz=128`}
                                  alt=""
                                  width="64"
                                  height="64"
                                  class="w-10 h-10 sm:w-16 sm:h-16 object-contain"
                                  loading="lazy"
                                  onerror={`this.style.display='none';this.nextElementSibling.style.display='flex'`}
                                />
                                <span class="w-full h-full bg-gradient-to-br from-yellow-100 to-amber-100 text-amber-600 text-xl sm:text-3xl font-black items-center justify-center hidden">
                                  {tool.name.charAt(0).toUpperCase()}
                                </span>
                              </div>
                              <div class="md:text-center">
                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[9px] sm:text-[10px] font-black uppercase tracking-widest bg-yellow-100 text-yellow-700 border border-yellow-200/50 shadow-sm">
                                  Featured
                                </span>
                              </div>
                            </div>

                            {/* Content */}
                            <div class="flex-1 min-w-0">
                              <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-2">
                                <a href={`/tool/${tool.slug}`} class="text-2xl sm:text-4xl font-black text-neutral-950 hover:text-green-600 transition-colors">
                                  {tool.name}
                                </a>
                                {health && (
                                  <span class:list={['inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[9px] font-bold uppercase tracking-tight border',
                                    health.status === 'online' ? 'bg-green-50 text-green-700 border-green-200/50' :
                                    health.status === 'unstable' ? 'bg-amber-50 text-amber-700 border-amber-200/50' :
                                    'bg-red-50 text-red-700 border-red-200/50']}>
                                    <span class:list={['w-1 h-1 rounded-full',
                                      health.status === 'online' ? 'bg-green-500 animate-pulse' :
                                      health.status === 'unstable' ? 'bg-amber-500' :
                                      'bg-red-500']} />
                                    {health.status === 'online' ? 'Online' : health.status === 'unstable' ? 'Unstable' : 'Offline'}
                                  </span>
                                )}
                              </div>
                              <div class="text-xs sm:text-sm text-neutral-400 font-medium mb-4 sm:mb-6 flex items-center gap-2">
                                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                                {hostname}
                              </div>
                              {tool.description && (
                                <p class="text-sm sm:text-lg text-neutral-600 leading-relaxed mb-6 sm:mb-8 max-w-3xl line-clamp-2 md:line-clamp-3">
                                  {tool.description}
                                </p>
                              )}
                              <div class="flex flex-wrap items-center gap-2 mb-6 sm:mb-8">
                                {displayTags.map((tag) => (
                                  <span class:list={['chip text-[9px] px-2.5 py-1 uppercase tracking-wider', tag.tagKey === 'category' ? 'chip-category' : 'chip-default cursor-default']}>
                                    {tag.tagKey === 'category' ? tag.tagValue : tag.tagValue}
                                  </span>
                                ))}
                                <div class="hidden sm:block h-4 w-px bg-neutral-200 mx-2"></div>
                                <span class="inline-flex items-center gap-1 text-[10px] sm:text-xs text-green-600 font-black uppercase tracking-tight">
                                  <div class="w-3.5 h-3.5 sm:w-4 sm:h-4 rounded-full bg-green-500 flex items-center justify-center">
                                    <svg width="10" height="10" viewBox="0 0 12 12" fill="none">
                                      <path d="M3.5 6L5.5 8L8.5 4" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                  </div>
                                  Verified
                                </span>
                              </div>

                              <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                                <a
                                  href={tool.url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  class="btn-primary w-full sm:w-auto justify-center"
                                >
                                  Visit Website
                                  <svg class="ml-2 w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.22 14.78a.75.75 0 010-1.06l7.22-7.22H5.75a.75.75 0 010-1.5h8.5a.75.75 0 01.75.75v8.5a.75.75 0 01-1.5 0V6.56l-7.22 7.22a.75.75 0 01-1.06 0z" clip-rule="evenodd" />
                                  </svg>
                                </a>
                                <a
                                  href={`/tool/${tool.slug}`}
                                  class="btn-secondary w-full sm:w-auto justify-center"
                                >
                                  View Details
                                </a>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
              {featuredTools.length > 1 && (
                <div class="flex justify-center gap-2 sm:gap-3 mt-6 sm:mt-8" id="spotlight-dots">
                  {featuredTools.map((_, i) => (
                    <button
                      type="button"
                      class:list={['spotlight-dot', i === 0 && 'spotlight-dot-active']}
                      data-dot-index={i}
                      aria-label={`Go to featured tool ${i + 1}`}
                    />
                  ))}
                </div>
              )}
            </section>
          )}

          {recentTools.length > 0 && (
            <section id="recently-added" aria-label="Recently added tools">
              <div class="flex items-end justify-between mb-6 sm:mb-8 pb-4 border-b border-neutral-100">
                <h2 class="text-xl sm:text-2xl font-black text-neutral-900 flex items-center gap-2 sm:gap-3">
                  <span class="inline-flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-xl sm:rounded-2xl bg-gradient-to-br from-green-400 to-emerald-500 text-white shadow-lg shadow-green-200">
                    <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                  </span>
                  Recently Added
                  <span class="inline-flex items-center px-2 py-0.5 rounded-lg bg-green-100 text-green-700 text-[9px] sm:text-[10px] font-black uppercase tracking-wider">New</span>
                </h2>
                <a
                  href="/?sort=newest"
                  class="text-xs sm:text-sm font-bold text-green-600 hover:text-green-700 transition-colors flex items-center gap-1 group/link"
                >
                  View all
                  <svg class="w-3.5 h-3.5 transition-transform group-hover/link:translate-x-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </a>
              </div>
              <div class="relative group/scroll">
                {/* Left gradient mask */}
                <div id="recent-mask-left" class="hidden absolute left-0 top-0 bottom-0 w-12 sm:w-16 bg-gradient-to-r from-neutral-50/90 to-transparent z-10 pointer-events-none"></div>
                {/* Right gradient mask */}
                <div id="recent-mask-right" class="absolute right-0 top-0 bottom-0 w-12 sm:w-16 bg-gradient-to-l from-neutral-50/90 to-transparent z-10 pointer-events-none"></div>
                {/* Left arrow */}
                <button
                  type="button"
                  id="recent-prev"
                  aria-label="Scroll left"
                  class="hidden sm:flex absolute left-0 top-1/2 -translate-y-1/2 z-20 p-2 rounded-xl bg-white border border-neutral-200 text-neutral-400 shadow-lg opacity-0 group-hover/scroll:opacity-100 hover:text-neutral-900 hover:border-neutral-300 transition-all active:scale-90 disabled:opacity-0"
                >
                  <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                  </svg>
                </button>
                {/* Right arrow */}
                <button
                  type="button"
                  id="recent-next"
                  aria-label="Scroll right"
                  class="hidden sm:flex absolute right-0 top-1/2 -translate-y-1/2 z-20 p-2 rounded-xl bg-white border border-neutral-200 text-neutral-400 shadow-lg opacity-0 group-hover/scroll:opacity-100 hover:text-neutral-900 hover:border-neutral-300 transition-all active:scale-90 disabled:opacity-0"
                >
                  <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                  </svg>
                </button>
                {/* Scroll track */}
                <div id="recent-track" class="flex gap-4 sm:gap-6 overflow-x-auto snap-x snap-mandatory scroll-smooth -mx-4 px-4 sm:mx-0 sm:px-0 pb-2 scrollbar-hide">
                  {recentTools.map((tool) => {
                    const health = healthMap.get(tool.id);
                    const tTags = tagMap.get(tool.id) || [];
                    return (
                      <div class="w-[280px] sm:w-[320px] shrink-0 snap-start">
                        <ToolCard
                          slug={tool.slug}
                          name={tool.name}
                          url={tool.url}
                          description={tool.description}
                          isVerified={tool.status === 'approved'}
                          healthStatus={health?.status ?? null}
                          lastCheckedAt={health?.checkedAt ?? null}
                          tags={tTags}
                          archiveUrl={tool.archiveUrl}
                          isFeatured={'isFeatured' in tool && !!tool.isFeatured}
                        />
                      </div>
                    );
                  })}
                </div>
              </div>
            </section>
          )}

          {categoryGroups.map((group) => (
            <section class="relative">
              <div class="flex items-end justify-between mb-6 sm:mb-8 pb-4 border-b border-neutral-100">
                <h2 class="text-xl sm:text-2xl font-black text-neutral-900 flex items-center gap-2 sm:gap-3">
                  {group.category}
                  <span class="inline-flex items-center justify-center px-2 py-0.5 rounded-lg bg-neutral-100 text-neutral-500 text-[10px] sm:text-xs font-bold">{group.tools.length}</span>
                </h2>
                {group.tools.length > maxPerGroup && (
                  <a
                    href={"/?category=" + group.category}
                    class="text-xs sm:text-sm font-bold text-green-600 hover:text-green-700 transition-colors flex items-center gap-1 group/link"
                  >
                    View gallery
                    <svg class="w-3.5 h-3.5 transition-transform group-hover/link:translate-x-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                  </a>
                )}
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                {group.tools.slice(0, maxPerGroup).map((tool) => {
                  const health = healthMap.get(tool.id);
                  const tTags = tagMap.get(tool.id) || [];
                  return (
                    <ToolCard
                      slug={tool.slug}
                      name={tool.name}
                      url={tool.url}
                      description={tool.description}
                      isVerified={tool.status === 'approved'}
                      healthStatus={health?.status ?? null}
                      lastCheckedAt={health?.checkedAt ?? null}
                      tags={tTags}
                      archiveUrl={tool.archiveUrl}
                      isFeatured={'isFeatured' in tool && !!tool.isFeatured}
                    />
                  );
                })}
              </div>
            </section>
          ))}
        </div>
      ) : (
        <div class="text-center py-16 sm:py-24 glass-card rounded-[2rem] sm:rounded-[3rem] px-4">
          <div class="w-16 h-16 sm:w-20 sm:h-20 bg-neutral-100 rounded-2xl sm:rounded-[2rem] flex items-center justify-center mx-auto mb-6">
            <svg class="text-neutral-400" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <circle cx="11" cy="11" r="7" />
              <path d="M21 21l-4.35-4.35" />
            </svg>
          </div>
          <p class="text-lg sm:text-xl text-neutral-900 mb-2 font-black">No tools found yet</p>
          <p class="text-sm sm:text-base text-neutral-500 mb-8 sm:mb-10 max-w-sm mx-auto">Be the first to submit a privacy-friendly tool to this collection.</p>
          <a href="/submit" class="btn-primary w-full sm:w-auto justify-center">Submit a Tool</a>
        </div>
      )}
    </div>

    <!-- Flat View (rendered by client JS when search/filters active) -->
    <div id="flat-view" class="hidden">
      <div id="flat-view-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-8 sm:mb-12"></div>
      <div id="flat-view-pagination" class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-6 pt-8 sm:pt-12 border-t border-neutral-100"></div>
    </div>

    <!-- Flat View Empty State -->
    <div id="flat-view-empty" class="hidden text-center py-16 sm:py-24 glass-card rounded-[2rem] sm:rounded-[3rem] px-4">
      <div class="w-16 h-16 sm:w-20 sm:h-20 bg-neutral-100 rounded-2xl sm:rounded-[2rem] flex items-center justify-center mx-auto mb-6">
        <svg class="text-neutral-400" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <circle cx="11" cy="11" r="7" />
          <path d="M21 21l-4.35-4.35" />
        </svg>
      </div>
      <p id="flat-empty-title" class="text-lg sm:text-xl text-neutral-900 mb-2 font-black">No matches found</p>
      <p id="flat-empty-text" class="text-sm sm:text-base text-neutral-500 mb-8 sm:mb-10 max-w-sm mx-auto">No tools match the selected filters.</p>
      <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
        <a href="/" class="btn-secondary w-full sm:w-auto justify-center">Clear filters</a>
        <a href="/submit" class="btn-primary w-full sm:w-auto justify-center">Submit a Tool</a>
      </div>
    </div>

    <!-- Loading indicator (shown briefly while JS processes filters) -->
    <div id="flat-view-loading" class="hidden items-center justify-center py-24">
      <div class="w-8 h-8 border-4 border-neutral-200 border-t-green-500 rounded-full animate-spin"></div>
    </div>
  </div>
</Layout>

<script id="tools-data" type="application/json" set:html={JSON.stringify(clientToolsData)}></script>

<script>
  // Client-side search, filter, sort, and paginate
  (function() {
    const TAG_KEYS = ['category','source','data','privacy','type','hosting','offline','pricing'];
    const TAG_LABELS: Record<string, string> = {category:'Category',source:'Source',data:'Data Processing',privacy:'Privacy',type:'Type',hosting:'Hosting',offline:'Offline',pricing:'Pricing'};
    const params = new URLSearchParams(location.search);
    const query = params.get('q') || '';
    const sort = params.get('sort') || 'recommended';
    const page = Math.max(1, parseInt(params.get('page') || '1', 10));
    const perPage = 24;

    const activeFilters: {key:string,value:string}[] = [];
    for (const key of TAG_KEYS) {
      const val = params.get(key);
      if (val) activeFilters.push({ key, value: val });
    }

    const hasFilters = query || sort !== 'recommended' || activeFilters.length > 0;

    // Update search input value
    const searchInput = document.querySelector<HTMLInputElement>('#search-form input[name="q"]');
    if (searchInput && query) {
      searchInput.value = query;
      const clearBtn = document.getElementById('search-clear');
      if (clearBtn) clearBtn.classList.remove('hidden');
    }

    // Update sort tab active states and hrefs
    document.querySelectorAll<HTMLAnchorElement>('[data-sort]').forEach(el => {
      const s = el.dataset.sort!;
      el.href = buildUrl({ sort: s === 'recommended' ? '' : s });
      if (s === sort) {
        el.className = el.className.replace(/text-neutral-500 hover:text-neutral-900 hover:bg-white\/50/g, 'bg-white text-neutral-900 shadow-sm ring-1 ring-neutral-200');
      } else {
        el.className = el.className.replace(/bg-white text-neutral-900 shadow-sm ring-1 ring-neutral-200/g, 'text-neutral-500 hover:text-neutral-900 hover:bg-white/50');
      }
    });

    // Update category chip active states and hrefs
    document.querySelectorAll<HTMLAnchorElement>('[data-filter-key="category"]').forEach(el => {
      const val = el.dataset.filterValue!;
      const activeCat = activeFilters.find(f => f.key === 'category');
      const isActive = val === '' ? !activeCat : activeCat?.value === val;
      el.href = val ? buildUrl({ category: val }) : buildUrl({ category: '' });
      if (isActive) {
        el.classList.remove('chip-default');
        el.classList.add('chip-active');
      } else {
        el.classList.remove('chip-active');
        el.classList.add('chip-default');
      }
    });

    // Update more-filter chips
    document.querySelectorAll<HTMLAnchorElement>('[data-filter-key]:not([data-filter-key="category"])').forEach(el => {
      const key = el.dataset.filterKey!;
      const val = el.dataset.filterValue!;
      const isActive = activeFilters.some(f => f.key === key && f.value === val);
      el.href = isActive ? buildUrl({ [key]: '' }) : buildUrl({ [key]: val });
      if (isActive) {
        el.classList.remove('chip-default', 'bg-white');
        el.classList.add('chip-active');
      } else {
        el.classList.remove('chip-active');
        el.classList.add('chip-default', 'bg-white');
      }
    });

    // Auto-expand more filters if non-category filters are active
    if (activeFilters.some(f => f.key !== 'category')) {
      const panel = document.getElementById('more-filters-panel');
      if (panel) panel.classList.remove('hidden');
      const toggle = document.getElementById('more-filters-toggle');
      if (toggle) {
        toggle.classList.remove('bg-white', 'text-neutral-600', 'border-neutral-200');
        toggle.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
      }
    }

    // Update filter status bar
    const filterStatus = document.getElementById('filter-status');
    if (filterStatus) {
      if (activeFilters.length > 0 || query) {
        // Will be updated after filtering with result count
      }
    }

    // Add hidden inputs to search form for active filters
    const searchForm = document.getElementById('search-form') as HTMLFormElement | null;
    if (searchForm) {
      for (const f of activeFilters) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = f.key;
        input.value = f.value;
        searchForm.prepend(input);
      }
      if (sort !== 'recommended') {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'sort';
        input.value = sort;
        searchForm.prepend(input);
      }
    }

    if (!hasFilters) return;

    // Load tools data
    const toolsRaw = JSON.parse(document.getElementById('tools-data')!.textContent!);

    // Filter
    let filtered = toolsRaw;
    if (query) {
      const q = query.toLowerCase();
      filtered = filtered.filter((t: any) =>
        t.n.toLowerCase().includes(q) || (t.d && t.d.toLowerCase().includes(q))
      );
    }
    if (activeFilters.length > 0) {
      filtered = filtered.filter((t: any) =>
        activeFilters.every(f =>
          t.t.some((tag: [string,string]) => tag[0] === f.key && tag[1] === f.value)
        )
      );
    }

    // Sort
    if (sort === 'newest') {
      filtered.sort((a: any, b: any) => {
        const at = a.a ? new Date(a.a).getTime() : 0;
        const bt = b.a ? new Date(b.a).getTime() : 0;
        return bt - at;
      });
    } else if (sort === 'alpha') {
      filtered.sort((a: any, b: any) => a.n.localeCompare(b.n));
    } else {
      filtered.sort((a: any, b: any) => b.sc - a.sc);
    }

    const totalFiltered = filtered.length;
    const totalPages = Math.max(1, Math.ceil(totalFiltered / perPage));
    const safePage = Math.min(page, totalPages);
    const paged = filtered.slice((safePage - 1) * perPage, safePage * perPage);

    // Update filter status bar with results count
    if (filterStatus) {
      if (activeFilters.length > 0) {
        const chips = activeFilters.map((f: {key:string,value:string}) => {
          const label = f.key === 'category' ? f.value : `${TAG_LABELS[f.key as keyof typeof TAG_LABELS] || f.key}: ${f.value}`;
          return `<a href="${escapeAttr(buildUrl({[f.key]:''}))}" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-neutral-900 text-white text-[10px] font-medium hover:bg-neutral-800 transition-colors shadow-sm">${escapeHtml(label)}<svg class="w-2.5 h-2.5" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M3 3l6 6M9 3l-6 6"/></svg></a>`;
        }).join('');
        const clearUrl = buildUrl(Object.fromEntries(activeFilters.map((f: {key:string}) => [f.key, ''])));
        filterStatus.innerHTML = `<span class="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mr-1">Filtered by:</span>${chips}<a href="${escapeAttr(clearUrl)}" class="text-[10px] text-neutral-400 hover:text-neutral-600 underline underline-offset-4 transition-colors px-1">Clear all</a>`;
      } else if (query) {
        filterStatus.innerHTML = `<div class="flex items-center gap-2 text-neutral-500"><span class="text-xs sm:text-sm font-medium">${totalFiltered} result${totalFiltered !== 1 ? 's' : ''} for &quot;${escapeHtml(query)}&quot;</span></div>`;
      }
    }

    // Hide grouped view, show flat view
    document.getElementById('grouped-view')?.style.setProperty('display', 'none');
    document.getElementById('flat-view-loading')?.classList.add('hidden');

    if (paged.length === 0) {
      const emptyEl = document.getElementById('flat-view-empty')!;
      emptyEl.classList.remove('hidden');
      const title = document.getElementById('flat-empty-title')!;
      const text = document.getElementById('flat-empty-text')!;
      title.textContent = 'No matches found';
      text.textContent = query ? `We couldn't find anything matching "${query}".` : 'No tools match the selected filters.';
      return;
    }

    // Render tool cards
    const grid = document.getElementById('flat-view-grid')!;
    grid.innerHTML = paged.map((tool: any) => createToolCard(tool)).join('');
    document.getElementById('flat-view')!.classList.remove('hidden');

    // Render pagination
    if (totalPages > 1) {
      const pagDiv = document.getElementById('flat-view-pagination')!;
      let pagHTML = '<div class="flex items-center gap-4 order-2 sm:order-1">';
      if (safePage > 1) {
        pagHTML += `<a href="${escapeAttr(buildUrl({page:String(safePage-1)}))}" class="btn-secondary py-2"><svg class="mr-1 w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>Prev</a>`;
      } else {
        pagHTML += '<div class="w-[84px] hidden sm:block"></div>';
      }
      pagHTML += '<div class="flex items-center gap-1.5">';
      for (let i = 0; i < Math.min(3, totalPages); i++) {
        let pn = i + 1;
        if (totalPages > 3 && safePage > 2) {
          pn = safePage - 1 + i;
          if (pn > totalPages) pn = totalPages - (2 - i);
        }
        if (pn <= 0 || pn > totalPages) continue;
        const cls = safePage === pn ? 'bg-green-600 text-white shadow-lg shadow-green-100' : 'text-neutral-500 hover:bg-neutral-100';
        pagHTML += `<a href="${escapeAttr(buildUrl({page:String(pn)}))}" class="w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center rounded-xl text-[11px] sm:text-sm font-bold transition-all ${cls}">${pn}</a>`;
      }
      pagHTML += '</div>';
      if (safePage < totalPages) {
        pagHTML += `<a href="${escapeAttr(buildUrl({page:String(safePage+1)}))}" class="btn-secondary py-2">Next<svg class="ml-1 w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110 2H5.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"/></svg></a>`;
      } else {
        pagHTML += '<div class="w-[84px] hidden sm:block"></div>';
      }
      pagHTML += '</div>';
      pagDiv.innerHTML = pagHTML;
    }

    function buildUrl(changes: Record<string,string>) {
      const u = new URL(location.href);
      for (const [k, v] of Object.entries(changes)) {
        if (v) u.searchParams.set(k, v);
        else u.searchParams.delete(k);
      }
      if (!('page' in changes)) u.searchParams.delete('page');
      return u.pathname + u.search;
    }

    function escapeHtml(str: string) {
      if (!str) return '';
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function escapeAttr(str: string) {
      return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;');
    }

    function timeAgo(dateStr: string) {
      const seconds = Math.floor((Date.now() - new Date(dateStr).getTime()) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + 'm ago';
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return hours + 'h ago';
      const days = Math.floor(hours / 24);
      if (days < 30) return days + 'd ago';
      return Math.floor(days / 30) + 'mo ago';
    }

    function createToolCard(tool: any) {
      const hostname = (() => { try { return new URL(tool.u).hostname; } catch { return ''; } })();
      const faviconUrl = hostname ? `https://www.google.com/s2/favicons?domain=${hostname}&sz=32` : '';
      const initial = tool.n.charAt(0).toUpperCase();
      const isOffline = tool.h === 'offline';
      const tags = tool.t.map((t: [string,string]) => ({ tagKey: t[0], tagValue: t[1] }));
      const sortedTags = [...tags].sort((a: any, b: any) => a.tagKey === 'category' ? -1 : b.tagKey === 'category' ? 1 : 0);

      let hb = '';
      if (tool.h === null) {
        hb = '<span class="inline-flex items-center gap-1.5 text-xs text-neutral-400"><span class="w-2 h-2 rounded-full bg-neutral-300"></span>No checks yet</span>';
      } else if (tool.h === 'online') {
        hb = `<span class="inline-flex items-center gap-1.5 text-xs text-green-600"><span class="w-2 h-2 rounded-full bg-green-500"></span>Online${tool.c ? `<span class="text-neutral-400">&middot; ${timeAgo(tool.c)}</span>` : ''}</span>`;
      } else if (tool.h === 'unstable') {
        hb = `<span class="inline-flex items-center gap-1.5 text-xs text-amber-600"><span class="w-2 h-2 rounded-full bg-amber-500"></span>Unstable${tool.c ? `<span class="text-neutral-400">&middot; ${timeAgo(tool.c)}</span>` : ''}</span>`;
      } else {
        hb = `<span class="inline-flex items-center gap-1.5 text-xs text-red-500"><span class="w-2 h-2 rounded-full bg-red-500"></span>Offline${tool.c ? `<span class="text-neutral-400">&middot; ${timeAgo(tool.c)}</span>` : ''}</span>`;
      }

      const tc = sortedTags.slice(0, 3).map((tag: any) =>
        `<span class="chip text-[10px] uppercase tracking-wider ${tag.tagKey === 'category' ? 'chip-category' : 'chip-default'}">${escapeHtml(tag.tagValue)}</span>`
      ).join('');
      const tm = sortedTags.length > 3 ? `<span class="text-[10px] text-neutral-400 self-center">+${sortedTags.length - 3}</span>` : '';

      const fc = tool.f ? ' ring-1 ring-yellow-400/50 bg-gradient-to-br from-yellow-50/50 to-white' : '';
      const oc = isOffline ? ' opacity-60 grayscale-[0.5]' : '';
      const fs = tool.f ? '<div class="absolute -top-1.5 -right-1.5 w-4 h-4 bg-yellow-400 rounded-full border-2 border-white flex items-center justify-center shadow-sm"><span class="text-[8px] text-white">&#9733;</span></div>' : '';

      return `<a href="/tool/${tool.s}" class="group block relative p-5 bg-white border border-neutral-200/60 rounded-2xl transition-all duration-300 hover:shadow-[0_12px_24px_-8px_rgba(0,0,0,0.08)] hover:-translate-y-1${fc}${oc}">
  <div class="flex items-start justify-between gap-3 mb-4">
    <div class="flex items-center gap-3 min-w-0">
      <div class="relative flex-shrink-0">
        <div class="w-10 h-10 rounded-xl bg-neutral-50 border border-neutral-100 flex items-center justify-center overflow-hidden shadow-sm group-hover:scale-110 transition-transform duration-300">
          ${faviconUrl
            ? `<img src="${faviconUrl}" alt="" width="24" height="24" loading="lazy" class="w-6 h-6 object-contain" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><span class="w-full h-full bg-gradient-to-br from-neutral-50 to-neutral-100 text-neutral-400 text-sm font-bold items-center justify-center hidden">${initial}</span>`
            : `<span class="w-full h-full bg-gradient-to-br from-neutral-50 to-neutral-100 text-neutral-400 text-sm font-bold flex items-center justify-center">${initial}</span>`
          }
        </div>
        ${fs}
      </div>
      <div class="min-w-0">
        <h3 class="font-bold text-neutral-900 truncate group-hover:text-green-600 transition-colors">${escapeHtml(tool.n)}</h3>
        <p class="text-[11px] text-neutral-400 truncate">${hostname}</p>
      </div>
    </div>
    ${hb}
  </div>
  ${tool.d ? `<p class="text-sm text-neutral-600 mb-4 line-clamp-2 leading-relaxed h-[2.5rem]">${escapeHtml(tool.d)}</p>` : ''}
  <div class="flex flex-wrap gap-1.5 mb-4">${tc}${tm}</div>
  <div class="flex items-center justify-between pt-4 border-t border-neutral-50">
    <span class="inline-flex items-center gap-1.5 text-[11px] text-green-600 font-bold uppercase tracking-tight">
      <div class="w-3.5 h-3.5 rounded-full bg-green-500 flex items-center justify-center"><svg width="8" height="8" viewBox="0 0 12 12" fill="none"><path d="M3.5 6L5.5 8L8.5 4" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
      Verified
    </span>
    <div class="flex items-center gap-1 text-neutral-300 group-hover:text-neutral-500 transition-colors">
      <span class="text-[10px] font-medium">Explore</span>
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
    </div>
  </div>
</a>`;
    }
  })();
</script>

<script>
  const toggle = document.getElementById('more-filters-toggle');
  const panel = document.getElementById('more-filters-panel');
  const arrow = document.getElementById('more-filters-arrow');
  toggle?.addEventListener('click', () => {
    panel?.classList.toggle('hidden');
    arrow?.classList.toggle('rotate-90');
  });

  // Spotlight Carousel
  (function () {
    const carousel = document.getElementById('spotlight-carousel');
    if (!carousel) return;

    const slides = carousel.querySelectorAll<HTMLElement>('[data-slide-index]');
    const dots = carousel.querySelectorAll<HTMLElement>('[data-dot-index]');
    const prevBtn = document.getElementById('spotlight-prev');
    const nextBtn = document.getElementById('spotlight-next');

    if (slides.length <= 1) return;

    let currentIndex = 0;
    let isTransitioning = false;
    let autoplayTimer: ReturnType<typeof setInterval> | null = null;
    const AUTOPLAY_INTERVAL = 5000;
    const TRANSITION_DURATION = 500;

    function goToSlide(nextIndex: number, direction: 'right' | 'left') {
      if (isTransitioning || nextIndex === currentIndex) return;
      isTransitioning = true;

      const currentSlide = slides[currentIndex];
      const nextSlide = slides[nextIndex];

      // Set enter position
      nextSlide.className = 'spotlight-slide ' + (direction === 'right' ? 'spotlight-slide-enter-right' : 'spotlight-slide-enter-left');

      // Force reflow
      void nextSlide.offsetHeight;

      // Transition current out, next in
      currentSlide.className = 'spotlight-slide spotlight-slide-exit';
      nextSlide.className = 'spotlight-slide spotlight-slide-active';

      // Update dots
      dots.forEach((dot, i) => {
        if (i === nextIndex) {
          dot.classList.add('spotlight-dot-active');
        } else {
          dot.classList.remove('spotlight-dot-active');
        }
      });

      setTimeout(() => {
        // Clean up exited slide
        currentSlide.className = 'spotlight-slide opacity-0';
        currentIndex = nextIndex;
        isTransitioning = false;
      }, TRANSITION_DURATION);
    }

    function goNext() {
      const next = (currentIndex + 1) % slides.length;
      goToSlide(next, 'right');
    }

    function goPrev() {
      const prev = (currentIndex - 1 + slides.length) % slides.length;
      goToSlide(prev, 'left');
    }

    function startAutoplay() {
      stopAutoplay();
      autoplayTimer = setInterval(goNext, AUTOPLAY_INTERVAL);
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearInterval(autoplayTimer);
        autoplayTimer = null;
      }
    }

    function restartAutoplay() {
      stopAutoplay();
      startAutoplay();
    }

    // Navigation buttons
    prevBtn?.addEventListener('click', () => { goPrev(); restartAutoplay(); });
    nextBtn?.addEventListener('click', () => { goNext(); restartAutoplay(); });

    // Dot navigation
    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const idx = parseInt(dot.getAttribute('data-dot-index') || '0', 10);
        const direction = idx > currentIndex ? 'right' : 'left';
        goToSlide(idx, direction);
        restartAutoplay();
      });
    });

    // Hover pause
    carousel.addEventListener('mouseenter', stopAutoplay);
    carousel.addEventListener('mouseleave', startAutoplay);

    // Keyboard navigation
    carousel.setAttribute('tabindex', '0');
    carousel.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight') { goNext(); restartAutoplay(); }
      else if (e.key === 'ArrowLeft') { goPrev(); restartAutoplay(); }
    });

    // Tab visibility
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopAutoplay();
      else startAutoplay();
    });

    // Start
    startAutoplay();
  })();

  // Recently Added horizontal scroll
  (function () {
    const track = document.getElementById('recent-track');
    const prevBtn = document.getElementById('recent-prev');
    const nextBtn = document.getElementById('recent-next');
    const maskLeft = document.getElementById('recent-mask-left');
    const maskRight = document.getElementById('recent-mask-right');
    if (!track) return;

    function updateScrollState() {
      const { scrollLeft, scrollWidth, clientWidth } = track!;
      const atStart = scrollLeft <= 0;
      const atEnd = scrollLeft + clientWidth >= scrollWidth - 1;

      if (prevBtn) {
        prevBtn.disabled = atStart;
        prevBtn.classList.toggle('!opacity-0', atStart);
      }
      if (nextBtn) {
        nextBtn.disabled = atEnd;
        nextBtn.classList.toggle('!opacity-0', atEnd);
      }
      maskLeft?.classList.toggle('hidden', atStart);
      maskRight?.classList.toggle('hidden', atEnd);
    }

    function getScrollAmount() {
      const firstCard = track!.querySelector<HTMLElement>(':scope > div');
      if (!firstCard) return 320;
      const gap = parseFloat(getComputedStyle(track!).gap) || 16;
      return firstCard.offsetWidth + gap;
    }

    prevBtn?.addEventListener('click', () => {
      track!.scrollBy({ left: -getScrollAmount(), behavior: 'smooth' });
    });
    nextBtn?.addEventListener('click', () => {
      track!.scrollBy({ left: getScrollAmount(), behavior: 'smooth' });
    });

    track.addEventListener('scroll', updateScrollState, { passive: true });
    window.addEventListener('resize', updateScrollState);
    updateScrollState();
  })();
</script>
