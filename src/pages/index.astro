---
import Layout from '../layouts/Layout.astro';
import ToolCard from '../components/ToolCard.astro';
import { getDb } from '../db';
import { tools, tags, healthChecks, badgeDisplays } from '../db/schema';
import { eq, desc, sql, and, inArray } from 'drizzle-orm';
import { TAG_DEFINITIONS } from '../lib/tags';
import { HEALTH_TOLERANCE, resolveEffectiveStatus } from '../lib/health';

const db = getDb(Astro.locals.runtime.env.DB);

const url = Astro.url;
const query = url.searchParams.get('q') || '';
const sort = url.searchParams.get('sort') || 'recommended';
const page = Math.max(1, parseInt(url.searchParams.get('page') || '1', 10));
const perPage = 24;

// Collect active tag filters
const activeFilters: { key: string; value: string }[] = [];
for (const def of TAG_DEFINITIONS) {
  const val = url.searchParams.get(def.key);
  if (val) {
    activeFilters.push({ key: def.key, value: val });
  }
}

// Build SQL query
let toolsQuery;

if (sort === 'recommended') {
  toolsQuery = db
    .select({
      id: tools.id,
      slug: tools.slug,
      name: tools.name,
      url: tools.url,
      description: tools.description,
      status: tools.status,
      approvedAt: tools.approvedAt,
      archiveUrl: tools.archiveUrl,
      isFeatured: tools.isFeatured,
      featuredAt: tools.featuredAt,
      score: sql<number>`
        COALESCE(
          CASE ${badgeDisplays.displayType}
            WHEN 'explicit' THEN 10
            WHEN 'implicit' THEN 5
            ELSE 0
          END, 0
        )
        + CASE
            WHEN ${tools.approvedAt} > unixepoch() - 2592000 THEN 5
            WHEN ${tools.approvedAt} > unixepoch() - 7776000 THEN 3
            ELSE 1
          END
        + COALESCE(
          (SELECT CASE WHEN SUM(sub.is_online) > 0 THEN 3 ELSE 0 END
           FROM (SELECT is_online FROM health_checks WHERE tool_id = ${tools.id}
                 ORDER BY checked_at DESC LIMIT ${HEALTH_TOLERANCE}) sub), 1
        )
        + CASE WHEN ${tools.isFeatured} = 1 THEN 8 ELSE 0 END
      `.as('score'),
    })
    .from(tools)
    .leftJoin(badgeDisplays, eq(badgeDisplays.toolId, tools.id))
    .where(eq(tools.status, 'approved'));
} else {
  toolsQuery = db
    .select({
      id: tools.id,
      slug: tools.slug,
      name: tools.name,
      url: tools.url,
      description: tools.description,
      status: tools.status,
      approvedAt: tools.approvedAt,
      archiveUrl: tools.archiveUrl,
      isFeatured: tools.isFeatured,
      featuredAt: tools.featuredAt,
    })
    .from(tools)
    .where(eq(tools.status, 'approved'));
}

// Execute query and apply filters in-memory for simplicity with D1
let allTools = await toolsQuery;

// Apply search filter
if (query) {
  const q = query.toLowerCase();
  allTools = allTools.filter(
    (t) =>
      t.name.toLowerCase().includes(q) ||
      (t.description && t.description.toLowerCase().includes(q))
  );
}

// Get tags for all tools
const allToolIds = allTools.map((t) => t.id);
let toolTags: { toolId: number; tagKey: string; tagValue: string }[] = [];
if (allToolIds.length > 0) {
  toolTags = await db
    .select({
      toolId: tags.toolId,
      tagKey: tags.tagKey,
      tagValue: tags.tagValue,
    })
    .from(tags)
    .where(inArray(tags.toolId, allToolIds));
}

// Build tag map
const tagMap = new Map<number, { tagKey: string; tagValue: string }[]>();
for (const tag of toolTags) {
  if (!tagMap.has(tag.toolId)) tagMap.set(tag.toolId, []);
  tagMap.get(tag.toolId)!.push({ tagKey: tag.tagKey, tagValue: tag.tagValue });
}

// Apply tag filters
if (activeFilters.length > 0) {
  allTools = allTools.filter((t) => {
    const tTags = tagMap.get(t.id) || [];
    return activeFilters.every((filter) =>
      tTags.some(
        (tag) => tag.tagKey === filter.key && tag.tagValue === filter.value
      )
    );
  });
}

// Get recent health checks for each tool (up to HEALTH_TOLERANCE per tool)
let healthMap = new Map<
  number,
  { isOnline: boolean; checkedAt: Date }
>();
if (allToolIds.length > 0) {
  const latestChecks = await db
    .select({
      toolId: healthChecks.toolId,
      isOnline: healthChecks.isOnline,
      checkedAt: healthChecks.checkedAt,
    })
    .from(healthChecks)
    .where(inArray(healthChecks.toolId, allToolIds))
    .orderBy(desc(healthChecks.checkedAt));

  const checksPerTool = new Map<number, { isOnline: boolean; checkedAt: Date }[]>();
  for (const check of latestChecks) {
    const arr = checksPerTool.get(check.toolId) || [];
    if (arr.length < HEALTH_TOLERANCE) {
      arr.push({ isOnline: check.isOnline, checkedAt: check.checkedAt });
      checksPerTool.set(check.toolId, arr);
    }
  }

  for (const [toolId, checks] of checksPerTool) {
    const effectiveStatus = resolveEffectiveStatus(checks);
    if (effectiveStatus !== null) {
      healthMap.set(toolId, {
        isOnline: effectiveStatus,
        checkedAt: checks[0].checkedAt,
      });
    }
  }
}

// Sort
if (sort === 'newest') {
  allTools.sort((a, b) => {
    const aTime = a.approvedAt ? a.approvedAt.getTime() : 0;
    const bTime = b.approvedAt ? b.approvedAt.getTime() : 0;
    return bTime - aTime;
  });
} else if (sort === 'alpha') {
  allTools.sort((a, b) => a.name.localeCompare(b.name));
} else {
  // recommended - sort by score
  allTools.sort((a, b) => {
    const aScore = 'score' in a ? (a as any).score : 0;
    const bScore = 'score' in b ? (b as any).score : 0;
    return bScore - aScore;
  });
}

// Determine display mode
const hasCategoryFilter = activeFilters.some((f) => f.key === 'category');
const isGroupedMode = !hasCategoryFilter && !query && activeFilters.length === 0;

// Paginate (flat mode only)
const totalTools = allTools.length;
const totalPages = isGroupedMode ? 1 : Math.max(1, Math.ceil(totalTools / perPage));
const pagedTools = isGroupedMode ? allTools : allTools.slice((page - 1) * perPage, page * perPage);

// Build category groups (grouped mode only)
const maxPerGroup = 6;
const categoryDef = TAG_DEFINITIONS.find((d) => d.key === 'category');
const categoryOrder = categoryDef ? categoryDef.values : [];
type ToolType = (typeof allTools)[number];
const categoryGroups: { category: string; tools: ToolType[] }[] = [];

if (isGroupedMode) {
  const groupMap = new Map<string, ToolType[]>();
  for (const cat of categoryOrder) groupMap.set(cat, []);

  for (const tool of allTools) {
    const tTags = tagMap.get(tool.id) || [];
    const catTag = tTags.find((t) => t.tagKey === 'category');
    const cat = catTag ? catTag.tagValue : 'Other';
    if (!groupMap.has(cat)) groupMap.set(cat, []);
    groupMap.get(cat)!.push(tool);
  }

  for (const cat of categoryOrder) {
    const tools = groupMap.get(cat) || [];
    if (tools.length > 0) categoryGroups.push({ category: cat, tools });
  }
  // Add "Other" at the end
  const otherTools = groupMap.get('Other') || [];
  if (otherTools.length > 0) categoryGroups.push({ category: 'Other', tools: otherTools });
}

// Build featured tools list (grouped mode only)
const featuredTools = isGroupedMode
  ? allTools.filter((t) => 'isFeatured' in t && t.isFeatured)
      .sort((a, b) => {
        const aTime = 'featuredAt' in a && a.featuredAt ? (a.featuredAt as Date).getTime() : 0;
        const bTime = 'featuredAt' in b && b.featuredAt ? (b.featuredAt as Date).getTime() : 0;
        return bTime - aTime;
      })
  : [];

// Build pagination URL helper
function buildUrl(params: Record<string, string>) {
  const u = new URL(url);
  for (const [k, v] of Object.entries(params)) {
    if (v) {
      u.searchParams.set(k, v);
    } else {
      u.searchParams.delete(k);
    }
  }
  return u.pathname + u.search;
}
---

<Layout title="Home">
  <div class="max-w-6xl mx-auto px-6 py-12">
    <!-- Hero -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold tracking-tight mb-3">nologin.tools</h1>
      <p class="text-lg text-neutral-500 mb-4">
        Discover tools that respect your privacy — no login required.
      </p>
      <a href="/badge/nologin-tools" class="inline-block mb-8">
        <img src="/badges/for-the-badge.svg" alt="NoLogin Verified" title="Verified by nologin.tools" />
      </a>

      <!-- Search -->
      <form method="GET" action="/" class="max-w-xl mx-auto mb-8">
        {activeFilters.map((f) => (
          <input type="hidden" name={f.key} value={f.value} />
        ))}
        <input type="hidden" name="sort" value={sort} />
        <div class="relative">
          <svg
            class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"
            width="18"
            height="18"
            viewBox="0 0 20 20"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="9" cy="9" r="6"></circle>
            <path d="M13.5 13.5L17 17"></path>
          </svg>
          <input
            type="text"
            name="q"
            value={query}
            placeholder="Search tools..."
            class:list={[
              "w-full pl-10 py-2.5 border border-neutral-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",
              query ? "pr-9" : "pr-4",
            ]}
          />
          {query && (
            <a
              href={buildUrl({ q: '', page: '' })}
              class="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 hover:text-neutral-600 transition-colors"
              aria-label="Clear search"
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4l8 8M12 4l-8 8" />
              </svg>
            </a>
          )}
        </div>
      </form>
    </div>

    <!-- Category Filter -->
    {(() => {
      const categoryDef = TAG_DEFINITIONS.find((d) => d.key === 'category');
      if (!categoryDef) return null;
      return (
        <div class="mb-4 overflow-x-auto">
          <div class="flex flex-wrap gap-2">
            {categoryDef.values.map((val) => {
              const isActive = activeFilters.some(
                (f) => f.key === 'category' && f.value === val
              );
              const toggleUrl = isActive
                ? buildUrl({ category: '', page: '' })
                : buildUrl({ category: val, page: '' });
              return (
                <a
                  href={toggleUrl}
                  class:list={['chip', isActive ? 'chip-active' : 'chip-category']}
                >
                  {val}
                </a>
              );
            })}
          </div>
        </div>
      );
    })()}

    <!-- Active Filters -->
    {activeFilters.length > 0 && (
      <div class="flex flex-wrap items-center gap-2 mb-4">
        {activeFilters.map((f) => {
          const def = TAG_DEFINITIONS.find((d) => d.key === f.key);
          const label = f.key === 'category' ? f.value : `${def?.label || f.key}: ${f.value}`;
          return (
            <a
              href={buildUrl({ [f.key]: '', page: '' })}
              class="chip chip-active gap-1"
            >
              {label}
              <svg class="w-3 h-3" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3l6 6M9 3l-6 6" />
              </svg>
            </a>
          );
        })}
        {activeFilters.length > 1 && (
          <a href={buildUrl(Object.fromEntries([...activeFilters.map((f) => [f.key, '']), ['page', '']]))} class="text-xs text-neutral-400 hover:text-neutral-600 transition-colors">
            Clear all
          </a>
        )}
      </div>
    )}

    <!-- More Filters (collapsed by default, auto-expand when non-category filters active) -->
    {(() => {
      const nonCategoryDefs = TAG_DEFINITIONS.filter((def) => def.key !== 'category');
      const hasNonCategoryFilter = activeFilters.some((f) => f.key !== 'category');
      return (
        <div class="mb-6">
          <button
            type="button"
            id="more-filters-toggle"
            class="text-sm text-neutral-500 hover:text-neutral-700 transition-colors flex items-center gap-1 mb-3"
          >
            <svg id="more-filters-arrow" class:list={["w-4 h-4 transition-transform", hasNonCategoryFilter && "rotate-90"]} viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
            </svg>
            More filters
          </button>
          <div id="more-filters-panel" class:list={[!hasNonCategoryFilter && "hidden"]}>
            <div class="space-y-2">
              {nonCategoryDefs.map((def) => (
                <div class="flex items-center gap-3">
                  <span class="text-xs text-neutral-400 w-20 shrink-0 text-right">{def.label}</span>
                  <div class="flex flex-wrap gap-1.5">
                    {def.values.map((val) => {
                      const isActive = activeFilters.some(
                        (f) => f.key === def.key && f.value === val
                      );
                      const toggleUrl = isActive
                        ? buildUrl({ [def.key]: '', page: '' })
                        : buildUrl({ [def.key]: val, page: '' });
                      return (
                        <a
                          href={toggleUrl}
                          class:list={['chip', isActive ? 'chip-active' : 'chip-default']}
                        >
                          {val}
                        </a>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    })()}

    <!-- Result Count + Sort -->
    <div class="flex items-center justify-between mb-6 text-sm">
      <span class="text-neutral-500">
        {query
          ? `${totalTools} result${totalTools !== 1 ? 's' : ''} for "${query}"`
          : `${totalTools} tool${totalTools !== 1 ? 's' : ''}`}
      </span>
      <div class="flex items-center gap-2">
        <span class="text-neutral-500">Sort:</span>
        {[
          { key: 'recommended', label: 'Recommended' },
          { key: 'newest', label: 'Newest' },
          { key: 'alpha', label: 'A-Z' },
        ].map((s) => (
          <a
            href={buildUrl({ sort: s.key, page: '' })}
            class:list={[
              'px-3 py-1 rounded-md transition-colors',
              sort === s.key
                ? 'bg-neutral-100 text-neutral-950 font-medium'
                : 'text-neutral-500 hover:text-neutral-950',
            ]}
          >
            {s.label}
          </a>
        ))}
      </div>
    </div>

    {isGroupedMode ? (
      totalTools > 0 ? (
        <div class="space-y-10">
          {featuredTools.length > 0 && (
            <section id="spotlight-carousel" aria-label="Featured tools spotlight">
              <div class="flex items-center justify-between mb-5">
                <h2 class="flex items-center gap-2 text-lg font-semibold text-neutral-950">
                  <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gradient-to-br from-yellow-400 to-amber-500 text-white text-xs">★</span>
                  Featured
                  <span class="text-sm font-normal text-neutral-400">{featuredTools.length}</span>
                </h2>
                {featuredTools.length > 1 && (
                  <div class="flex items-center gap-1">
                    <button
                      type="button"
                      id="spotlight-prev"
                      aria-label="Previous featured tool"
                      class="p-1.5 rounded-lg text-neutral-400 hover:text-neutral-700 hover:bg-neutral-100 transition-colors"
                    >
                      <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                      </svg>
                    </button>
                    <button
                      type="button"
                      id="spotlight-next"
                      aria-label="Next featured tool"
                      class="p-1.5 rounded-lg text-neutral-400 hover:text-neutral-700 hover:bg-neutral-100 transition-colors"
                    >
                      <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </div>
                )}
              </div>
              <div class="spotlight-track" aria-live="polite">
                {featuredTools.map((tool, i) => {
                  const health = healthMap.get(tool.id);
                  const tTags = tagMap.get(tool.id) || [];
                  const hostname = (() => { try { return new URL(tool.url).hostname; } catch { return ''; } })();
                  const displayTags = tTags.slice(0, 5);
                  return (
                    <div
                      class:list={[
                        'spotlight-slide',
                        i === 0 ? 'spotlight-slide-active' : 'opacity-0',
                      ]}
                      data-slide-index={i}
                    >
                      <div class="relative overflow-hidden border-2 border-yellow-300/80 rounded-2xl bg-gradient-to-br from-amber-50/80 via-yellow-50/40 to-white shadow-[0_0_24px_-6px_rgba(234,179,8,0.15)]">
                        {/* Decorative accents */}
                        <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-bl from-yellow-200/20 to-transparent rounded-bl-full pointer-events-none" />
                        <div class="absolute bottom-0 left-0 w-28 h-28 bg-gradient-to-tr from-amber-100/30 to-transparent rounded-tr-full pointer-events-none" />

                        <div class="relative p-6 sm:p-8">
                          <div class="flex flex-col sm:flex-row gap-5 sm:gap-8">
                            {/* Icon column */}
                            <div class="flex sm:flex-col items-center sm:items-center gap-3 sm:gap-3 shrink-0">
                              <div class="w-14 h-14 rounded-xl bg-white shadow-sm border border-neutral-100/80 flex items-center justify-center overflow-hidden">
                                <img
                                  src={`https://www.google.com/s2/favicons?domain=${hostname}&sz=64`}
                                  alt=""
                                  width="40"
                                  height="40"
                                  class="w-10 h-10 object-contain"
                                  loading="lazy"
                                  onerror={`this.style.display='none';this.nextElementSibling.style.display='flex'`}
                                />
                                <span class="w-10 h-10 rounded-lg bg-gradient-to-br from-yellow-100 to-amber-100 text-amber-600 text-lg font-bold items-center justify-center hidden">
                                  {tool.name.charAt(0).toUpperCase()}
                                </span>
                              </div>
                              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-semibold tracking-wide uppercase bg-yellow-100/80 text-yellow-700 border border-yellow-200/60">
                                ★ Featured
                              </span>
                            </div>

                            {/* Content */}
                            <div class="flex-1 min-w-0">
                              <div class="mb-1">
                                <a href={`/tool/${tool.slug}`} class="text-xl font-bold text-neutral-950 hover:text-green-600 transition-colors">
                                  {tool.name}
                                </a>
                              </div>
                              <div class="flex items-center gap-2 mb-3">
                                <span class="text-xs text-neutral-400 truncate">{hostname}</span>
                                {health && (
                                  <span class:list={['inline-flex items-center gap-1 text-xs', health.isOnline ? 'text-green-600' : 'text-red-500']}>
                                    <span class:list={['w-1.5 h-1.5 rounded-full', health.isOnline ? 'bg-green-500' : 'bg-red-500']} />
                                    {health.isOnline ? 'Online' : 'Offline'}
                                  </span>
                                )}
                              </div>
                              {tool.description && (
                                <p class="text-neutral-600 text-sm leading-relaxed mb-4 line-clamp-3 sm:line-clamp-none">
                                  {tool.description}
                                </p>
                              )}
                              <div class="flex flex-wrap items-center gap-1.5">
                                {displayTags.map((tag) => (
                                  <span class:list={['chip text-xs', tag.tagKey === 'category' ? 'chip-category' : 'chip-default cursor-default']}>
                                    {tag.tagKey === 'category' ? tag.tagValue : `${tag.tagKey}: ${tag.tagValue}`}
                                  </span>
                                ))}
                                <span class="inline-flex items-center gap-1 text-xs text-green-600 font-medium ml-1">
                                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                                    <circle cx="6" cy="6" r="6" fill="#22c55e" />
                                    <path d="M3.5 6L5.5 8L8.5 4" stroke="white" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                                  </svg>
                                  Verified
                                </span>
                              </div>
                            </div>

                            {/* CTA */}
                            <div class="shrink-0 flex items-center">
                              <a
                                href={tool.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-semibold bg-gradient-to-r from-yellow-500 to-amber-500 text-white shadow-sm hover:shadow-md hover:from-yellow-600 hover:to-amber-600 transition-all"
                              >
                                Visit Tool
                                <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M5.22 14.78a.75.75 0 010-1.06l7.22-7.22H5.75a.75.75 0 010-1.5h8.5a.75.75 0 01.75.75v8.5a.75.75 0 01-1.5 0V6.56l-7.22 7.22a.75.75 0 01-1.06 0z" clip-rule="evenodd" />
                                </svg>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
              {featuredTools.length > 1 && (
                <div class="flex justify-center gap-2 mt-5" id="spotlight-dots">
                  {featuredTools.map((_, i) => (
                    <button
                      type="button"
                      class:list={['spotlight-dot', i === 0 && 'spotlight-dot-active']}
                      data-dot-index={i}
                      aria-label={`Go to featured tool ${i + 1}`}
                    />
                  ))}
                </div>
              )}
            </section>
          )}
          {categoryGroups.map((group) => (
            <section>
              <div class="flex items-baseline justify-between mb-4">
                <h2 class="text-lg font-semibold text-neutral-950">
                  {group.category}
                  <span class="text-sm font-normal text-neutral-400 ml-2">{group.tools.length}</span>
                </h2>
                {group.tools.length > maxPerGroup && (
                  <a
                    href={buildUrl({ category: group.category, page: '' })}
                    class="text-sm text-blue-600 hover:text-blue-800 transition-colors"
                  >
                    View all {group.tools.length} &rarr;
                  </a>
                )}
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {group.tools.slice(0, maxPerGroup).map((tool) => {
                  const health = healthMap.get(tool.id);
                  const tTags = tagMap.get(tool.id) || [];
                  return (
                    <ToolCard
                      slug={tool.slug}
                      name={tool.name}
                      url={tool.url}
                      description={tool.description}
                      isVerified={tool.status === 'approved'}
                      isOnline={health?.isOnline ?? null}
                      lastCheckedAt={health?.checkedAt ?? null}
                      tags={tTags}
                      archiveUrl={tool.archiveUrl}
                      isFeatured={'isFeatured' in tool && !!tool.isFeatured}
                    />
                  );
                })}
              </div>
            </section>
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <svg class="mx-auto mb-4 text-neutral-300" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="7" />
            <path d="M21 21l-4.35-4.35" stroke-linecap="round" />
          </svg>
          <p class="text-neutral-500 mb-1 font-medium">No tools yet</p>
          <p class="text-sm text-neutral-400 mb-6">Be the first to submit a privacy-friendly tool.</p>
          <a href="/submit" class="btn-primary text-sm">Submit a Tool</a>
        </div>
      )
    ) : (
      pagedTools.length > 0 ? (
        <div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            {pagedTools.map((tool) => {
              const health = healthMap.get(tool.id);
              const tTags = tagMap.get(tool.id) || [];
              return (
                <ToolCard
                  slug={tool.slug}
                  name={tool.name}
                  url={tool.url}
                  description={tool.description}
                  isVerified={tool.status === 'approved'}
                  isOnline={health?.isOnline ?? null}
                  lastCheckedAt={health?.checkedAt ?? null}
                  tags={tTags}
                  archiveUrl={tool.archiveUrl}
                  isFeatured={'isFeatured' in tool && !!tool.isFeatured}
                />
              );
            })}
          </div>
          {totalPages > 1 && (
            <div class="flex justify-center gap-2">
              {page > 1 && (
                <a
                  href={buildUrl({ page: String(page - 1) })}
                  class="btn-secondary text-sm"
                >
                  Previous
                </a>
              )}
              <span class="px-3 py-2 text-sm text-neutral-500">
                Page {page} of {totalPages}
              </span>
              {page < totalPages && (
                <a
                  href={buildUrl({ page: String(page + 1) })}
                  class="btn-secondary text-sm"
                >
                  Next
                </a>
              )}
            </div>
          )}
        </div>
      ) : (
        <div class="text-center py-16">
          <svg class="mx-auto mb-4 text-neutral-300" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="7" />
            <path d="M21 21l-4.35-4.35" stroke-linecap="round" />
          </svg>
          <p class="text-neutral-500 mb-1 font-medium">No tools found</p>
          <p class="text-sm text-neutral-400 mb-6">
            {query
              ? `No results matching "${query}". Try a different search or adjust filters.`
              : 'No tools match the current filters. Try removing some filters.'}
          </p>
          <div class="flex items-center justify-center gap-3">
            <a href="/" class="btn-secondary text-sm">Clear filters</a>
            <a href="/submit" class="btn-primary text-sm">Submit a Tool</a>
          </div>
        </div>
      )
    )}
  </div>
</Layout>

<script>
  const toggle = document.getElementById('more-filters-toggle');
  const panel = document.getElementById('more-filters-panel');
  const arrow = document.getElementById('more-filters-arrow');
  toggle?.addEventListener('click', () => {
    panel?.classList.toggle('hidden');
    arrow?.classList.toggle('rotate-90');
  });

  // Spotlight Carousel
  (function () {
    const carousel = document.getElementById('spotlight-carousel');
    if (!carousel) return;

    const slides = carousel.querySelectorAll<HTMLElement>('[data-slide-index]');
    const dots = carousel.querySelectorAll<HTMLElement>('[data-dot-index]');
    const prevBtn = document.getElementById('spotlight-prev');
    const nextBtn = document.getElementById('spotlight-next');

    if (slides.length <= 1) return;

    let currentIndex = 0;
    let isTransitioning = false;
    let autoplayTimer: ReturnType<typeof setInterval> | null = null;
    const AUTOPLAY_INTERVAL = 5000;
    const TRANSITION_DURATION = 500;

    function goToSlide(nextIndex: number, direction: 'right' | 'left') {
      if (isTransitioning || nextIndex === currentIndex) return;
      isTransitioning = true;

      const currentSlide = slides[currentIndex];
      const nextSlide = slides[nextIndex];

      // Set enter position
      nextSlide.className = 'spotlight-slide ' + (direction === 'right' ? 'spotlight-slide-enter-right' : 'spotlight-slide-enter-left');

      // Force reflow
      void nextSlide.offsetHeight;

      // Transition current out, next in
      currentSlide.className = 'spotlight-slide spotlight-slide-exit';
      nextSlide.className = 'spotlight-slide spotlight-slide-active';

      // Update dots
      dots.forEach((dot, i) => {
        if (i === nextIndex) {
          dot.classList.add('spotlight-dot-active');
        } else {
          dot.classList.remove('spotlight-dot-active');
        }
      });

      setTimeout(() => {
        // Clean up exited slide
        currentSlide.className = 'spotlight-slide opacity-0';
        currentIndex = nextIndex;
        isTransitioning = false;
      }, TRANSITION_DURATION);
    }

    function goNext() {
      const next = (currentIndex + 1) % slides.length;
      goToSlide(next, 'right');
    }

    function goPrev() {
      const prev = (currentIndex - 1 + slides.length) % slides.length;
      goToSlide(prev, 'left');
    }

    function startAutoplay() {
      stopAutoplay();
      autoplayTimer = setInterval(goNext, AUTOPLAY_INTERVAL);
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearInterval(autoplayTimer);
        autoplayTimer = null;
      }
    }

    function restartAutoplay() {
      stopAutoplay();
      startAutoplay();
    }

    // Navigation buttons
    prevBtn?.addEventListener('click', () => { goPrev(); restartAutoplay(); });
    nextBtn?.addEventListener('click', () => { goNext(); restartAutoplay(); });

    // Dot navigation
    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const idx = parseInt(dot.getAttribute('data-dot-index') || '0', 10);
        const direction = idx > currentIndex ? 'right' : 'left';
        goToSlide(idx, direction);
        restartAutoplay();
      });
    });

    // Hover pause
    carousel.addEventListener('mouseenter', stopAutoplay);
    carousel.addEventListener('mouseleave', startAutoplay);

    // Keyboard navigation
    carousel.setAttribute('tabindex', '0');
    carousel.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight') { goNext(); restartAutoplay(); }
      else if (e.key === 'ArrowLeft') { goPrev(); restartAutoplay(); }
    });

    // Tab visibility
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopAutoplay();
      else startAutoplay();
    });

    // Start
    startAutoplay();
  })();
</script>
