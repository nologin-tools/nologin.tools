---
import Layout from '../layouts/Layout.astro';
import ToolCard from '../components/ToolCard.astro';
import { getDb } from '../db';
import { tools, tags, healthChecks, badgeDisplays } from '../db/schema';
import { eq, desc, sql, and, inArray } from 'drizzle-orm';
import { TAG_DEFINITIONS } from '../lib/tags';
import { HEALTH_TOLERANCE, resolveEffectiveStatus } from '../lib/health';

const db = getDb(Astro.locals.runtime.env.DB);

const url = Astro.url;
const query = url.searchParams.get('q') || '';
const sort = url.searchParams.get('sort') || 'recommended';
const page = Math.max(1, parseInt(url.searchParams.get('page') || '1', 10));
const perPage = 24;

// Collect active tag filters
const activeFilters: { key: string; value: string }[] = [];
for (const def of TAG_DEFINITIONS) {
  const val = url.searchParams.get(def.key);
  if (val) {
    activeFilters.push({ key: def.key, value: val });
  }
}

// Build SQL query
let toolsQuery;

if (sort === 'recommended') {
  toolsQuery = db
    .select({
      id: tools.id,
      slug: tools.slug,
      name: tools.name,
      url: tools.url,
      description: tools.description,
      status: tools.status,
      approvedAt: tools.approvedAt,
      archiveUrl: tools.archiveUrl,
      score: sql<number>`
        COALESCE(
          CASE ${badgeDisplays.displayType}
            WHEN 'explicit' THEN 10
            WHEN 'implicit' THEN 5
            ELSE 0
          END, 0
        )
        + CASE
            WHEN ${tools.approvedAt} > unixepoch() - 2592000 THEN 5
            WHEN ${tools.approvedAt} > unixepoch() - 7776000 THEN 3
            ELSE 1
          END
        + COALESCE(
          (SELECT CASE WHEN SUM(sub.is_online) > 0 THEN 3 ELSE 0 END
           FROM (SELECT is_online FROM health_checks WHERE tool_id = ${tools.id}
                 ORDER BY checked_at DESC LIMIT ${HEALTH_TOLERANCE}) sub), 1
        )
      `.as('score'),
    })
    .from(tools)
    .leftJoin(badgeDisplays, eq(badgeDisplays.toolId, tools.id))
    .where(eq(tools.status, 'approved'));
} else {
  toolsQuery = db
    .select({
      id: tools.id,
      slug: tools.slug,
      name: tools.name,
      url: tools.url,
      description: tools.description,
      status: tools.status,
      approvedAt: tools.approvedAt,
      archiveUrl: tools.archiveUrl,
    })
    .from(tools)
    .where(eq(tools.status, 'approved'));
}

// Execute query and apply filters in-memory for simplicity with D1
let allTools = await toolsQuery;

// Apply search filter
if (query) {
  const q = query.toLowerCase();
  allTools = allTools.filter(
    (t) =>
      t.name.toLowerCase().includes(q) ||
      (t.description && t.description.toLowerCase().includes(q))
  );
}

// Get tags for all tools
const allToolIds = allTools.map((t) => t.id);
let toolTags: { toolId: number; tagKey: string; tagValue: string }[] = [];
if (allToolIds.length > 0) {
  toolTags = await db
    .select({
      toolId: tags.toolId,
      tagKey: tags.tagKey,
      tagValue: tags.tagValue,
    })
    .from(tags)
    .where(inArray(tags.toolId, allToolIds));
}

// Build tag map
const tagMap = new Map<number, { tagKey: string; tagValue: string }[]>();
for (const tag of toolTags) {
  if (!tagMap.has(tag.toolId)) tagMap.set(tag.toolId, []);
  tagMap.get(tag.toolId)!.push({ tagKey: tag.tagKey, tagValue: tag.tagValue });
}

// Apply tag filters
if (activeFilters.length > 0) {
  allTools = allTools.filter((t) => {
    const tTags = tagMap.get(t.id) || [];
    return activeFilters.every((filter) =>
      tTags.some(
        (tag) => tag.tagKey === filter.key && tag.tagValue === filter.value
      )
    );
  });
}

// Get recent health checks for each tool (up to HEALTH_TOLERANCE per tool)
let healthMap = new Map<
  number,
  { isOnline: boolean; checkedAt: Date }
>();
if (allToolIds.length > 0) {
  const latestChecks = await db
    .select({
      toolId: healthChecks.toolId,
      isOnline: healthChecks.isOnline,
      checkedAt: healthChecks.checkedAt,
    })
    .from(healthChecks)
    .where(inArray(healthChecks.toolId, allToolIds))
    .orderBy(desc(healthChecks.checkedAt));

  const checksPerTool = new Map<number, { isOnline: boolean; checkedAt: Date }[]>();
  for (const check of latestChecks) {
    const arr = checksPerTool.get(check.toolId) || [];
    if (arr.length < HEALTH_TOLERANCE) {
      arr.push({ isOnline: check.isOnline, checkedAt: check.checkedAt });
      checksPerTool.set(check.toolId, arr);
    }
  }

  for (const [toolId, checks] of checksPerTool) {
    const effectiveStatus = resolveEffectiveStatus(checks);
    if (effectiveStatus !== null) {
      healthMap.set(toolId, {
        isOnline: effectiveStatus,
        checkedAt: checks[0].checkedAt,
      });
    }
  }
}

// Sort
if (sort === 'newest') {
  allTools.sort((a, b) => {
    const aTime = a.approvedAt ? a.approvedAt.getTime() : 0;
    const bTime = b.approvedAt ? b.approvedAt.getTime() : 0;
    return bTime - aTime;
  });
} else if (sort === 'alpha') {
  allTools.sort((a, b) => a.name.localeCompare(b.name));
} else {
  // recommended - sort by score
  allTools.sort((a, b) => {
    const aScore = 'score' in a ? (a as any).score : 0;
    const bScore = 'score' in b ? (b as any).score : 0;
    return bScore - aScore;
  });
}

// Paginate
const totalTools = allTools.length;
const totalPages = Math.max(1, Math.ceil(totalTools / perPage));
const pagedTools = allTools.slice((page - 1) * perPage, page * perPage);

// Build pagination URL helper
function buildUrl(params: Record<string, string>) {
  const u = new URL(url);
  for (const [k, v] of Object.entries(params)) {
    if (v) {
      u.searchParams.set(k, v);
    } else {
      u.searchParams.delete(k);
    }
  }
  return u.pathname + u.search;
}
---

<Layout title="Home">
  <div class="max-w-6xl mx-auto px-6 py-12">
    <!-- Hero -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold tracking-tight mb-3">nologin.tools</h1>
      <p class="text-lg text-neutral-500 mb-4">
        Discover tools that respect your privacy â€” no login required.
      </p>
      <a href="/badge/nologin-tools" class="inline-block mb-8">
        <img src="/badges/for-the-badge.svg" alt="NoLogin Verified" title="Verified by nologin.tools" />
      </a>

      <!-- Search -->
      <form method="GET" action="/" class="max-w-xl mx-auto mb-8">
        {activeFilters.map((f) => (
          <input type="hidden" name={f.key} value={f.value} />
        ))}
        <input type="hidden" name="sort" value={sort} />
        <div class="relative">
          <svg
            class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"
            width="18"
            height="18"
            viewBox="0 0 20 20"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="9" cy="9" r="6"></circle>
            <path d="M13.5 13.5L17 17"></path>
          </svg>
          <input
            type="text"
            name="q"
            value={query}
            placeholder="Search tools..."
            class:list={[
              "w-full pl-10 py-2.5 border border-neutral-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",
              query ? "pr-9" : "pr-4",
            ]}
          />
          {query && (
            <a
              href={buildUrl({ q: '', page: '' })}
              class="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 hover:text-neutral-600 transition-colors"
              aria-label="Clear search"
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4l8 8M12 4l-8 8" />
              </svg>
            </a>
          )}
        </div>
      </form>
    </div>

    <!-- Category Filter -->
    {(() => {
      const categoryDef = TAG_DEFINITIONS.find((d) => d.key === 'category');
      if (!categoryDef) return null;
      return (
        <div class="mb-4 overflow-x-auto">
          <div class="flex flex-wrap gap-2">
            {categoryDef.values.map((val) => {
              const isActive = activeFilters.some(
                (f) => f.key === 'category' && f.value === val
              );
              const toggleUrl = isActive
                ? buildUrl({ category: '', page: '' })
                : buildUrl({ category: val, page: '' });
              return (
                <a
                  href={toggleUrl}
                  class:list={['chip', isActive ? 'chip-active' : 'chip-category']}
                >
                  {val}
                </a>
              );
            })}
          </div>
        </div>
      );
    })()}

    <!-- Active Filters -->
    {activeFilters.length > 0 && (
      <div class="flex flex-wrap items-center gap-2 mb-4">
        {activeFilters.map((f) => {
          const def = TAG_DEFINITIONS.find((d) => d.key === f.key);
          const label = f.key === 'category' ? f.value : `${def?.label || f.key}: ${f.value}`;
          return (
            <a
              href={buildUrl({ [f.key]: '', page: '' })}
              class="chip chip-active gap-1"
            >
              {label}
              <svg class="w-3 h-3" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3l6 6M9 3l-6 6" />
              </svg>
            </a>
          );
        })}
        {activeFilters.length > 1 && (
          <a href={buildUrl(Object.fromEntries([...activeFilters.map((f) => [f.key, '']), ['page', '']]))} class="text-xs text-neutral-400 hover:text-neutral-600 transition-colors">
            Clear all
          </a>
        )}
      </div>
    )}

    <!-- More Filters (collapsed by default, auto-expand when non-category filters active) -->
    {(() => {
      const nonCategoryDefs = TAG_DEFINITIONS.filter((def) => def.key !== 'category');
      const hasNonCategoryFilter = activeFilters.some((f) => f.key !== 'category');
      return (
        <div class="mb-6">
          <button
            type="button"
            id="more-filters-toggle"
            class="text-sm text-neutral-500 hover:text-neutral-700 transition-colors flex items-center gap-1 mb-3"
          >
            <svg id="more-filters-arrow" class:list={["w-4 h-4 transition-transform", hasNonCategoryFilter && "rotate-90"]} viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
            </svg>
            More filters
          </button>
          <div id="more-filters-panel" class:list={[!hasNonCategoryFilter && "hidden"]}>
            <div class="space-y-2">
              {nonCategoryDefs.map((def) => (
                <div class="flex items-center gap-3">
                  <span class="text-xs text-neutral-400 w-20 shrink-0 text-right">{def.label}</span>
                  <div class="flex flex-wrap gap-1.5">
                    {def.values.map((val) => {
                      const isActive = activeFilters.some(
                        (f) => f.key === def.key && f.value === val
                      );
                      const toggleUrl = isActive
                        ? buildUrl({ [def.key]: '', page: '' })
                        : buildUrl({ [def.key]: val, page: '' });
                      return (
                        <a
                          href={toggleUrl}
                          class:list={['chip', isActive ? 'chip-active' : 'chip-default']}
                        >
                          {val}
                        </a>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    })()}

    <!-- Result Count + Sort -->
    <div class="flex items-center justify-between mb-6 text-sm">
      <span class="text-neutral-500">
        {query
          ? `${totalTools} result${totalTools !== 1 ? 's' : ''} for "${query}"`
          : `${totalTools} tool${totalTools !== 1 ? 's' : ''}`}
      </span>
      <div class="flex items-center gap-2">
        <span class="text-neutral-500">Sort:</span>
        {[
          { key: 'recommended', label: 'Recommended' },
          { key: 'newest', label: 'Newest' },
          { key: 'alpha', label: 'A-Z' },
        ].map((s) => (
          <a
            href={buildUrl({ sort: s.key, page: '' })}
            class:list={[
              'px-3 py-1 rounded-md transition-colors',
              sort === s.key
                ? 'bg-neutral-100 text-neutral-950 font-medium'
                : 'text-neutral-500 hover:text-neutral-950',
            ]}
          >
            {s.label}
          </a>
        ))}
      </div>
    </div>

    <!-- Tool Grid -->
    {pagedTools.length > 0 ? (
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
        {pagedTools.map((tool) => {
          const health = healthMap.get(tool.id);
          const tTags = tagMap.get(tool.id) || [];
          return (
            <ToolCard
              slug={tool.slug}
              name={tool.name}
              url={tool.url}
              description={tool.description}
              isVerified={tool.status === 'approved'}
              isOnline={health?.isOnline ?? null}
              lastCheckedAt={health?.checkedAt ?? null}
              tags={tTags}
              archiveUrl={tool.archiveUrl}
            />
          );
        })}
      </div>
    ) : (
      <div class="text-center py-16">
        <svg class="mx-auto mb-4 text-neutral-300" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="11" cy="11" r="7" />
          <path d="M21 21l-4.35-4.35" stroke-linecap="round" />
        </svg>
        <p class="text-neutral-500 mb-1 font-medium">No tools found</p>
        <p class="text-sm text-neutral-400 mb-6">
          {query
            ? `No results matching "${query}". Try a different search or adjust filters.`
            : 'No tools match the current filters. Try removing some filters.'}
        </p>
        <div class="flex items-center justify-center gap-3">
          <a href="/" class="btn-secondary text-sm">Clear filters</a>
          <a href="/submit" class="btn-primary text-sm">Submit a Tool</a>
        </div>
      </div>
    )}

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="flex justify-center gap-2">
        {page > 1 && (
          <a
            href={buildUrl({ page: String(page - 1) })}
            class="btn-secondary text-sm"
          >
            Previous
          </a>
        )}
        <span class="px-3 py-2 text-sm text-neutral-500">
          Page {page} of {totalPages}
        </span>
        {page < totalPages && (
          <a
            href={buildUrl({ page: String(page + 1) })}
            class="btn-secondary text-sm"
          >
            Next
          </a>
        )}
      </div>
    )}
  </div>
</Layout>

<script>
  const toggle = document.getElementById('more-filters-toggle');
  const panel = document.getElementById('more-filters-panel');
  const arrow = document.getElementById('more-filters-arrow');
  toggle?.addEventListener('click', () => {
    panel?.classList.toggle('hidden');
    arrow?.classList.toggle('rotate-90');
  });
</script>
