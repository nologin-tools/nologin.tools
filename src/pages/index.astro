---
import Layout from '../layouts/Layout.astro';
import ToolCard from '../components/ToolCard.astro';
import { getDb } from '../db';
import { tools, tags, healthChecks, badgeDisplays } from '../db/schema';
import { eq, desc, sql, and, inArray } from 'drizzle-orm';
import { TAG_DEFINITIONS } from '../lib/tags';
import { HEALTH_TOLERANCE, resolveEffectiveStatus } from '../lib/health';

const db = getDb(Astro.locals.runtime.env.DB);

const url = Astro.url;
const query = url.searchParams.get('q') || '';
const sort = url.searchParams.get('sort') || 'recommended';
const page = Math.max(1, parseInt(url.searchParams.get('page') || '1', 10));
const perPage = 24;

// Collect active tag filters
const activeFilters: { key: string; value: string }[] = [];
for (const def of TAG_DEFINITIONS) {
  const val = url.searchParams.get(def.key);
  if (val) {
    activeFilters.push({ key: def.key, value: val });
  }
}

// Build SQL query
let toolsQuery;

if (sort === 'recommended') {
  toolsQuery = db
    .select({
      id: tools.id,
      slug: tools.slug,
      name: tools.name,
      url: tools.url,
      description: tools.description,
      status: tools.status,
      approvedAt: tools.approvedAt,
      archiveUrl: tools.archiveUrl,
      isFeatured: tools.isFeatured,
      featuredAt: tools.featuredAt,
      score: sql<number>`
        COALESCE(
          CASE ${badgeDisplays.displayType}
            WHEN 'explicit' THEN 10
            WHEN 'implicit' THEN 5
            ELSE 0
          END, 0
        )
        + CASE
            WHEN ${tools.approvedAt} > unixepoch() - 2592000 THEN 5
            WHEN ${tools.approvedAt} > unixepoch() - 7776000 THEN 3
            ELSE 1
          END
        + COALESCE(
          (SELECT CASE WHEN SUM(sub.is_online) > 0 THEN 3 ELSE 0 END
           FROM (SELECT is_online FROM health_checks WHERE tool_id = ${tools.id}
                 ORDER BY checked_at DESC LIMIT ${HEALTH_TOLERANCE}) sub), 1
        )
        + CASE WHEN ${tools.isFeatured} = 1 THEN 8 ELSE 0 END
      `.as('score'),
    })
    .from(tools)
    .leftJoin(badgeDisplays, eq(badgeDisplays.toolId, tools.id))
    .where(eq(tools.status, 'approved'));
} else {
  toolsQuery = db
    .select({
      id: tools.id,
      slug: tools.slug,
      name: tools.name,
      url: tools.url,
      description: tools.description,
      status: tools.status,
      approvedAt: tools.approvedAt,
      archiveUrl: tools.archiveUrl,
      isFeatured: tools.isFeatured,
      featuredAt: tools.featuredAt,
    })
    .from(tools)
    .where(eq(tools.status, 'approved'));
}

// Execute query and apply filters in-memory for simplicity with D1
let allTools = await toolsQuery;

// Apply search filter
if (query) {
  const q = query.toLowerCase();
  allTools = allTools.filter(
    (t) =>
      t.name.toLowerCase().includes(q) ||
      (t.description && t.description.toLowerCase().includes(q))
  );
}

// Get tags for all tools
const allToolIds = allTools.map((t) => t.id);
let toolTags: { toolId: number; tagKey: string; tagValue: string }[] = [];
if (allToolIds.length > 0) {
  toolTags = await db
    .select({
      toolId: tags.toolId,
      tagKey: tags.tagKey,
      tagValue: tags.tagValue,
    })
    .from(tags)
    .where(inArray(tags.toolId, allToolIds));
}

// Build tag map
const tagMap = new Map<number, { tagKey: string; tagValue: string }[]>();
for (const tag of toolTags) {
  if (!tagMap.has(tag.toolId)) tagMap.set(tag.toolId, []);
  tagMap.get(tag.toolId)!.push({ tagKey: tag.tagKey, tagValue: tag.tagValue });
}

// Apply tag filters
if (activeFilters.length > 0) {
  allTools = allTools.filter((t) => {
    const tTags = tagMap.get(t.id) || [];
    return activeFilters.every((filter) =>
      tTags.some(
        (tag) => tag.tagKey === filter.key && tag.tagValue === filter.value
      )
    );
  });
}

// Get recent health checks for each tool (up to HEALTH_TOLERANCE per tool)
let healthMap = new Map<
  number,
  { isOnline: boolean; checkedAt: Date }
>();
if (allToolIds.length > 0) {
  const latestChecks = await db
    .select({
      toolId: healthChecks.toolId,
      isOnline: healthChecks.isOnline,
      checkedAt: healthChecks.checkedAt,
    })
    .from(healthChecks)
    .where(inArray(healthChecks.toolId, allToolIds))
    .orderBy(desc(healthChecks.checkedAt));

  const checksPerTool = new Map<number, { isOnline: boolean; checkedAt: Date }[]>();
  for (const check of latestChecks) {
    const arr = checksPerTool.get(check.toolId) || [];
    if (arr.length < HEALTH_TOLERANCE) {
      arr.push({ isOnline: check.isOnline, checkedAt: check.checkedAt });
      checksPerTool.set(check.toolId, arr);
    }
  }

  for (const [toolId, checks] of checksPerTool) {
    const effectiveStatus = resolveEffectiveStatus(checks);
    if (effectiveStatus !== null) {
      healthMap.set(toolId, {
        isOnline: effectiveStatus,
        checkedAt: checks[0].checkedAt,
      });
    }
  }
}

// Sort
if (sort === 'newest') {
  allTools.sort((a, b) => {
    const aTime = a.approvedAt ? a.approvedAt.getTime() : 0;
    const bTime = b.approvedAt ? b.approvedAt.getTime() : 0;
    return bTime - aTime;
  });
} else if (sort === 'alpha') {
  allTools.sort((a, b) => a.name.localeCompare(b.name));
} else {
  // recommended - sort by score
  allTools.sort((a, b) => {
    const aScore = 'score' in a ? (a as any).score : 0;
    const bScore = 'score' in b ? (b as any).score : 0;
    return bScore - aScore;
  });
}

// Determine display mode
const hasCategoryFilter = activeFilters.some((f) => f.key === 'category');
const isGroupedMode = !hasCategoryFilter && !query && activeFilters.length === 0;

// Paginate (flat mode only)
const totalTools = allTools.length;
const totalPages = isGroupedMode ? 1 : Math.max(1, Math.ceil(totalTools / perPage));
const pagedTools = isGroupedMode ? allTools : allTools.slice((page - 1) * perPage, page * perPage);

// Build category groups (grouped mode only)
const maxPerGroup = 6;
const categoryDef = TAG_DEFINITIONS.find((d) => d.key === 'category');
const categoryOrder = categoryDef ? categoryDef.values : [];
type ToolType = (typeof allTools)[number];
const categoryGroups: { category: string; tools: ToolType[] }[] = [];

if (isGroupedMode) {
  const groupMap = new Map<string, ToolType[]>();
  for (const cat of categoryOrder) groupMap.set(cat, []);

  for (const tool of allTools) {
    const tTags = tagMap.get(tool.id) || [];
    const catTag = tTags.find((t) => t.tagKey === 'category');
    const cat = catTag ? catTag.tagValue : 'Other';
    if (!groupMap.has(cat)) groupMap.set(cat, []);
    groupMap.get(cat)!.push(tool);
  }

  for (const cat of categoryOrder) {
    const tools = groupMap.get(cat) || [];
    if (tools.length > 0) categoryGroups.push({ category: cat, tools });
  }
  // Add "Other" at the end
  const otherTools = groupMap.get('Other') || [];
  if (otherTools.length > 0) categoryGroups.push({ category: 'Other', tools: otherTools });
}

// Build featured tools list (grouped mode only)
const featuredTools = isGroupedMode
  ? allTools.filter((t) => 'isFeatured' in t && t.isFeatured)
      .sort((a, b) => {
        const aTime = 'featuredAt' in a && a.featuredAt ? (a.featuredAt as Date).getTime() : 0;
        const bTime = 'featuredAt' in b && b.featuredAt ? (b.featuredAt as Date).getTime() : 0;
        return bTime - aTime;
      })
  : [];

// Build recently added tools list (grouped mode only)
const RECENT_TOOLS_COUNT = 8;
const recentTools = isGroupedMode
  ? [...allTools]
      .filter((t) => t.approvedAt)
      .sort((a, b) => {
        const aTime = a.approvedAt ? a.approvedAt.getTime() : 0;
        const bTime = b.approvedAt ? b.approvedAt.getTime() : 0;
        return bTime - aTime;
      })
      .slice(0, RECENT_TOOLS_COUNT)
  : [];

// Build pagination URL helper
function buildUrl(params: Record<string, string>) {
  const u = new URL(url);
  for (const [k, v] of Object.entries(params)) {
    if (v) {
      u.searchParams.set(k, v);
    } else {
      u.searchParams.delete(k);
    }
  }
  return u.pathname + u.search;
}
---

<Layout title="Home">
  {/* Hero Background Elements */}
  <div class="absolute top-0 inset-x-0 h-[32rem] pointer-events-none -z-10 overflow-hidden">
    <div class="absolute -top-24 -left-24 w-96 h-96 bg-green-100/30 blur-3xl rounded-full"></div>
    <div class="absolute top-48 -right-48 w-80 h-80 bg-blue-100/20 blur-3xl rounded-full"></div>
    <div class="absolute top-0 inset-x-0 h-full opacity-[0.03] [mask-image:linear-gradient(to_bottom,black,transparent)]" style="background-image: radial-gradient(#000 0.5px, transparent 0.5px); background-size: 24px 24px;"></div>
  </div>

  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-10 sm:py-24">
    <!-- Hero -->
    <div class="text-center mb-12 sm:mb-16 relative">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-50 border border-green-100/50 text-green-700 text-[10px] sm:text-xs font-bold uppercase tracking-wider mb-4 sm:mb-6 shadow-sm">
        <span class="flex h-2 w-2 relative">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
        </span>
        Privacy First Tools
      </div>
      <h1 class="text-4xl sm:text-6xl font-black tracking-tight text-neutral-900 mb-4 sm:mb-6 [text-wrap:balance]">
        Discover <span class="text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-500">Respectful</span> Tools
      </h1>
      <p class="text-base sm:text-xl text-neutral-500 max-w-2xl mx-auto mb-8 sm:mb-10 leading-relaxed px-2">
        The curated directory of high-quality tools that respect your privacy â€” no login, no tracking, just utility.
      </p>
      
      <div class="flex items-center justify-center gap-4 mb-8 sm:mb-12">
        <a href="/badge/nologin-tools" class="inline-block transition-transform hover:scale-105 active:scale-95 shadow-md rounded-lg">
          <img src="/badges/for-the-badge.svg" alt="NoLogin Verified" title="Verified by nologin.tools" class="h-8 sm:h-auto" />
        </a>
      </div>

      <!-- Search -->
      <form method="GET" action="/" class="max-w-2xl mx-auto mb-4 group px-2 sm:px-0">
        {activeFilters.map((f) => (
          <input type="hidden" name={f.key} value={f.value} />
        ))}
        <input type="hidden" name="sort" value={sort} />
        <div class="relative">
          <div class="absolute inset-0 bg-green-500/10 blur-xl rounded-2xl opacity-0 group-focus-within:opacity-100 transition-opacity duration-500"></div>
          <div class="relative flex items-center bg-white border border-neutral-200 rounded-2xl shadow-[0_4px_12px_-4px_rgba(0,0,0,0.08)] transition-all duration-300 group-focus-within:border-green-500/50 group-focus-within:shadow-[0_8px_24px_-4px_rgba(34,197,94,0.12)] group-focus-within:-translate-y-0.5">
            <svg
              class="ml-4 sm:ml-5 text-neutral-400 group-focus-within:text-green-500 transition-colors"
              width="18"
              height="18"
              viewBox="0 0 20 20"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
            >
              <circle cx="9" cy="9" r="6"></circle>
              <path d="M13.5 13.5L17 17" stroke-linecap="round"></path>
            </svg>
            <input
              type="text"
              name="q"
              value={query}
              placeholder="Search for tools..."
              class:list={[
                "w-full px-3 sm:px-4 py-3 sm:py-4 bg-transparent rounded-2xl text-sm sm:text-base text-neutral-900 placeholder-neutral-400 focus:outline-none",
                query ? "pr-10" : "pr-4",
              ]}
            />
            {query && (
              <a
                href={buildUrl({ q: '', page: '' })}
                class="absolute right-3 text-neutral-400 hover:text-neutral-600 transition-colors p-1 hover:bg-neutral-100 rounded-full"
                aria-label="Clear search"
              >
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                  <path d="M4 4l8 8M12 4l-8 8" />
                </svg>
              </a>
            )}
          </div>
        </div>
      </form>
    </div>

    <!-- Category Filter -->
    {(() => {
      const categoryDef = TAG_DEFINITIONS.find((d) => d.key === 'category');
      if (!categoryDef) return null;
      return (
        <div class="mb-8 overflow-x-auto pb-4 -mx-4 px-4 sm:mx-0 sm:px-0 scrollbar-hide">
          <div class="flex flex-nowrap sm:flex-wrap items-center sm:justify-center gap-2 sm:gap-3">
            <a
              href={buildUrl({ category: '', page: '' })}
              class:list={['chip chip-toggle shrink-0 text-[11px] sm:text-xs', !activeFilters.some(f => f.key === 'category') ? 'chip-active' : 'chip-default']}
            >
              All Tools
            </a>
            <div class="w-px h-4 bg-neutral-200 mx-1 shrink-0"></div>
            {categoryDef.values.map((val) => {
              const isActive = activeFilters.some(
                (f) => f.key === 'category' && f.value === val
              );
              const toggleUrl = isActive
                ? buildUrl({ category: '', page: '' })
                : buildUrl({ category: val, page: '' });
              return (
                <a
                  href={toggleUrl}
                  class:list={['chip chip-toggle shrink-0 text-[11px] sm:text-xs', isActive ? 'chip-active' : 'chip-default']}
                >
                  {val}
                </a>
              );
            })}
          </div>
        </div>
      );
    })()}

    {/* Active Filters Bar */}
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 sm:gap-6 mb-8 sm:mb-10 pb-6 border-b border-neutral-100">
      <div class="flex flex-wrap items-center gap-2 sm:gap-3">
        {activeFilters.length > 0 ? (
          <>
            <span class="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mr-1">Filtered by:</span>
            {activeFilters.map((f) => {
              const def = TAG_DEFINITIONS.find((d) => d.key === f.key);
              const label = f.key === 'category' ? f.value : `${def?.label || f.key}: ${f.value}`;
              return (
                <a
                  href={buildUrl({ [f.key]: '', page: '' })}
                  class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-neutral-900 text-white text-[10px] font-medium hover:bg-neutral-800 transition-colors shadow-sm"
                >
                  {label}
                  <svg class="w-2.5 h-2.5" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                    <path d="M3 3l6 6M9 3l-6 6" />
                  </svg>
                </a>
              );
            })}
            <a href={buildUrl(Object.fromEntries([...activeFilters.map((f) => [f.key, '']), ['page', '']]))} class="text-[10px] text-neutral-400 hover:text-neutral-600 underline underline-offset-4 transition-colors px-1">
              Clear all
            </a>
          </>
        ) : (
          <div class="flex items-center gap-2 text-neutral-500">
            <span class="text-xs sm:text-sm font-medium">
              {query
                ? `${totalTools} result${totalTools !== 1 ? 's' : ''} for "${query}"`
                : `${totalTools} curated tools`}
            </span>
          </div>
        )}
      </div>

      <div class="flex items-center gap-3 sm:gap-4 overflow-x-auto sm:overflow-visible pb-2 sm:pb-0 scrollbar-hide">
        <div class="flex items-center gap-1 p-1 bg-neutral-100/50 rounded-xl border border-neutral-200/50 shrink-0">
          {[
            { key: 'recommended', label: 'Best' },
            { key: 'newest', label: 'New' },
            { key: 'alpha', label: 'A-Z' },
          ].map((s) => (
            <a
              href={buildUrl({ sort: s.key, page: '' })}
              class:list={[
                'px-3 sm:px-4 py-1.5 rounded-lg text-[10px] sm:text-xs font-bold transition-all duration-200',
                sort === s.key
                  ? 'bg-white text-neutral-900 shadow-sm ring-1 ring-neutral-200'
                  : 'text-neutral-500 hover:text-neutral-900 hover:bg-white/50',
              ]}
            >
              {s.label}
            </a>
          ))}
        </div>
        
        {/* More Filters Toggle */}
        <button
          type="button"
          id="more-filters-toggle"
          class:list={[
            "inline-flex items-center gap-2 px-3 py-1.5 rounded-xl text-[10px] sm:text-xs font-bold border transition-all shrink-0",
            activeFilters.some(f => f.key !== 'category') 
              ? "bg-green-50 text-green-700 border-green-200" 
              : "bg-white text-neutral-600 border-neutral-200 hover:bg-neutral-50"
          ]}
        >
          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line>
          </svg>
          Filters
        </button>
      </div>
    </div>

    {/* More Filters Panel (Slide Down) */}
    <div id="more-filters-panel" class:list={["mb-10 p-6 bg-neutral-50 border border-neutral-200 rounded-2xl overflow-hidden transition-all duration-300", !activeFilters.some(f => f.key !== 'category') && "hidden"]}>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        {TAG_DEFINITIONS.filter((def) => def.key !== 'category').map((def) => (
          <div>
            <h3 class="text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em] mb-4">{def.label}</h3>
            <div class="flex flex-wrap gap-2">
              {def.values.map((val) => {
                const isActive = activeFilters.some(
                  (f) => f.key === def.key && f.value === val
                );
                const toggleUrl = isActive
                  ? buildUrl({ [def.key]: '', page: '' })
                  : buildUrl({ [def.key]: val, page: '' });
                return (
                  <a
                    href={toggleUrl}
                    class:list={['chip text-[11px] px-4 py-1.5', isActive ? 'chip-active' : 'chip-default bg-white']}
                  >
                    {val}
                  </a>
                );
              })}
            </div>
          </div>
        ))}
      </div>
    </div>

    {isGroupedMode ? (
      totalTools > 0 ? (
        <div class="space-y-12 sm:space-y-20">
          {featuredTools.length > 0 && (
            <section id="spotlight-carousel" aria-label="Featured tools spotlight" class="relative">
              <div class="flex items-center justify-between mb-6 sm:mb-8">
                <h2 class="flex items-center gap-2 sm:gap-3 text-xl sm:text-2xl font-black text-neutral-900">
                  <span class="inline-flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-xl sm:rounded-2xl bg-gradient-to-br from-yellow-400 to-amber-500 text-white shadow-lg shadow-yellow-200">
                    <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                  </span>
                  Spotlight
                </h2>
                {featuredTools.length > 1 && (
                  <div class="flex items-center gap-2">
                    <button
                      type="button"
                      id="spotlight-prev"
                      aria-label="Previous featured tool"
                      class="p-1.5 sm:p-2 rounded-xl border border-neutral-200 text-neutral-400 hover:text-neutral-900 hover:bg-white hover:border-neutral-300 hover:shadow-sm transition-all active:scale-90"
                    >
                      <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                      </svg>
                    </button>
                    <button
                      type="button"
                      id="spotlight-next"
                      aria-label="Next featured tool"
                      class="p-1.5 sm:p-2 rounded-xl border border-neutral-200 text-neutral-400 hover:text-neutral-900 hover:bg-white hover:border-neutral-300 hover:shadow-sm transition-all active:scale-90"
                    >
                      <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </div>
                )}
              </div>
              <div class="spotlight-track h-auto min-h-[14rem] sm:min-h-[16rem]" aria-live="polite">
                {featuredTools.map((tool, i) => {
                  const health = healthMap.get(tool.id);
                  const tTags = tagMap.get(tool.id) || [];
                  const hostname = (() => { try { return new URL(tool.url).hostname; } catch { return ''; } })();
                  const displayTags = tTags.slice(0, 5);
                  return (
                    <div
                      class:list={[
                        'spotlight-slide',
                        i === 0 ? 'spotlight-slide-active' : 'opacity-0',
                      ]}
                      data-slide-index={i}
                    >
                      <div class="relative overflow-hidden border border-yellow-200/60 rounded-[2rem] sm:rounded-3xl bg-white shadow-[0_20px_50px_-12px_rgba(234,179,8,0.12)]">
                        {/* Decorative background elements */}
                        <div class="absolute top-0 right-0 w-[40%] h-full bg-gradient-to-l from-yellow-50/50 to-transparent pointer-events-none"></div>
                        <div class="absolute -top-24 -right-24 w-64 h-64 bg-yellow-100/40 blur-3xl rounded-full pointer-events-none"></div>

                        <div class="relative p-6 sm:p-10">
                          <div class="flex flex-col md:flex-row gap-6 sm:gap-8 lg:gap-12">
                            {/* Icon column */}
                            <div class="shrink-0 flex items-center md:flex-col md:items-center gap-4 sm:gap-6">
                              <div class="w-16 h-16 sm:w-24 sm:h-24 rounded-2xl sm:rounded-[2rem] bg-white shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-neutral-100 flex items-center justify-center overflow-hidden">
                                <img
                                  src={`https://www.google.com/s2/favicons?domain=${hostname}&sz=128`}
                                  alt=""
                                  width="64"
                                  height="64"
                                  class="w-10 h-10 sm:w-16 sm:h-16 object-contain"
                                  loading="lazy"
                                  onerror={`this.style.display='none';this.nextElementSibling.style.display='flex'`}
                                />
                                <span class="w-full h-full bg-gradient-to-br from-yellow-100 to-amber-100 text-amber-600 text-xl sm:text-3xl font-black items-center justify-center hidden">
                                  {tool.name.charAt(0).toUpperCase()}
                                </span>
                              </div>
                              <div class="md:text-center">
                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[9px] sm:text-[10px] font-black uppercase tracking-widest bg-yellow-100 text-yellow-700 border border-yellow-200/50 shadow-sm">
                                  Featured
                                </span>
                              </div>
                            </div>

                            {/* Content */}
                            <div class="flex-1 min-w-0">
                              <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-2">
                                <a href={`/tool/${tool.slug}`} class="text-2xl sm:text-4xl font-black text-neutral-950 hover:text-green-600 transition-colors">
                                  {tool.name}
                                </a>
                                {health && (
                                  <span class:list={['inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[9px] font-bold uppercase tracking-tight border', health.isOnline ? 'bg-green-50 text-green-700 border-green-200/50' : 'bg-red-50 text-red-700 border-red-200/50']}>
                                    <span class:list={['w-1 h-1 rounded-full', health.isOnline ? 'bg-green-500 animate-pulse' : 'bg-red-500']} />
                                    {health.isOnline ? 'Online' : 'Offline'}
                                  </span>
                                )}
                              </div>
                              <div class="text-xs sm:text-sm text-neutral-400 font-medium mb-4 sm:mb-6 flex items-center gap-2">
                                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                                {hostname}
                              </div>
                              {tool.description && (
                                <p class="text-sm sm:text-lg text-neutral-600 leading-relaxed mb-6 sm:mb-8 max-w-3xl line-clamp-2 md:line-clamp-3">
                                  {tool.description}
                                </p>
                              )}
                              <div class="flex flex-wrap items-center gap-2 mb-6 sm:mb-8">
                                {displayTags.map((tag) => (
                                  <span class:list={['chip text-[9px] px-2.5 py-1 uppercase tracking-wider', tag.tagKey === 'category' ? 'chip-category' : 'chip-default cursor-default']}>
                                    {tag.tagKey === 'category' ? tag.tagValue : tag.tagValue}
                                  </span>
                                ))}
                                <div class="hidden sm:block h-4 w-px bg-neutral-200 mx-2"></div>
                                <span class="inline-flex items-center gap-1 text-[10px] sm:text-xs text-green-600 font-black uppercase tracking-tight">
                                  <div class="w-3.5 h-3.5 sm:w-4 sm:h-4 rounded-full bg-green-500 flex items-center justify-center">
                                    <svg width="10" height="10" viewBox="0 0 12 12" fill="none">
                                      <path d="M3.5 6L5.5 8L8.5 4" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                  </div>
                                  Verified
                                </span>
                              </div>
                              
                              <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                                <a
                                  href={tool.url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  class="btn-primary w-full sm:w-auto justify-center"
                                >
                                  Visit Website
                                  <svg class="ml-2 w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.22 14.78a.75.75 0 010-1.06l7.22-7.22H5.75a.75.75 0 010-1.5h8.5a.75.75 0 01.75.75v8.5a.75.75 0 01-1.5 0V6.56l-7.22 7.22a.75.75 0 01-1.06 0z" clip-rule="evenodd" />
                                  </svg>
                                </a>
                                <a
                                  href={`/tool/${tool.slug}`}
                                  class="btn-secondary w-full sm:w-auto justify-center"
                                >
                                  View Details
                                </a>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
              {featuredTools.length > 1 && (
                <div class="flex justify-center gap-2 sm:gap-3 mt-6 sm:mt-8" id="spotlight-dots">
                  {featuredTools.map((_, i) => (
                    <button
                      type="button"
                      class:list={['spotlight-dot', i === 0 && 'spotlight-dot-active']}
                      data-dot-index={i}
                      aria-label={`Go to featured tool ${i + 1}`}
                    />
                  ))}
                </div>
              )}
            </section>
          )}

          {recentTools.length > 0 && (
            <section id="recently-added" aria-label="Recently added tools">
              <div class="flex items-end justify-between mb-6 sm:mb-8 pb-4 border-b border-neutral-100">
                <h2 class="text-xl sm:text-2xl font-black text-neutral-900 flex items-center gap-2 sm:gap-3">
                  <span class="inline-flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-xl sm:rounded-2xl bg-gradient-to-br from-green-400 to-emerald-500 text-white shadow-lg shadow-green-200">
                    <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                  </span>
                  Recently Added
                  <span class="inline-flex items-center px-2 py-0.5 rounded-lg bg-green-100 text-green-700 text-[9px] sm:text-[10px] font-black uppercase tracking-wider">New</span>
                </h2>
                <a
                  href={buildUrl({ sort: 'newest', page: '' })}
                  class="text-xs sm:text-sm font-bold text-green-600 hover:text-green-700 transition-colors flex items-center gap-1 group/link"
                >
                  View all
                  <svg class="w-3.5 h-3.5 transition-transform group-hover/link:translate-x-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </a>
              </div>
              <div class="relative group/scroll">
                {/* Left gradient mask */}
                <div id="recent-mask-left" class="hidden absolute left-0 top-0 bottom-0 w-12 sm:w-16 bg-gradient-to-r from-neutral-50/90 to-transparent z-10 pointer-events-none"></div>
                {/* Right gradient mask */}
                <div id="recent-mask-right" class="absolute right-0 top-0 bottom-0 w-12 sm:w-16 bg-gradient-to-l from-neutral-50/90 to-transparent z-10 pointer-events-none"></div>
                {/* Left arrow */}
                <button
                  type="button"
                  id="recent-prev"
                  aria-label="Scroll left"
                  class="hidden sm:flex absolute left-0 top-1/2 -translate-y-1/2 z-20 p-2 rounded-xl bg-white border border-neutral-200 text-neutral-400 shadow-lg opacity-0 group-hover/scroll:opacity-100 hover:text-neutral-900 hover:border-neutral-300 transition-all active:scale-90 disabled:opacity-0"
                >
                  <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                  </svg>
                </button>
                {/* Right arrow */}
                <button
                  type="button"
                  id="recent-next"
                  aria-label="Scroll right"
                  class="hidden sm:flex absolute right-0 top-1/2 -translate-y-1/2 z-20 p-2 rounded-xl bg-white border border-neutral-200 text-neutral-400 shadow-lg opacity-0 group-hover/scroll:opacity-100 hover:text-neutral-900 hover:border-neutral-300 transition-all active:scale-90 disabled:opacity-0"
                >
                  <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                  </svg>
                </button>
                {/* Scroll track */}
                <div id="recent-track" class="flex gap-4 sm:gap-6 overflow-x-auto snap-x snap-mandatory scroll-smooth -mx-4 px-4 sm:mx-0 sm:px-0 pb-2 scrollbar-hide">
                  {recentTools.map((tool) => {
                    const health = healthMap.get(tool.id);
                    const tTags = tagMap.get(tool.id) || [];
                    return (
                      <div class="w-[280px] sm:w-[320px] shrink-0 snap-start">
                        <ToolCard
                          slug={tool.slug}
                          name={tool.name}
                          url={tool.url}
                          description={tool.description}
                          isVerified={tool.status === 'approved'}
                          isOnline={health?.isOnline ?? null}
                          lastCheckedAt={health?.checkedAt ?? null}
                          tags={tTags}
                          archiveUrl={tool.archiveUrl}
                          isFeatured={'isFeatured' in tool && !!tool.isFeatured}
                        />
                      </div>
                    );
                  })}
                </div>
              </div>
            </section>
          )}

          {categoryGroups.map((group) => (
            <section class="relative">
              <div class="flex items-end justify-between mb-6 sm:mb-8 pb-4 border-b border-neutral-100">
                <h2 class="text-xl sm:text-2xl font-black text-neutral-900 flex items-center gap-2 sm:gap-3">
                  {group.category}
                  <span class="inline-flex items-center justify-center px-2 py-0.5 rounded-lg bg-neutral-100 text-neutral-500 text-[10px] sm:text-xs font-bold">{group.tools.length}</span>
                </h2>
                {group.tools.length > maxPerGroup && (
                  <a
                    href={buildUrl({ category: group.category, page: '' })}
                    class="text-xs sm:text-sm font-bold text-green-600 hover:text-green-700 transition-colors flex items-center gap-1 group/link"
                  >
                    View gallery 
                    <svg class="w-3.5 h-3.5 transition-transform group-hover/link:translate-x-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                  </a>
                )}
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                {group.tools.slice(0, maxPerGroup).map((tool) => {
                  const health = healthMap.get(tool.id);
                  const tTags = tagMap.get(tool.id) || [];
                  return (
                    <ToolCard
                      slug={tool.slug}
                      name={tool.name}
                      url={tool.url}
                      description={tool.description}
                      isVerified={tool.status === 'approved'}
                      isOnline={health?.isOnline ?? null}
                      lastCheckedAt={health?.checkedAt ?? null}
                      tags={tTags}
                      archiveUrl={tool.archiveUrl}
                      isFeatured={'isFeatured' in tool && !!tool.isFeatured}
                    />
                  );
                })}
              </div>
            </section>
          ))}
        </div>
      ) : (
        <div class="text-center py-16 sm:py-24 glass-card rounded-[2rem] sm:rounded-[3rem] px-4">
          <div class="w-16 h-16 sm:w-20 sm:h-20 bg-neutral-100 rounded-2xl sm:rounded-[2rem] flex items-center justify-center mx-auto mb-6">
            <svg class="text-neutral-400" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <circle cx="11" cy="11" r="7" />
              <path d="M21 21l-4.35-4.35" />
            </svg>
          </div>
          <p class="text-lg sm:text-xl text-neutral-900 mb-2 font-black">No tools found yet</p>
          <p class="text-sm sm:text-base text-neutral-500 mb-8 sm:mb-10 max-w-sm mx-auto">Be the first to submit a privacy-friendly tool to this collection.</p>
          <a href="/submit" class="btn-primary w-full sm:w-auto justify-center">Submit a Tool</a>
        </div>
      )
    ) : (
      pagedTools.length > 0 ? (
        <div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-8 sm:mb-12">
            {pagedTools.map((tool) => {
              const health = healthMap.get(tool.id);
              const tTags = tagMap.get(tool.id) || [];
              return (
                <ToolCard
                  slug={tool.slug}
                  name={tool.name}
                  url={tool.url}
                  description={tool.description}
                  isVerified={tool.status === 'approved'}
                  isOnline={health?.isOnline ?? null}
                  lastCheckedAt={health?.checkedAt ?? null}
                  tags={tTags}
                  archiveUrl={tool.archiveUrl}
                  isFeatured={'isFeatured' in tool && !!tool.isFeatured}
                />
              );
            })}
          </div>
          {totalPages > 1 && (
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-6 pt-8 sm:pt-12 border-t border-neutral-100">
              <div class="flex items-center gap-4 order-2 sm:order-1">
                {page > 1 ? (
                  <a
                    href={buildUrl({ page: String(page - 1) })}
                    class="btn-secondary py-2"
                  >
                    <svg class="mr-1 w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                    Prev
                  </a>
                ) : <div class="w-[84px] hidden sm:block"></div>}
                
                <div class="flex items-center gap-1.5">
                  {Array.from({ length: Math.min(3, totalPages) }, (_, i) => {
                     let pageNum = i + 1;
                     if (totalPages > 3 && page > 2) {
                       pageNum = page - 1 + i;
                       if (pageNum > totalPages) pageNum = totalPages - (2 - i);
                     }
                     if (pageNum <= 0) return null;
                     if (pageNum > totalPages) return null;
                     
                     return (
                       <a 
                         href={buildUrl({ page: String(pageNum) })}
                         class:list={[
                           "w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center rounded-xl text-[11px] sm:text-sm font-bold transition-all",
                           page === pageNum 
                             ? "bg-green-600 text-white shadow-lg shadow-green-100" 
                             : "text-neutral-500 hover:bg-neutral-100"
                         ]}
                       >
                         {pageNum}
                       </a>
                     );
                  })}
                </div>

                {page < totalPages ? (
                  <a
                    href={buildUrl({ page: String(page + 1) })}
                    class="btn-secondary py-2"
                  >
                    Next
                    <svg class="ml-1 w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110 2H5.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                  </a>
                ) : <div class="w-[84px] hidden sm:block"></div>}
              </div>
            </div>
          )}
        </div>
      ) : (
        <div class="text-center py-16 sm:py-24 glass-card rounded-[2rem] sm:rounded-[3rem] px-4">
          <div class="w-16 h-16 sm:w-20 sm:h-20 bg-neutral-100 rounded-2xl sm:rounded-[2rem] flex items-center justify-center mx-auto mb-6">
            <svg class="text-neutral-400" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <circle cx="11" cy="11" r="7" />
              <path d="M21 21l-4.35-4.35" />
            </svg>
          </div>
          <p class="text-lg sm:text-xl text-neutral-900 mb-2 font-black">No matches found</p>
          <p class="text-sm sm:text-base text-neutral-500 mb-8 sm:mb-10 max-w-sm mx-auto">
            {query
              ? `We couldn't find anything matching "${query}".`
              : 'No tools match the selected filters.'}
          </p>
          <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
            <a href="/" class="btn-secondary w-full sm:w-auto justify-center">Clear filters</a>
            <a href="/submit" class="btn-primary w-full sm:w-auto justify-center">Submit a Tool</a>
          </div>
        </div>
      )
    )}
  </div>
</Layout>

<script>
  const toggle = document.getElementById('more-filters-toggle');
  const panel = document.getElementById('more-filters-panel');
  const arrow = document.getElementById('more-filters-arrow');
  toggle?.addEventListener('click', () => {
    panel?.classList.toggle('hidden');
    arrow?.classList.toggle('rotate-90');
  });

  // Spotlight Carousel
  (function () {
    const carousel = document.getElementById('spotlight-carousel');
    if (!carousel) return;

    const slides = carousel.querySelectorAll<HTMLElement>('[data-slide-index]');
    const dots = carousel.querySelectorAll<HTMLElement>('[data-dot-index]');
    const prevBtn = document.getElementById('spotlight-prev');
    const nextBtn = document.getElementById('spotlight-next');

    if (slides.length <= 1) return;

    let currentIndex = 0;
    let isTransitioning = false;
    let autoplayTimer: ReturnType<typeof setInterval> | null = null;
    const AUTOPLAY_INTERVAL = 5000;
    const TRANSITION_DURATION = 500;

    function goToSlide(nextIndex: number, direction: 'right' | 'left') {
      if (isTransitioning || nextIndex === currentIndex) return;
      isTransitioning = true;

      const currentSlide = slides[currentIndex];
      const nextSlide = slides[nextIndex];

      // Set enter position
      nextSlide.className = 'spotlight-slide ' + (direction === 'right' ? 'spotlight-slide-enter-right' : 'spotlight-slide-enter-left');

      // Force reflow
      void nextSlide.offsetHeight;

      // Transition current out, next in
      currentSlide.className = 'spotlight-slide spotlight-slide-exit';
      nextSlide.className = 'spotlight-slide spotlight-slide-active';

      // Update dots
      dots.forEach((dot, i) => {
        if (i === nextIndex) {
          dot.classList.add('spotlight-dot-active');
        } else {
          dot.classList.remove('spotlight-dot-active');
        }
      });

      setTimeout(() => {
        // Clean up exited slide
        currentSlide.className = 'spotlight-slide opacity-0';
        currentIndex = nextIndex;
        isTransitioning = false;
      }, TRANSITION_DURATION);
    }

    function goNext() {
      const next = (currentIndex + 1) % slides.length;
      goToSlide(next, 'right');
    }

    function goPrev() {
      const prev = (currentIndex - 1 + slides.length) % slides.length;
      goToSlide(prev, 'left');
    }

    function startAutoplay() {
      stopAutoplay();
      autoplayTimer = setInterval(goNext, AUTOPLAY_INTERVAL);
    }

    function stopAutoplay() {
      if (autoplayTimer) {
        clearInterval(autoplayTimer);
        autoplayTimer = null;
      }
    }

    function restartAutoplay() {
      stopAutoplay();
      startAutoplay();
    }

    // Navigation buttons
    prevBtn?.addEventListener('click', () => { goPrev(); restartAutoplay(); });
    nextBtn?.addEventListener('click', () => { goNext(); restartAutoplay(); });

    // Dot navigation
    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const idx = parseInt(dot.getAttribute('data-dot-index') || '0', 10);
        const direction = idx > currentIndex ? 'right' : 'left';
        goToSlide(idx, direction);
        restartAutoplay();
      });
    });

    // Hover pause
    carousel.addEventListener('mouseenter', stopAutoplay);
    carousel.addEventListener('mouseleave', startAutoplay);

    // Keyboard navigation
    carousel.setAttribute('tabindex', '0');
    carousel.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight') { goNext(); restartAutoplay(); }
      else if (e.key === 'ArrowLeft') { goPrev(); restartAutoplay(); }
    });

    // Tab visibility
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopAutoplay();
      else startAutoplay();
    });

    // Start
    startAutoplay();
  })();

  // Recently Added horizontal scroll
  (function () {
    const track = document.getElementById('recent-track');
    const prevBtn = document.getElementById('recent-prev');
    const nextBtn = document.getElementById('recent-next');
    const maskLeft = document.getElementById('recent-mask-left');
    const maskRight = document.getElementById('recent-mask-right');
    if (!track) return;

    function updateScrollState() {
      const { scrollLeft, scrollWidth, clientWidth } = track!;
      const atStart = scrollLeft <= 0;
      const atEnd = scrollLeft + clientWidth >= scrollWidth - 1;

      if (prevBtn) {
        prevBtn.disabled = atStart;
        prevBtn.classList.toggle('!opacity-0', atStart);
      }
      if (nextBtn) {
        nextBtn.disabled = atEnd;
        nextBtn.classList.toggle('!opacity-0', atEnd);
      }
      maskLeft?.classList.toggle('hidden', atStart);
      maskRight?.classList.toggle('hidden', atEnd);
    }

    function getScrollAmount() {
      const firstCard = track!.querySelector<HTMLElement>(':scope > div');
      if (!firstCard) return 320;
      const gap = parseFloat(getComputedStyle(track!).gap) || 16;
      return firstCard.offsetWidth + gap;
    }

    prevBtn?.addEventListener('click', () => {
      track!.scrollBy({ left: -getScrollAmount(), behavior: 'smooth' });
    });
    nextBtn?.addEventListener('click', () => {
      track!.scrollBy({ left: getScrollAmount(), behavior: 'smooth' });
    });

    track.addEventListener('scroll', updateScrollState, { passive: true });
    window.addEventListener('resize', updateScrollState);
    updateScrollState();
  })();
</script>
