---
import Layout from '../../layouts/Layout.astro';
import HealthBadge from '../../components/HealthBadge.astro';
import { getDb } from '../../db';
import { tools, tags, healthChecks, badgeDisplays } from '../../db/schema';
import { eq, desc, and, ne, inArray } from 'drizzle-orm';
import { formatDate } from '../../lib/utils';
import { getBadgeEmbedCode } from '../../lib/badge';
import { sortTagsCategoryFirst } from '../../lib/tags';

const { slug } = Astro.params;
const db = getDb(Astro.locals.runtime.env.DB);
const siteUrl = Astro.locals.runtime.env.SITE_URL || 'https://nologin.tools';

// Fetch tool
const [tool] = await db
  .select()
  .from(tools)
  .where(eq(tools.slug, slug!))
  .limit(1);

if (!tool || tool.status !== 'approved') {
  return Astro.redirect('/404');
}

// Fetch tags
const toolTags = await db
  .select({ tagKey: tags.tagKey, tagValue: tags.tagValue })
  .from(tags)
  .where(eq(tags.toolId, tool.id));

// Fetch latest health check
const [latestHealth] = await db
  .select()
  .from(healthChecks)
  .where(eq(healthChecks.toolId, tool.id))
  .orderBy(desc(healthChecks.checkedAt))
  .limit(1);

// Fetch similar tools (same tags, limit 3)
const tagKeys = toolTags.map((t) => t.tagKey);
let similarTools: { slug: string; name: string; description: string | null }[] = [];
if (tagKeys.length > 0) {
  similarTools = await db
    .selectDistinct({
      slug: tools.slug,
      name: tools.name,
      description: tools.description,
    })
    .from(tools)
    .innerJoin(tags, eq(tags.toolId, tools.id))
    .where(
      and(
        eq(tools.status, 'approved'),
        ne(tools.id, tool.id),
        inArray(tags.tagKey, tagKeys)
      )
    )
    .limit(3);
}

const embedCode = getBadgeEmbedCode(slug!, siteUrl);
---

<Layout
  title={`${tool.name} â€” NoLogin Verified`}
  description={`${tool.name} is NoLogin Verified. ${tool.coreTask}`}
>
  <div class="max-w-3xl mx-auto px-6 py-16">
    <!-- Badge header -->
    <div class="text-center mb-10">
      <div class="mb-4">
        <img
          src="/badge.svg"
          alt="NoLogin Verified"
          class="inline-block w-40"
        />
      </div>
      <h1 class="text-2xl font-bold text-green-600 mb-2">
        This tool is NoLogin Verified
      </h1>
    </div>

    <!-- Tool info card -->
    <div class="border border-neutral-200 rounded-lg p-6 mb-8">
      <div class="flex items-start justify-between mb-4">
        <div>
          <h2 class="text-xl font-bold text-neutral-950">{tool.name}</h2>
          <a
            href={tool.url}
            target="_blank"
            rel="noopener noreferrer"
            class="text-sm text-blue-600 hover:underline"
          >
            {tool.url}
          </a>
        </div>
        <HealthBadge
          isOnline={latestHealth?.isOnline ?? null}
          lastCheckedAt={latestHealth?.checkedAt ?? null}
        />
      </div>

      {tool.description && (
        <p class="text-neutral-600 mb-4">{tool.description}</p>
      )}

      <div class="bg-green-50 border border-green-200 rounded-md p-3 mb-4">
        <p class="text-sm text-green-800">
          <span class="font-medium">Core task (no login required):</span>{' '}
          "{tool.coreTask}"
        </p>
      </div>

      <div class="flex flex-wrap gap-4 text-sm text-neutral-500">
        {tool.approvedAt && (
          <span>Verified since {formatDate(tool.approvedAt)}</span>
        )}
      </div>

      {toolTags.length > 0 && (
        <div class="flex flex-wrap gap-1.5 mt-4">
          {sortTagsCategoryFirst(toolTags).map((tag) => (
            <span class:list={['chip text-[11px]', tag.tagKey === 'category' ? 'chip-category' : 'chip-default']}>
              {tag.tagKey === 'category' ? tag.tagValue : `${tag.tagKey}:${tag.tagValue}`}
            </span>
          ))}
        </div>
      )}
    </div>

    <!-- Actions -->
    <div class="flex justify-center gap-3 mb-12">
      <a
        href={tool.url}
        target="_blank"
        rel="noopener noreferrer"
        class="btn-primary"
      >
        Visit Tool
      </a>
      <a href={`/tool/${slug}`} class="btn-secondary">View Full Details</a>
    </div>

    <!-- What is NoLogin Verified -->
    <section class="mb-12">
      <h2 class="text-lg font-semibold text-neutral-950 mb-3">
        What is NoLogin Verified?
      </h2>
      <p class="text-neutral-600 text-sm leading-relaxed">
        The NoLogin Verified badge means this tool has been reviewed and
        confirmed by{' '}
        <a href="/" class="text-blue-600 hover:underline">nologin.tools</a>{' '}
        to provide its core functionality without requiring user registration or
        login. We continuously monitor the availability of verified tools.{' '}
        <a href="/badge" class="text-blue-600 hover:underline">Learn more</a>.
      </p>
    </section>

    <!-- Similar tools -->
    {similarTools.length > 0 && (
      <section>
        <h2 class="text-lg font-semibold text-neutral-950 mb-3">
          Similar Tools
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          {similarTools.map((st) => (
            <a
              href={`/tool/${st.slug}`}
              class="border border-neutral-200 rounded-lg p-4 hover:shadow-md transition-all"
            >
              <h3 class="font-semibold text-neutral-950 text-sm mb-1">
                {st.name}
              </h3>
              {st.description && (
                <p class="text-xs text-neutral-500 line-clamp-2">
                  {st.description}
                </p>
              )}
            </a>
          ))}
        </div>
      </section>
    )}
  </div>
</Layout>
