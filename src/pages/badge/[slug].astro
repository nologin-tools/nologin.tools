---
import Layout from '../../layouts/Layout.astro';
import HealthBadge from '../../components/HealthBadge.astro';
import { getDb } from '../../db';
import { tools, tags, healthChecks, badgeDisplays } from '../../db/schema';
import { eq, desc, and, ne, inArray } from 'drizzle-orm';
import { formatDate } from '../../lib/utils';
import { getBadgeEmbedCode, BADGE_STYLES, BADGE_GROUPS, ORIGINAL_BADGE } from '../../lib/badge';
import { sortTagsCategoryFirst } from '../../lib/tags';

const { slug } = Astro.params;
const db = getDb(Astro.locals.runtime.env.DB);
const siteUrl = Astro.locals.runtime.env.SITE_URL || 'https://nologin.tools';

// Fetch tool
const [tool] = await db
  .select()
  .from(tools)
  .where(eq(tools.slug, slug!))
  .limit(1);

if (!tool || tool.status === 'rejected') {
  return Astro.redirect('/404');
}

const isPending = tool.status === 'pending';

// Fetch tags
const toolTags = await db
  .select({ tagKey: tags.tagKey, tagValue: tags.tagValue })
  .from(tags)
  .where(eq(tags.toolId, tool.id));

// Fetch latest health check
const [latestHealth] = await db
  .select()
  .from(healthChecks)
  .where(eq(healthChecks.toolId, tool.id))
  .orderBy(desc(healthChecks.checkedAt))
  .limit(1);

// Fetch similar tools (same tags, limit 3) — only for approved tools
const tagKeys = toolTags.map((t) => t.tagKey);
let similarTools: { slug: string; name: string; description: string | null }[] = [];
if (!isPending && tagKeys.length > 0) {
  similarTools = await db
    .selectDistinct({
      slug: tools.slug,
      name: tools.name,
      description: tools.description,
    })
    .from(tools)
    .innerJoin(tags, eq(tags.toolId, tools.id))
    .where(
      and(
        eq(tools.status, 'approved'),
        ne(tools.id, tool.id),
        inArray(tags.tagKey, tagKeys)
      )
    )
    .limit(3);
}

const embedCode = getBadgeEmbedCode(slug!, siteUrl, 'flat');
const allEmbedCodes = Object.fromEntries(
  [...BADGE_STYLES, ORIGINAL_BADGE].map((s) => [s.id, getBadgeEmbedCode(slug!, siteUrl, s.id)])
);
---

<Layout
  title={`${tool.name} — ${isPending ? 'Pending Verification' : 'NoLogin Verified'}`}
  description={isPending ? `${tool.name} is pending verification.` : `${tool.name} is NoLogin Verified. ${tool.coreTask}`}
>
  <div class="max-w-3xl mx-auto px-6 py-16">
    <!-- Badge brand link -->
    <div class="mb-6">
      <a href="/badge" class="inline-block">
        <img src="/badges/flat.svg" alt="NoLogin Verified" title="Verified by nologin.tools" class="inline-block" />
      </a>
    </div>

    <!-- Tab navigation -->
    <div class="flex border-b border-neutral-200 mb-8" role="tablist">
      <button role="tab" aria-selected="true" aria-controls="panel-verification"
        id="tab-verification"
        class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 border-green-500 text-green-600 -mb-px">
        Verification
      </button>
      <button role="tab" aria-selected="false" aria-controls="panel-embed"
        id="tab-embed"
        class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-neutral-500 hover:text-neutral-700 -mb-px">
        Embed Code
      </button>
    </div>

    <!-- Panel: Verification (default visible) -->
    <div id="panel-verification" role="tabpanel" aria-labelledby="tab-verification">

    <!-- Certificate Hero -->
    <div class="text-center mb-10">
      {isPending ? (
        <svg class="mx-auto mb-4" width="72" height="72" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Verification Pending">
          <path d="M36 4L8 18v18c0 16.6 11.9 32.1 28 36 16.1-3.9 28-19.4 28-36V18L36 4z" fill="#f59e0b" fill-opacity="0.15" stroke="#f59e0b" stroke-width="2.5"/>
          <circle cx="36" cy="38" r="12" stroke="#f59e0b" stroke-width="2.5" fill="none"/>
          <path d="M36 30v9l6 3" stroke="#f59e0b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
      ) : (
        <svg class="mx-auto mb-4" width="72" height="72" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="NoLogin Verified">
          <path d="M36 4L8 18v18c0 16.6 11.9 32.1 28 36 16.1-3.9 28-19.4 28-36V18L36 4z" fill="#22c55e" fill-opacity="0.15" stroke="#22c55e" stroke-width="2.5"/>
          <path d="M24 37l8 8 16-16" stroke="#22c55e" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
      )}
      <h1 class:list={['text-2xl font-bold', isPending ? 'text-amber-600' : 'text-green-600']}>
        {isPending ? 'Verification Pending' : 'NoLogin Verified'}
      </h1>
    </div>

    <!-- Certificate Details Card -->
    <div class:list={[
      'border rounded-lg p-6 mb-8',
      isPending ? 'border-amber-200 bg-amber-50/30' : 'border-green-200 bg-green-50/30',
    ]}>
      <h2 class="text-xs font-medium uppercase tracking-wide text-neutral-500 mb-4">Certificate Details</h2>
      <dl class="space-y-3 text-sm">
        <div class="flex gap-2">
          <dt class="font-medium text-neutral-500 w-32 shrink-0">Tool</dt>
          <dd class="text-neutral-950 font-semibold">{tool.name}</dd>
        </div>
        <div class="flex gap-2">
          <dt class="font-medium text-neutral-500 w-32 shrink-0">URL</dt>
          <dd>
            <a href={tool.url} target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline break-all">{tool.url}</a>
          </dd>
        </div>
        <div class="flex gap-2">
          <dt class="font-medium text-neutral-500 w-32 shrink-0">Core Task</dt>
          <dd class="text-neutral-700">{tool.coreTask}</dd>
        </div>
        {tool.description && (
          <div class="flex gap-2">
            <dt class="font-medium text-neutral-500 w-32 shrink-0">Description</dt>
            <dd class="text-neutral-600">{tool.description}</dd>
          </div>
        )}
        <div class="flex gap-2 items-center">
          <dt class="font-medium text-neutral-500 w-32 shrink-0">Status</dt>
          <dd>
            <span class:list={['status-badge', isPending ? 'status-pending' : 'status-approved']}>
              {isPending ? 'Pending' : 'Approved'}
            </span>
          </dd>
        </div>
        {!isPending && tool.approvedAt && (
          <div class="flex gap-2">
            <dt class="font-medium text-neutral-500 w-32 shrink-0">Verified Since</dt>
            <dd class="text-neutral-700">{formatDate(tool.approvedAt)}</dd>
          </div>
        )}
        {!isPending && (
          <div class="flex gap-2 items-center">
            <dt class="font-medium text-neutral-500 w-32 shrink-0">Availability</dt>
            <dd>
              <HealthBadge
                isOnline={latestHealth?.isOnline ?? null}
                lastCheckedAt={latestHealth?.checkedAt ?? null}
              />
            </dd>
          </div>
        )}
        {tool.archiveUrl && (
          <div class="flex gap-2">
            <dt class="font-medium text-neutral-500 w-32 shrink-0">Web Archive</dt>
            <dd>
              <a href={tool.archiveUrl} target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">View Snapshot</a>
            </dd>
          </div>
        )}
      </dl>

      {toolTags.length > 0 && (
        <div class="flex flex-wrap gap-1.5 mt-5 pt-4 border-t border-neutral-200/60">
          {sortTagsCategoryFirst(toolTags).map((tag) => (
            <span class:list={['chip text-[11px]', tag.tagKey === 'category' ? 'chip-category' : 'chip-default']}>
              {tag.tagKey === 'category' ? tag.tagValue : `${tag.tagKey}:${tag.tagValue}`}
            </span>
          ))}
        </div>
      )}
    </div>

    <!-- Trust Signals Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-10">
      <div class="border border-neutral-200 rounded-lg p-5">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center shrink-0">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 1L3 5v5c0 4.6 3.3 8.9 7 10 3.7-1.1 7-5.4 7-10V5l-7-4z" fill="#22c55e" fill-opacity="0.2" stroke="#22c55e" stroke-width="1.5"/>
              <path d="M7 10.5l2 2 4-4" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-neutral-950">Manually Reviewed</h3>
            <p class="text-xs text-neutral-500 mt-0.5">Each tool is individually reviewed by our team to verify it works without login.</p>
          </div>
        </div>
      </div>
      <div class="border border-neutral-200 rounded-lg p-5">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center shrink-0">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="10" cy="6" r="3" stroke="#22c55e" stroke-width="1.5" fill="none"/>
              <path d="M4 17c0-3.3 2.7-6 6-6s6 2.7 6 6" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round" fill="none"/>
              <line x1="3" y1="3" x2="17" y2="17" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-neutral-950">No Login Required</h3>
            <p class="text-xs text-neutral-500 mt-0.5">Core functionality is accessible without registration, sign-up, or any account.</p>
          </div>
        </div>
      </div>
      <div class="border border-neutral-200 rounded-lg p-5">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center shrink-0">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="10" cy="10" r="8" stroke="#22c55e" stroke-width="1.5" fill="none"/>
              <path d="M10 5v5.5l3.5 2" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-neutral-950">Continuously Monitored</h3>
            <p class="text-xs text-neutral-500 mt-0.5">Automated health checks run regularly to ensure the tool stays online and accessible.</p>
          </div>
        </div>
      </div>
      <div class="border border-neutral-200 rounded-lg p-5">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center shrink-0">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="10" cy="10" r="8" stroke="#22c55e" stroke-width="1.5" fill="none"/>
              <path d="M2.5 7.5h15M2.5 12.5h15" stroke="#22c55e" stroke-width="1" stroke-opacity="0.5"/>
              <ellipse cx="10" cy="10" rx="4" ry="8" stroke="#22c55e" stroke-width="1.5" fill="none"/>
            </svg>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-neutral-950">Web Archived</h3>
            <p class="text-xs text-neutral-500 mt-0.5">A snapshot is preserved on the Internet Archive for transparency and permanence.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-center gap-3 mb-10">
      <a
        href={tool.url}
        target="_blank"
        rel="noopener noreferrer"
        class="btn-primary"
      >
        Visit Tool
      </a>
      <a href={`/tool/${slug}`} class="btn-secondary">View Full Details</a>
    </div>

    <!-- What is NoLogin Verified -->
    <section class="mb-10">
      <h2 class="text-lg font-semibold text-neutral-950 mb-2">What is NoLogin Verified?</h2>
      <p class="text-sm text-neutral-500 leading-relaxed">
        The NoLogin Verified badge means this tool has been reviewed and confirmed by
        <a href="/" class="text-blue-600 hover:underline">nologin.tools</a>
        to provide its core functionality without requiring user registration or login.
        <a href="/badge" class="text-blue-600 hover:underline">Learn more</a>.
      </p>
    </section>

    <!-- Similar tools -->
    {similarTools.length > 0 && (
      <section>
        <h2 class="text-xs font-medium uppercase tracking-wide text-neutral-500 mb-3">
          Similar Tools
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          {similarTools.map((st) => (
            <a
              href={`/tool/${st.slug}`}
              class="border border-neutral-200 rounded-lg p-4 hover:shadow-md transition-all"
            >
              <h3 class="font-semibold text-neutral-950 text-sm mb-1">
                {st.name}
              </h3>
              {st.description && (
                <p class="text-xs text-neutral-500 line-clamp-2">
                  {st.description}
                </p>
              )}
            </a>
          ))}
        </div>
      </section>
    )}

    </div> <!-- end panel-verification -->

    <!-- Panel: Embed Code (hidden by default) -->
    <div id="panel-embed" role="tabpanel" aria-labelledby="tab-embed" class="hidden">

    <!-- Embed code -->
    <section class="mb-12">
      <h2 class="text-lg font-semibold text-neutral-950 mb-2">
        Add the Badge to Your Site
      </h2>
      <p class="text-sm text-neutral-500 mb-6">
        Display the NoLogin Verified badge to let users know your tool is
        verified. Tools with badges get higher visibility in the directory.
      </p>

      {isPending && (
        <div class="bg-amber-50 border border-amber-200 rounded-md p-4 mb-6">
          <p class="text-sm text-amber-800">
            Your tool is being reviewed. You can prepare the badge code now — it will activate once approved.
          </p>
        </div>
      )}

      <!-- Badge Style Selector -->
      <div class="mb-6">
        <h3 class="text-sm font-medium text-neutral-700 mb-3">
          Choose Badge Style
        </h3>
        {BADGE_GROUPS.map((group) => {
          const groupStyles = BADGE_STYLES.filter((s) => s.group === group.id);
          const isDark = group.id === 'dark';
          return groupStyles.length > 0 && (
            <div class="mb-4">
              <p class="text-xs text-neutral-500 mb-2 font-medium uppercase tracking-wide">{group.label}</p>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                {groupStyles.map((style) => (
                  <button
                    class:list={[
                      'badge-style-btn flex flex-col items-center justify-center gap-2 p-3 border rounded-lg transition-all cursor-pointer',
                      isDark ? 'bg-neutral-800' : '',
                      style.id === 'flat'
                        ? 'border-green-500 bg-green-50'
                        : 'border-neutral-200 hover:border-neutral-300',
                    ]}
                    data-style={style.id}
                    data-badge-path={style.path}
                    data-dark={isDark ? 'true' : undefined}
                  >
                    <img src={style.path} alt={style.label} title="Verified by nologin.tools" class="inline-block" />
                    <span class:list={['text-xs', isDark ? 'text-neutral-300' : 'text-neutral-600']}>{style.label}</span>
                  </button>
                ))}
              </div>
            </div>
          );
        })}
        <p class="text-xs text-neutral-400">
          Also available: <button class="badge-style-btn text-blue-600 hover:underline" data-style="original" data-badge-path={ORIGINAL_BADGE.path}>Original badge</button>
        </p>
      </div>

      <!-- SVG Badge -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-neutral-700">
            SVG Badge (Recommended)
          </h3>
          <button
            class="copy-btn text-xs text-blue-600 hover:underline"
            data-code="svg"
          >
            Copy
          </button>
        </div>
        <div class="mb-2">
          <img id="badge-preview" src="/badges/flat.svg" alt="NoLogin Verified" title="Verified by nologin.tools" class="inline-block" />
        </div>
        <pre
          id="code-svg"
          class="bg-neutral-900 text-neutral-100 p-4 rounded-md text-xs overflow-x-auto"
        ><code>{embedCode.svg}</code></pre>
      </div>

      <!-- Meta tag -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-neutral-700">Meta Tag</h3>
          <button
            class="copy-btn text-xs text-blue-600 hover:underline"
            data-code="meta"
          >
            Copy
          </button>
        </div>
        <pre
          id="code-meta"
          class="bg-neutral-900 text-neutral-100 p-4 rounded-md text-xs overflow-x-auto"
        ><code>{embedCode.meta}</code></pre>
      </div>

      <!-- Text link -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-neutral-700">Footer Link</h3>
          <button
            class="copy-btn text-xs text-blue-600 hover:underline"
            data-code="link"
          >
            Copy
          </button>
        </div>
        <pre
          id="code-link"
          class="bg-neutral-900 text-neutral-100 p-4 rounded-md text-xs overflow-x-auto"
        ><code>{embedCode.link}</code></pre>
      </div>
    </section>

    </div> <!-- end panel-embed -->

    <script id="embed-codes-data" type="application/json" set:html={JSON.stringify(allEmbedCodes)} />
  </div>

  <script>
    // Tab switching
    const tabs = {
      verification: {
        btn: document.getElementById('tab-verification')!,
        panel: document.getElementById('panel-verification')!,
      },
      embed: {
        btn: document.getElementById('tab-embed')!,
        panel: document.getElementById('panel-embed')!,
      },
    };

    function activateTab(name: 'verification' | 'embed') {
      for (const [key, { btn, panel }] of Object.entries(tabs)) {
        const isActive = key === name;
        panel.classList.toggle('hidden', !isActive);
        btn.setAttribute('aria-selected', String(isActive));
        btn.classList.toggle('border-green-500', isActive);
        btn.classList.toggle('text-green-600', isActive);
        btn.classList.toggle('border-transparent', !isActive);
        btn.classList.toggle('text-neutral-500', !isActive);
      }
    }

    // Initialize from hash
    if (window.location.hash === '#embed') {
      activateTab('embed');
    }

    // Tab click handlers
    tabs.verification.btn.addEventListener('click', () => {
      activateTab('verification');
      history.replaceState(null, '', window.location.pathname);
    });

    tabs.embed.btn.addEventListener('click', () => {
      activateTab('embed');
      history.replaceState(null, '', '#embed');
    });

    // Handle browser back/forward
    window.addEventListener('hashchange', () => {
      activateTab(window.location.hash === '#embed' ? 'embed' : 'verification');
    });

    // Badge style switching
    const embedCodes: Record<string, { svg: string }> = JSON.parse(
      document.getElementById('embed-codes-data')!.textContent!
    );
    const styleBtns = document.querySelectorAll('.badge-style-btn');
    const badgePreview = document.getElementById('badge-preview') as HTMLImageElement;
    const codeSvg = document.getElementById('code-svg');

    styleBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        const style = (btn as HTMLElement).dataset.style!;
        const badgePath = (btn as HTMLElement).dataset.badgePath!;

        // Update preview image
        badgePreview.src = badgePath;

        // Update SVG embed code
        if (codeSvg && embedCodes[style]) {
          codeSvg.innerHTML = `<code>${embedCodes[style].svg.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code>`;
        }

        // Update button styles
        styleBtns.forEach((b) => {
          const el = b as HTMLElement;
          const isDark = el.dataset.dark === 'true';
          if (el.dataset.style === style) {
            el.classList.add('border-green-500');
            el.classList.remove('border-neutral-200', 'hover:border-neutral-300');
            if (!isDark) el.classList.add('bg-green-50');
          } else {
            el.classList.remove('border-green-500');
            el.classList.add('border-neutral-200', 'hover:border-neutral-300');
            if (!isDark) el.classList.remove('bg-green-50');
          }
        });
      });
    });

    // Copy to clipboard
    document.querySelectorAll('.copy-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const codeId = `code-${(btn as HTMLElement).dataset.code}`;
        const codeEl = document.getElementById(codeId);
        if (codeEl) {
          navigator.clipboard.writeText(codeEl.textContent || '');
          btn.textContent = 'Copied!';
          setTimeout(() => {
            btn.textContent = 'Copy';
          }, 2000);
        }
      });
    });
  </script>
</Layout>
