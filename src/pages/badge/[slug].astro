---
import Layout from '../../layouts/Layout.astro';
import HealthBadge from '../../components/HealthBadge.astro';
import { getDb } from '../../db';
import { tools, tags, healthChecks, badgeDisplays } from '../../db/schema';
import { eq, desc, and, ne, inArray } from 'drizzle-orm';
import { formatDate } from '../../lib/utils';
import { getBadgeEmbedCode } from '../../lib/badge';
import { sortTagsCategoryFirst } from '../../lib/tags';

const { slug } = Astro.params;
const db = getDb(Astro.locals.runtime.env.DB);
const siteUrl = Astro.locals.runtime.env.SITE_URL || 'https://nologin.tools';

// Fetch tool
const [tool] = await db
  .select()
  .from(tools)
  .where(eq(tools.slug, slug!))
  .limit(1);

if (!tool || tool.status === 'rejected') {
  return Astro.redirect('/404');
}

const isPending = tool.status === 'pending';

// Fetch tags
const toolTags = await db
  .select({ tagKey: tags.tagKey, tagValue: tags.tagValue })
  .from(tags)
  .where(eq(tags.toolId, tool.id));

// Fetch latest health check
const [latestHealth] = await db
  .select()
  .from(healthChecks)
  .where(eq(healthChecks.toolId, tool.id))
  .orderBy(desc(healthChecks.checkedAt))
  .limit(1);

// Fetch similar tools (same tags, limit 3) — only for approved tools
const tagKeys = toolTags.map((t) => t.tagKey);
let similarTools: { slug: string; name: string; description: string | null }[] = [];
if (!isPending && tagKeys.length > 0) {
  similarTools = await db
    .selectDistinct({
      slug: tools.slug,
      name: tools.name,
      description: tools.description,
    })
    .from(tools)
    .innerJoin(tags, eq(tags.toolId, tools.id))
    .where(
      and(
        eq(tools.status, 'approved'),
        ne(tools.id, tool.id),
        inArray(tags.tagKey, tagKeys)
      )
    )
    .limit(3);
}

const embedCode = getBadgeEmbedCode(slug!, siteUrl);
---

<Layout
  title={`${tool.name} — ${isPending ? 'Pending Verification' : 'NoLogin Verified'}`}
  description={isPending ? `${tool.name} is pending verification.` : `${tool.name} is NoLogin Verified. ${tool.coreTask}`}
>
  <div class="max-w-3xl mx-auto px-6 py-16">
    <!-- Badge header -->
    <div class="text-center mb-10">
      <div class="mb-4">
        <img
          src="/badge.svg"
          alt="NoLogin Verified"
          class="inline-block w-40"
        />
      </div>
      <h1 class:list={['text-2xl font-bold mb-2', isPending ? 'text-amber-600' : 'text-green-600']}>
        {isPending ? 'This tool is pending verification' : 'This tool is NoLogin Verified'}
      </h1>
    </div>

    <!-- Tool info card -->
    <div class="border border-neutral-200 rounded-lg p-6 mb-8">
      <div class="flex items-start justify-between mb-4">
        <div>
          <h2 class="text-xl font-bold text-neutral-950">{tool.name}</h2>
          <a
            href={tool.url}
            target="_blank"
            rel="noopener noreferrer"
            class="text-sm text-blue-600 hover:underline"
          >
            {tool.url}
          </a>
        </div>
        {!isPending && (
          <HealthBadge
            isOnline={latestHealth?.isOnline ?? null}
            lastCheckedAt={latestHealth?.checkedAt ?? null}
          />
        )}
      </div>

      {tool.description && (
        <p class="text-neutral-600 mb-4">{tool.description}</p>
      )}

      <div class="bg-green-50 border border-green-200 rounded-md p-3 mb-4">
        <p class="text-sm text-green-800">
          <span class="font-medium">Core task (no login required):</span>{' '}
          "{tool.coreTask}"
        </p>
      </div>

      {!isPending && (
        <div class="flex flex-wrap gap-4 text-sm text-neutral-500">
          {tool.approvedAt && (
            <span>Verified since {formatDate(tool.approvedAt)}</span>
          )}
        </div>
      )}

      {toolTags.length > 0 && (
        <div class="flex flex-wrap gap-1.5 mt-4">
          {sortTagsCategoryFirst(toolTags).map((tag) => (
            <span class:list={['chip text-[11px]', tag.tagKey === 'category' ? 'chip-category' : 'chip-default']}>
              {tag.tagKey === 'category' ? tag.tagValue : `${tag.tagKey}:${tag.tagValue}`}
            </span>
          ))}
        </div>
      )}
    </div>

    <!-- Actions -->
    <div class="flex justify-center gap-3 mb-12">
      <a
        href={tool.url}
        target="_blank"
        rel="noopener noreferrer"
        class="btn-primary"
      >
        Visit Tool
      </a>
      <a href={`/tool/${slug}`} class="btn-secondary">View Full Details</a>
    </div>

    <!-- What is NoLogin Verified -->
    <section class="mb-12">
      <h2 class="text-lg font-semibold text-neutral-950 mb-3">
        What is NoLogin Verified?
      </h2>
      <p class="text-neutral-600 text-sm leading-relaxed">
        The NoLogin Verified badge means this tool has been reviewed and
        confirmed by{' '}
        <a href="/" class="text-blue-600 hover:underline">nologin.tools</a>{' '}
        to provide its core functionality without requiring user registration or
        login. We continuously monitor the availability of verified tools.{' '}
        <a href="/badge" class="text-blue-600 hover:underline">Learn more</a>.
      </p>
    </section>

    <!-- Embed code -->
    <section class="mb-12">
      <h2 class="text-lg font-semibold text-neutral-950 mb-2">
        Add the Badge to Your Site
      </h2>
      <p class="text-sm text-neutral-500 mb-6">
        Display the NoLogin Verified badge to let users know your tool is
        verified. Tools with badges get higher visibility in the directory.
      </p>

      {isPending && (
        <div class="bg-amber-50 border border-amber-200 rounded-md p-4 mb-6">
          <p class="text-sm text-amber-800">
            Your tool is being reviewed. You can prepare the badge code now — it will activate once approved.
          </p>
        </div>
      )}

      <!-- SVG Badge -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-neutral-700">
            SVG Badge (Recommended)
          </h3>
          <button
            class="copy-btn text-xs text-blue-600 hover:underline"
            data-code="svg"
          >
            Copy
          </button>
        </div>
        <div class="mb-2">
          <img src="/badge.svg" alt="NoLogin Verified" class="inline-block" />
        </div>
        <pre
          id="code-svg"
          class="bg-neutral-900 text-neutral-100 p-4 rounded-md text-xs overflow-x-auto"
        ><code>{embedCode.svg}</code></pre>
      </div>

      <!-- Meta tag -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-neutral-700">Meta Tag</h3>
          <button
            class="copy-btn text-xs text-blue-600 hover:underline"
            data-code="meta"
          >
            Copy
          </button>
        </div>
        <pre
          id="code-meta"
          class="bg-neutral-900 text-neutral-100 p-4 rounded-md text-xs overflow-x-auto"
        ><code>{embedCode.meta}</code></pre>
      </div>

      <!-- Text link -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-neutral-700">Footer Link</h3>
          <button
            class="copy-btn text-xs text-blue-600 hover:underline"
            data-code="link"
          >
            Copy
          </button>
        </div>
        <pre
          id="code-link"
          class="bg-neutral-900 text-neutral-100 p-4 rounded-md text-xs overflow-x-auto"
        ><code>{embedCode.link}</code></pre>
      </div>
    </section>

    <!-- Similar tools -->
    {similarTools.length > 0 && (
      <section>
        <h2 class="text-lg font-semibold text-neutral-950 mb-3">
          Similar Tools
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          {similarTools.map((st) => (
            <a
              href={`/tool/${st.slug}`}
              class="border border-neutral-200 rounded-lg p-4 hover:shadow-md transition-all"
            >
              <h3 class="font-semibold text-neutral-950 text-sm mb-1">
                {st.name}
              </h3>
              {st.description && (
                <p class="text-xs text-neutral-500 line-clamp-2">
                  {st.description}
                </p>
              )}
            </a>
          ))}
        </div>
      </section>
    )}
  </div>

  <script>
    document.querySelectorAll('.copy-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const codeId = `code-${(btn as HTMLElement).dataset.code}`;
        const codeEl = document.getElementById(codeId);
        if (codeEl) {
          navigator.clipboard.writeText(codeEl.textContent || '');
          btn.textContent = 'Copied!';
          setTimeout(() => {
            btn.textContent = 'Copy';
          }, 2000);
        }
      });
    });
  </script>
</Layout>
