---
import Layout from '../../layouts/Layout.astro';
import HealthBadge from '../../components/HealthBadge.astro';
import TagPicker from '../../components/TagPicker.astro';
import { getDb } from '../../db';
import { tools, tags, healthChecks } from '../../db/schema';
import { eq, desc, sql } from 'drizzle-orm';
import { formatDate, timeAgo } from '../../lib/utils';
import { sortTagsCategoryFirst, TAG_DEFINITIONS } from '../../lib/tags';
import { HEALTH_TOLERANCE, resolveEffectiveStatus, type EffectiveStatus } from '../../lib/health';

const { slug } = Astro.params;
const db = getDb(Astro.locals.runtime.env.DB);

// Fetch tool
const [tool] = await db
  .select()
  .from(tools)
  .where(eq(tools.slug, slug!))
  .limit(1);

if (!tool) {
  return Astro.redirect('/404');
}

// Fetch tags
const toolTags = await db
  .select({ tagKey: tags.tagKey, tagValue: tags.tagValue })
  .from(tags)
  .where(eq(tags.toolId, tool.id));

// Fetch recent health checks for tolerance
const recentChecks = await db
  .select({
    isOnline: healthChecks.isOnline,
    httpStatus: healthChecks.httpStatus,
    responseTimeMs: healthChecks.responseTimeMs,
    checkedAt: healthChecks.checkedAt,
  })
  .from(healthChecks)
  .where(eq(healthChecks.toolId, tool.id))
  .orderBy(desc(healthChecks.checkedAt))
  .limit(HEALTH_TOLERANCE);
const latestHealth = recentChecks[0] ?? null;

// Fetch health history (last 14 days)
const fourteenDaysAgo = new Date(Date.now() - 14 * 86400000);
const healthHistory = await db
  .select({
    checkedAt: healthChecks.checkedAt,
    isOnline: healthChecks.isOnline,
  })
  .from(healthChecks)
  .where(
    sql`${healthChecks.toolId} = ${tool.id} AND ${healthChecks.checkedAt} > ${Math.floor(fourteenDaysAgo.getTime() / 1000)}`
  )
  .orderBy(desc(healthChecks.checkedAt));

// Group health by day — aggregate all checks per day into three-level status
const healthByDay = new Map<string, EffectiveStatus>();
const checksPerDay = new Map<string, boolean[]>();
for (const check of healthHistory) {
  const day = check.checkedAt.toISOString().split('T')[0];
  if (!checksPerDay.has(day)) checksPerDay.set(day, []);
  checksPerDay.get(day)!.push(check.isOnline);
}
for (const [day, results] of checksPerDay) {
  const onlineCount = results.filter(Boolean).length;
  if (onlineCount === results.length) healthByDay.set(day, 'online');
  else if (onlineCount === 0) healthByDay.set(day, 'offline');
  else healthByDay.set(day, 'unstable');
}

// Generate last 14 days for timeline
const days: { date: string; label: string; status: EffectiveStatus | null }[] = [];
for (let i = 13; i >= 0; i--) {
  const d = new Date(Date.now() - i * 86400000);
  const key = d.toISOString().split('T')[0];
  days.push({
    date: key,
    label: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
    status: healthByDay.get(key) ?? null,
  });
}

const isVerified = tool.status === 'approved';
const isPending = tool.status === 'pending';
const isRejected = tool.status === 'rejected';
const effectiveStatus = resolveEffectiveStatus(recentChecks);
const isOffline = effectiveStatus === 'offline';

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'SoftwareApplication',
  name: tool.name,
  url: tool.url,
  description: tool.description || '',
  applicationCategory: 'WebApplication',
};
---

<Layout
  title={tool.name}
  description={tool.description || `${tool.name} — a tool that works without login.`}
  ogType="article"
>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  {/* Background Elements */}
  <div class="absolute top-0 inset-x-0 h-[32rem] pointer-events-none -z-10 overflow-hidden">
    <div class="absolute -top-24 -left-24 w-96 h-96 bg-green-100/20 blur-3xl rounded-full"></div>
    <div class="absolute top-48 -right-48 w-80 h-80 bg-blue-100/10 blur-3xl rounded-full"></div>
  </div>

  <div class="max-w-4xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
    <!-- Back link -->
    <a
      href="/"
      class="group inline-flex items-center gap-2 text-sm font-bold text-neutral-400 hover:text-neutral-900 mb-8 sm:mb-10 transition-colors"
    >
      <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-white border border-neutral-200 flex items-center justify-center group-hover:border-neutral-300 group-hover:shadow-sm transition-all">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
      </div>
      Back to Directory
    </a>

    <!-- Status banners -->
    {isPending && (
      <div class="glass-card border-amber-200/50 bg-amber-50/30 rounded-2xl sm:rounded-3xl p-5 sm:p-6 mb-8 sm:mb-10 flex gap-3 sm:gap-4">
        <div class="w-10 h-10 sm:w-12 sm:h-12 shrink-0 rounded-xl sm:rounded-2xl bg-amber-100 flex items-center justify-center text-amber-600">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        </div>
        <div>
          <p class="text-amber-900 font-bold mb-1 text-sm sm:text-base">Pending Review</p>
          <p class="text-xs sm:text-sm text-amber-800/70 leading-relaxed">
            This tool is currently being reviewed. It will appear in the public directory once approved.
          </p>
        </div>
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 sm:gap-10">
      <div class="lg:col-span-2 space-y-8 sm:space-y-10">
        <!-- Main Info -->
        <div class="glass-card rounded-[2rem] sm:rounded-[2.5rem] p-6 sm:p-10">
          <div class="flex flex-col sm:flex-row gap-6 sm:gap-8 items-center sm:items-start mb-8 text-center sm:text-left">
            <div class="w-20 h-20 sm:w-24 sm:h-24 rounded-2xl sm:rounded-[2rem] bg-white border border-neutral-100 shadow-xl shadow-neutral-100 flex items-center justify-center overflow-hidden shrink-0">
              <img
                src={`https://www.google.com/s2/favicons?domain=${new URL(tool.url).hostname}&sz=128`}
                alt=""
                width="64"
                height="64"
                class="w-12 h-12 sm:w-16 sm:h-16 object-contain"
                onerror={`this.style.display='none';this.nextElementSibling.style.display='flex'`}
              />
              <span class="w-full h-full bg-gradient-to-br from-neutral-50 to-neutral-100 text-neutral-400 text-2xl sm:text-3xl font-black items-center justify-center hidden">
                {tool.name.charAt(0).toUpperCase()}
              </span>
            </div>
            
            <div class="min-w-0 flex-1">
              <div class="flex flex-wrap items-center justify-center sm:justify-start gap-2 sm:gap-3 mb-2">
                <h1 class="text-3xl sm:text-4xl font-black tracking-tight text-neutral-900">{tool.name}</h1>
                {tool.isFeatured && (
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[9px] font-black uppercase tracking-widest bg-yellow-100 text-yellow-700 border border-yellow-200/50 shadow-sm">
                    Featured
                  </span>
                )}
              </div>
              
              <div class="flex flex-wrap items-center justify-center sm:justify-start gap-3 sm:gap-4 text-xs sm:text-sm font-medium text-neutral-400 mb-6">
                <div class="flex items-center gap-1.5">
                  <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                  {new URL(tool.url).hostname}
                </div>
                {isVerified && tool.approvedAt && (
                  <div class="flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    {formatDate(tool.approvedAt)}
                  </div>
                )}
                <div class="flex items-center gap-2">
                   <HealthBadge status={effectiveStatus} lastCheckedAt={latestHealth?.checkedAt ?? null} />
                </div>
              </div>

              <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                {isOffline ? (
                  <>
                    <button class="btn-secondary w-full sm:w-auto opacity-50 cursor-not-allowed" disabled>Tool Offline</button>
                    {tool.archiveUrl && (
                      <a href={tool.archiveUrl} target="_blank" rel="noopener noreferrer" class="btn-secondary w-full sm:w-auto justify-center">
                        View Archive
                      </a>
                    )}
                  </>
                ) : (
                  <a href={tool.url} target="_blank" rel="noopener noreferrer" class="btn-primary w-full sm:w-auto justify-center">
                    Open Tool
                    <svg class="ml-2 w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.22 14.78a.75.75 0 010-1.06l7.22-7.22H5.75a.75.75 0 010-1.5h8.5a.75.75 0 01.75.75v8.5a.75.75 0 01-1.5 0V6.56l-7.22 7.22a.75.75 0 01-1.06 0z" clip-rule="evenodd" />
                    </svg>
                  </a>
                )}
                {isVerified && (
                  <button id="suggest-edit-btn" class="btn-secondary w-full sm:w-auto justify-center">
                    Suggest Edit
                  </button>
                )}
              </div>
            </div>
          </div>

          <div class="space-y-6 sm:space-y-8 pt-8 border-t border-neutral-100 text-left">
            <div>
              <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-400 mb-3">Description</h2>
              <p class="text-neutral-700 text-base sm:text-lg leading-relaxed">{tool.description}</p>
            </div>

            <div class="p-5 sm:p-6 bg-green-50/50 rounded-2xl border border-green-100/50">
              <h2 class="text-[9px] font-black uppercase tracking-[0.2em] text-green-700/60 mb-2">No-Login Task</h2>
              <p class="text-green-900 font-bold text-base sm:text-lg leading-snug italic">
                "{tool.coreTask}"
              </p>
            </div>
            
            {toolTags.length > 0 && (
              <div>
                <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-400 mb-3">Tags</h2>
                <div class="flex flex-wrap gap-2">
                  {sortTagsCategoryFirst(toolTags).map((tag) => (
                    <a
                      href={`/?${tag.tagKey}=${encodeURIComponent(tag.tagValue)}`}
                      class:list={['chip px-3 py-1 sm:px-4 sm:py-1.5 font-bold text-[10px] sm:text-xs', tag.tagKey === 'category' ? 'chip-category' : 'chip-default']}
                    >
                      {tag.tagKey === 'category' ? tag.tagValue : tag.tagValue}
                    </a>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Resubmit form if rejected */}
        {isRejected && (
          <div class="glass-card rounded-[2.5rem] p-8 sm:p-10 border-red-100">
            <h3 class="text-2xl font-black text-neutral-900 mb-6">Resubmit Tool</h3>
            <form id="resubmit-form" class="space-y-6" novalidate>
              <input type="hidden" name="toolId" value={tool.id} />

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label for="rs-name" class="block text-xs font-black uppercase tracking-widest text-neutral-400 mb-2">
                    Tool Name <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="rs-name"
                    name="name"
                    required
                    value={tool.name}
                    class="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                  />
                  <p class="text-xs text-red-500 mt-1 hidden" data-rs-error="name"></p>
                </div>

                <div>
                  <label for="rs-url" class="block text-xs font-black uppercase tracking-widest text-neutral-400 mb-2">
                    Tool URL <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="url"
                    id="rs-url"
                    name="url"
                    required
                    value={tool.url}
                    class="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                  />
                  <p class="text-xs text-red-500 mt-1 hidden" data-rs-error="url"></p>
                </div>
              </div>

              <div>
                <label for="rs-description" class="block text-xs font-black uppercase tracking-widest text-neutral-400 mb-2">
                  Description <span class="text-red-500">*</span>
                </label>
                <textarea
                  id="rs-description"
                  name="description"
                  required
                  rows="4"
                  class="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"
                >{tool.description}</textarea>
                <p class="text-xs text-red-500 mt-1 hidden" data-rs-error="description"></p>
              </div>

              <div>
                <label for="rs-coreTask" class="block text-xs font-black uppercase tracking-widest text-neutral-400 mb-2">
                  What can you do without login? <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="rs-coreTask"
                  name="coreTask"
                  required
                  value={tool.coreTask}
                  class="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                />
                <p class="text-xs text-red-500 mt-1 hidden" data-rs-error="coreTask"></p>
              </div>

              <div>
                <label class="flex items-start gap-4 p-4 bg-green-50/50 border border-green-100 rounded-2xl cursor-pointer hover:bg-green-50 transition-colors">
                  <input
                    type="checkbox"
                    id="rs-pledge"
                    name="pledge"
                    required
                    checked
                    class="mt-1 w-5 h-5 text-green-600 border-neutral-300 rounded-lg focus:ring-green-500"
                  />
                  <span class="text-sm text-green-900 font-medium">
                    I confirm this tool's core functionality works without creating an
                    account or logging in. <span class="text-red-500 font-black">*</span>
                  </span>
                </label>
                <p class="text-xs text-red-500 mt-1 hidden" data-rs-error="pledge"></p>
              </div>

              <div>
                <label for="rs-submitterEmail" class="block text-xs font-black uppercase tracking-widest text-neutral-400 mb-2">
                  Email <span class="text-neutral-300 font-bold">(optional)</span>
                </label>
                <input
                  type="email"
                  id="rs-submitterEmail"
                  name="submitterEmail"
                  value={tool.submitterEmail || ''}
                  class="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                />
                <p class="text-xs text-neutral-400 mt-2 italic font-medium">
                  Only visible to reviewers.
                </p>
                <p class="text-xs text-red-500 mt-1 hidden" data-rs-error="submitterEmail"></p>
              </div>

              <div class="pt-4">
                <h4 class="text-xs font-black uppercase tracking-widest text-neutral-400 mb-4">Update Tags</h4>
                <TagPicker selectedTags={toolTags.map(t => ({ key: t.tagKey, value: t.tagValue }))} />
              </div>

              <div id="resubmit-error" class="hidden p-4 bg-red-50 border border-red-200 rounded-2xl text-sm text-red-700 font-bold"></div>

              <button
                type="submit"
                id="resubmit-btn"
                class="btn-primary w-full justify-center py-4 rounded-2xl text-base"
              >
                Resubmit Tool
              </button>
            </form>
          </div>
        )}
      </div>

      <div class="space-y-6 sm:space-y-8">
        <!-- Sidebar: Health Stats -->
        <div class="glass-card rounded-[2rem] p-6 sm:p-8">
          <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-neutral-400 mb-6 flex items-center gap-2">
             <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
             Health History
          </h2>
          
          <div class="flex flex-wrap items-center gap-1.5 sm:gap-2 mb-6">
            {days.map((day) => (
              <div
                class:list={[
                  'w-[calc(14.28%-0.4rem)] sm:w-[calc(14.28%-0.5rem)] h-7 sm:h-8 rounded-md sm:rounded-lg transition-all duration-300',
                  day.status === null
                    ? 'bg-neutral-100'
                    : day.status === 'online'
                      ? 'bg-green-100 hover:bg-green-200 border border-green-200/50'
                      : day.status === 'unstable'
                        ? 'bg-amber-100 hover:bg-amber-200 border border-amber-200/50'
                        : 'bg-red-100 hover:bg-red-200 border border-red-200/50',
                ]}
                title={`${day.label}: ${day.status === null ? 'No data' : day.status === 'online' ? 'Online' : day.status === 'unstable' ? 'Unstable' : 'Offline'}`}
              >
              </div>
            ))}
          </div>
          
          <div class="flex items-center justify-between text-[9px] font-black uppercase tracking-widest text-neutral-300 px-1">
            <span>14 days ago</span>
            <span>Today</span>
          </div>
          
          <div class="mt-8 pt-6 border-t border-neutral-100 space-y-4">
             <div class="flex items-center justify-between">
                <span class="text-[10px] font-bold text-neutral-400 uppercase tracking-tight">Total Uptime</span>
                <span class="text-xs font-black text-green-600">
                  {Math.round((days.filter(d => d.status === 'online').length / days.filter(d => d.status !== null).length || 0) * 100)}%
                </span>
             </div>
             <div class="flex items-center justify-between">
                <span class="text-[10px] font-bold text-neutral-400 uppercase tracking-tight">Reliability</span>
                <span class="text-xs font-black text-neutral-600">High</span>
             </div>
          </div>
        </div>

        {/* Sidebar: Badge Preview */}
        {isVerified && (
          <div class="glass-card rounded-[2rem] p-6 sm:p-8 bg-gradient-to-br from-green-50/50 to-white border-green-100/50 group/badge text-center">
            <h2 class="text-[10px] font-black uppercase tracking-[0.2em] text-green-700/60 mb-6 text-left">Verified Badge</h2>
            <div class="flex justify-center mb-6">
              <img 
                src="/badges/for-the-badge.svg" 
                alt="NoLogin Verified" 
                class="h-8 sm:h-10 w-auto object-contain transition-transform duration-500 group-hover/badge:scale-110" 
              />
            </div>
            <p class="text-[11px] sm:text-xs text-neutral-500 leading-relaxed mb-6 font-medium">
              Show users you respect their privacy with our verified badge.
            </p>
            <a href={`/badge/${slug}#embed`} class="btn-secondary w-full justify-center py-2.5 rounded-xl text-[10px] sm:text-xs font-bold bg-white shadow-sm">
              Get Badge Code
            </a>
          </div>
        )}
      </div>
    </div>
  </div>

  {/* Edit Suggestion Modal Backdrop (Custom UI) */}
  <div id="edit-form" class="hidden fixed inset-0 z-[60] flex items-center justify-center px-6">
    <div class="absolute inset-0 bg-neutral-900/40 backdrop-blur-sm"></div>
    <div class="relative glass-card w-full max-w-xl rounded-[2.5rem] p-8 sm:p-10 shadow-2xl">
      <h3 class="text-2xl font-black text-neutral-900 mb-6">Suggest an Edit</h3>
      <form id="edit-suggestion-form" class="space-y-6">
        <input type="hidden" name="toolId" value={tool.id} />
        <div>
          <label for="edit-field" class="block text-xs font-black uppercase tracking-widest text-neutral-400 mb-2">
            Field to edit
          </label>
          <select
            id="edit-field"
            name="fieldName"
            class="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-sm font-bold focus:outline-none focus:ring-2 focus:ring-green-500 appearance-none"
          >
            <option value="name">Name</option>
            <option value="description">Description</option>
            <option value="coreTask">Core Task</option>
            <option value="url">URL</option>
            <option value="tags">Tags</option>
          </select>
        </div>
        <div id="edit-value-wrap">
          <label for="edit-value" class="block text-xs font-black uppercase tracking-widest text-neutral-400 mb-2">
            New value
          </label>
          <input
            type="text"
            id="edit-value"
            name="newValue"
            class="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
          />
        </div>
        <div id="edit-tags-wrap" class="hidden">
          <label class="block text-xs font-black uppercase tracking-widest text-neutral-400 mb-2">
            New tags
          </label>
          <TagPicker selectedTags={toolTags.map(t => ({ key: t.tagKey, value: t.tagValue }))} />
        </div>
        <div>
          <label for="edit-reason" class="block text-xs font-black uppercase tracking-widest text-neutral-400 mb-2">
            Reason <span class="text-neutral-300 font-bold">(optional)</span>
          </label>
          <textarea
            id="edit-reason"
            name="reason"
            rows="3"
            placeholder="Why should this be changed?"
            class="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"
          ></textarea>
        </div>
        <div id="edit-msg" class="hidden p-4 rounded-xl text-sm font-bold"></div>
        <div class="flex flex-col sm:flex-row gap-3 pt-2">
          <button type="submit" class="btn-primary flex-1 justify-center py-4 rounded-2xl">Submit Suggestion</button>
          <button type="button" id="cancel-edit" class="btn-secondary flex-1 justify-center py-4 rounded-2xl">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const editBtn = document.getElementById('suggest-edit-btn');
    const editForm = document.getElementById('edit-form');
    const cancelBtn = document.getElementById('cancel-edit');
    const editSuggestionForm = document.getElementById('edit-suggestion-form') as HTMLFormElement | null;
    const editMsg = document.getElementById('edit-msg');

    const editFieldSelect = document.getElementById('edit-field') as HTMLSelectElement | null;
    const editValueWrap = document.getElementById('edit-value-wrap');
    const editTagsWrap = document.getElementById('edit-tags-wrap');

    editFieldSelect?.addEventListener('change', () => {
      const isTags = editFieldSelect.value === 'tags';
      editValueWrap?.classList.toggle('hidden', isTags);
      editTagsWrap?.classList.toggle('hidden', !isTags);
    });

    editBtn?.addEventListener('click', () => {
      editForm?.classList.toggle('hidden');
    });

    cancelBtn?.addEventListener('click', () => {
      editForm?.classList.add('hidden');
    });

    editSuggestionForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(editSuggestionForm);
      const fieldName = formData.get('fieldName') as string;

      let newValue: string;
      if (fieldName === 'tags') {
        // Collect tags from TagPicker inside the edit form
        const tagEntries: { key: string; value: string }[] = [];
        for (const [key, value] of formData.entries()) {
          if (key.startsWith('tag_')) {
            const tagKey = key.replace('tag_', '').replace('[]', '');
            tagEntries.push({ key: tagKey, value: value as string });
          }
        }
        newValue = JSON.stringify(tagEntries);
      } else {
        newValue = formData.get('newValue') as string;
      }

      try {
        const res = await fetch('/api/edit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            toolId: Number(formData.get('toolId')),
            fieldName,
            newValue,
            reason: formData.get('reason') || undefined,
          }),
        });

        const result = await res.json();
        if (editMsg) {
          if (result.ok) {
            editMsg.textContent = 'Edit suggestion submitted! It will be reviewed.';
            editMsg.className = 'text-sm text-green-600';
            editMsg.classList.remove('hidden');
            editSuggestionForm.reset();
          } else {
            editMsg.textContent = result.error || 'Failed to submit edit.';
            editMsg.className = 'text-sm text-red-500';
            editMsg.classList.remove('hidden');
          }
        }
      } catch {
        if (editMsg) {
          editMsg.textContent = 'Network error. Please try again.';
          editMsg.className = 'text-sm text-red-500';
          editMsg.classList.remove('hidden');
        }
      }
    });

    // Resubmit form
    const resubmitForm = document.getElementById('resubmit-form') as HTMLFormElement | null;
    const resubmitBtn = document.getElementById('resubmit-btn') as HTMLButtonElement | null;
    const resubmitError = document.getElementById('resubmit-error');

    resubmitForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear errors
      document.querySelectorAll('[data-rs-error]').forEach((el) => el.classList.add('hidden'));
      resubmitError?.classList.add('hidden');

      const formData = new FormData(resubmitForm);
      const data: Record<string, any> = {
        toolId: Number(formData.get('toolId')),
        name: formData.get('name'),
        url: formData.get('url'),
        description: formData.get('description'),
        pledge: formData.get('pledge') === 'on',
        coreTask: formData.get('coreTask'),
        submitterEmail: formData.get('submitterEmail') || '',
        tags: [] as { key: string; value: string }[],
      };

      // Collect tags
      for (const [key, value] of formData.entries()) {
        if (key.startsWith('tag_')) {
          const tagKey = key.replace('tag_', '').replace('[]', '');
          data.tags.push({ key: tagKey, value: value as string });
        }
      }

      if (resubmitBtn) {
        resubmitBtn.disabled = true;
        resubmitBtn.textContent = 'Resubmitting...';
      }

      try {
        const res = await fetch('/api/resubmit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await res.json();

        if (result.ok) {
          window.location.href = `/tool/${result.data.slug}`;
        } else {
          if (result.details) {
            for (const [field, msg] of Object.entries(result.details)) {
              const el = document.querySelector(`[data-rs-error="${field}"]`);
              if (el) {
                el.textContent = msg as string;
                el.classList.remove('hidden');
              }
            }
          }
          if (resubmitError) {
            resubmitError.textContent = result.error || 'Resubmission failed.';
            resubmitError.classList.remove('hidden');
          }
        }
      } catch {
        if (resubmitError) {
          resubmitError.textContent = 'Network error. Please try again.';
          resubmitError.classList.remove('hidden');
        }
      } finally {
        if (resubmitBtn) {
          resubmitBtn.disabled = false;
          resubmitBtn.textContent = 'Resubmit Tool';
        }
      }
    });
  </script>
</Layout>
